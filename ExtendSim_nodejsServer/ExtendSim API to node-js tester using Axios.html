<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>ExtendSim ASP API tester</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.rawgit.com/eligrey/FileSaver.js/5ed507ef8aa53d8ecfea96d96bc7214cd2476fd2/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/4.3.0/dropzone.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/4.3.0/dropzone.css" />
<style>
    table, th, td {
      border: 1px solid black;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 5px;
      text-align: left;    
    }
    progress {
        -webkit-appearance: none;
    }

    ::-webkit-progress-bar {
        background-color: rgb(255, 251, 243);
    }
    .login {
        margin-left: 5px;
        margin-right: 20px;
        flex: 1;
        max-width: 400px;
    }
    .input-file-row {
        width: auto;
    }
    .table-row {
        width: auto;
    }
    .database-input-row {
        width: auto;
    }
    .upload-files-button {
        margin-top: 10px;
        margin-right: 10px;
        
    }
    .upload-database-inputs-button {
        margin-top: 10px;
        margin-right: 10px;
    }
    .upload-dialog-inputs-button, .download-dialog-outputs-button {
        margin-top: 10px;
        margin-right: 10px;
    }
    /* The Modal (background) */
    .modal {
        font-family: Arial, Helvetica, sans-serif;
        font-size: 12px;
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        padding-top: 80px; /* Location of the box */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        background-color: rgb(0,0,0); /* Fallback color */
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
    }
    /* Modal Content */
    .modal-content {
        background-color: #fefefe;
        margin: auto;
        overflow: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        height: 60%;
        align-content: center;
    }
    div#load_screen {
        background: black;
        opacity: .8;
        position: fixed;
        top: 0px;
        width: 100%;
        height: 100%;
        z-index: 20;
    }
    div#load_screen > #loading {
        font-family: Arial, Helvetica, sans-serif;
        font-size: 30px;
        text-align: center;
        font-weight: bold;
        color: #FFFFFF;
        width: 50%;
        height: 20px;
        margin: 300px auto;
    }
    .scenario-buttons, #remove-selected-scenario-folders-button {
        margin: auto;
        text-align: center;
    }
    .table-checkboxes {
        text-align: center;
    }
    .input-label {
        margin-left: 5px;
        text-align: center;
        width: auto;
    }
    .text-area {
        width: 50%;
        text-align: center;
    }
    .percentage-value {
        text-align: center;
    }
    .progress-bar {
        /* position: absolute;
        left: 0;
        top: 0;
        bottom: 0; */
        background-color: rgb(255, 0, 0);
        /* z-index: -1; */
    }
    .dropzone {
        border: 2px dashed rgb(163, 164, 165);
        background: white;
        border-radius: 5px;
        min-height: 150px;
        padding: 10px 0;
        vertical-align: baseline;
        color: rgb(128, 128, 128);
        font-size: 16px;
        font-family: Arial, Helvetica, sans-serif;
    }
    #chart-type-select-label, #modal-x-axis-field-select-label, #modal-y-axis-field-select-label {
        font-weight: bold;
    }
    #modal-chart-container {
        height: 100%;
    }
    /* #modal-form-chart {
        height: 70%;
    } */
    #modal-x-axis-field-select, #modal-y-axis-field-select  {
        margin-right: 10px;
    }
        
    #login-section, #remove-selected-button {
        text-align: left;
        margin: auto;
    }
    #remove-selected-button {
        text-align: center;
        margin: auto;
    }
    #save-scenario-definition {
        margin: 0px 20px 20px 20px;
    }
    #selected-response-table-name {
        margin-right: 20px;
    }
    #selected-response-table-name-label {
        font-size: 18px;
        font-family: Arial, Helvetica, sans-serif;
        font-weight: bold;
    }
    .section-header-checkboxes {
        text-align: center;
        font-weight: bold;
        font-size: 26px;
        margin-bottom: 15px;
    }
    .sub-section-header-checkboxes {
        text-align: center;
        font-weight: bold;
        font-size: 23px;
        margin-bottom: 15px;
    }
    .modal-form {
        padding: 10px;
        /* margin: 0px auto 10px; */
        margin: 10px auto;
        width: auto;
        max-width: 600px;
        z-index: 100;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 14px;
        border-width: 2px;
        border-style: solid;
        border-radius: 10px;
        border-color: blue,;
        background-color: #dbe3ff;
        text-align: center;
    }
    .modal-buttons {
        margin: 0px 1px 0px 1px;   
    }
    #modal-chart-axes-selection-dropdowns {
        /* padding: 20px; */
        margin: 1%;
        background-color: rgb(216, 216, 216);
        border-width: 1px;
        border-style: solid;
        border-radius: 10px;
        border-color: rgb(0, 0, 0);
    }
    #scenarios-table-container {
        text-align: center;
        margin: auto;
    }
    #create-scenario-folder-button {
        visibility: visible;
        margin-left: 20px;
    }

    #selected-database-outputs-table th, #selected-file-contents-table  th {
        background-color: rgb(251, 119, 119);
        color: white;
        position: sticky; top: -20px;
        text-align: center;
    }
    #selected-database-outputs-table td, #selected-file-contents-table td {
        background-color: rgb(255, 255, 255);
        color: black;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 14px;
        text-align: center;
        font-weight: normal;
    }
    #database-outputs-table th, #dialog-outputs-table th, #file-outputs-table th {
        background-color: #4CAF50;
        color: white;
        text-align: center;
    }
    #scenarios-table th {
        background-color: rgb(73, 70, 248);
        color: white;
        text-align: center;    
    }
    #scenarios-table td {
        font-size: 12px;
        font-weight: normal;
        background-color: #ecedf0;
    }
    #scenarios-table tr:hover {
        background-color:gray;
        cursor:pointer;
    }
    #scenarios-table {
        margin-bottom: 20px;
        margin-right: 2%;
        display: inline-table; 
        
    }
    .scroll-container {
        scroll-padding: 50px 50px 50px 50px;
    }

    .close {
        color: #aaaaaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close:hover,
    .close:focus {
        color: #000;
        text-decoration: none;
        cursor: pointer;
    }

    .flex-container {
        display: flex;
        margin-bottom: 5px;
    }
    .fill-width {
        flex: 1;
    }
    .scenario-tables {
        margin: 10px auto;
    }
    #extendsim-asp-title-heading {
        font-size: 28px;
        font-weight: bold;
        text-align: center;
        margin: 20px;
        color: rgb(0, 0, 172);
    }
    #user-login-title-heading {
        font-size: 20px;
        font-weight: bold;
        text-align: center;
        margin-bottom: 20px;
    }
    #scenario-factors-title-heading, #scenario-responses-title-heading {
        font-size: 20px;
        font-weight: bold;
        text-align: center;
    }
    #submit-scenario-title-heading {
        font-size: 20px;
        font-weight: bold;
        text-align: center;
        margin-bottom: 20px;
    }    
    #extendsim-asp-header {
        background-image:url(https://extendsim.com/templates/extendsim/images/ES_logo.gif);
        background-repeat:no-repeat;
        width: 100%;
        margin-top: -30px;
        margin-left: -10px;
        height: 100px;
        position: fixed;
        background-color: whitesmoke;
        z-index: 10;
    }
    #page-container {
        margin: 0 auto;
        text-align: center;
    }
    #extendsim-asp-axios-tester-frame {
        margin-top: 80px;
        width: 90%;
        min-width: 605px;
        padding: 10px;
        padding: 2%;
        border-color: blue,;
        border-width: 2px;
        border-style: solid;
        border-radius: 10px;
        background-color: #c9d6ff;
        font-size: 14px;
        font-family: Arial, Helvetica, sans-serif;
        font-weight: bold;
        display: inline-block;    
    }
    #file-inputs-table, #database-inputs-table, #dialog-inputs-table {
        background-color: #ecedf0;
    }
    #file-inputs-table th, #database-inputs-table th, #dialog-inputs-table th {
        background-color: rgb(251, 140, 76);
        color: white;
        text-align: center;
    }
    #setup-scenario-name {
        margin-top: 5px;
    }
    #scenario-name {
        width: 60%;
    }
    #username, #password {
        width: 40%;
    }
    #user-login-session-id {
        width: 50%;
    }
    #ip-address {
        max-width: 100px;
    }
    #user-login-session-id-label {
        margin-left: 20px;
    }
    #user-scenario-folder-pathname {
        width: 600px;
    }
    #user-models-label {
        margin-left: 20px;
    }
    #model-copied-status-label {
        margin-left: 20px;
    }
    #upload-filename-label {
        margin-left: 20px;
    }
    #user-scenario-folder-pathname {
        margin-right: 20px;
        resize: horizontal;
        max-width: 700px;
    }
    #scenario-model-label {
        margin-right: 10px;
        font-weight: bold;
    }
    #scenario-id {
        margin-right: 20px;
    }
    #scenario-status-label {
        margin-left: 20px;
    }
    #submit-scenarios {
        text-align: center;
        margin-top: 0px;
        margin-bottom: 20px;
    }
    #scenario-factors-body, #scenario-responses-body {
        text-align: center;
        margin-left: 2%;
        margin-right: 2%;
        margin-bottom: 20px;
    }
    #scenario-user-login-body, #scenario-setup-body, #scenarios-body {
        text-align: left;
        margin-left: 2%;
        margin-right: 2%;
        margin-bottom: 20px;
        /* overflow-x: auto; */
    }
    #scenarios-body {
        text-align: center;
        margin: auto;
    }
    #scenario-user-login, #scenario-definition, #scenarios {
        border: 2px solid rgb(0, 0, 0);
        border-radius: 10px;
        padding-top: 35px;
        padding-bottom: 25px;
        padding-left: 3%;
        padding-right: 3%;
        margin: 40px auto;
        /* margin-bottom: 20px; */
        width: auto;
        background-color:rgb(221, 220, 220);
        text-align: center; 
        vertical-align:top; 
        min-width: 580px;  
    }
    #scenario-setup, #scenario-factors, #scenario-responses {
        border: 2px solid rgb(0, 0, 0);
        border-radius: 10px;
        padding-top: 15px;
        padding-left: 10px;
        padding-right: 10px;
        margin: auto;
        margin-bottom: 20px;
        /* width: auto; */
        /* width: 50%; */
        background-color:rgb(221, 220, 220);
        text-align: center; 
        vertical-align: top; 
    }
    #scenario-setup  {
        background-color:rgb(247, 155, 155);
        /* min-width: 550px; */
    }
    #scenario-factors  {
        background-color:rgb(252, 235, 162);
        /* min-width: 550px; */
    }
    #scenario-responses {
        background-color:rgb(155, 251, 195);
        /* min-width: 550px; */
    }

    #scenario-file-inputs, #scenario-database-inputs, #scenario-dialog-inputs {
        border: 2px solid rgb(255, 94, 0);
        border-radius: 10px;
        padding: 15px;
        margin: 10px auto;
        text-align: center;
        width: auto;
        min-width: 300px;
        background-color:rgb(253, 246, 204);
        vertical-align:top;  
        overflow: auto; 
        font-size: 18px;   
    }
    #scenario-file-inputs-body, #scenario-database-inputs-body, #scenario-dialog-inputs-body, #scenario-file-outputs-body, #scenario-database-outputs-body, #scenario-dialog-inputs-body, #scenario-dialog-outputs-body, #scenarios-table-body {
        margin: 10px auto;
        width: auto;
        text-align: center;
        overflow-x: scroll;
    }
    #scenario-database-outputs, #scenario-file-outputs, #scenario-dialog-outputs {
        border: 2px solid rgb(0, 88, 15);
        border-radius: 10px;
        padding: 15px;
        background-color:rgb(204, 253, 212);
        border-radius: 10px;
        padding: 15px;
        margin: 10px auto;
        text-align: center;
        width: auto;
        min-width: 300px;
        vertical-align: top;  
        overflow: auto; 
        font-size: 18px;   
    }
    #chart-axes, #chart-type {
        margin: 10px;
    }
    #submit-simulation {
        border: 2px solid rgb(0, 0, 0);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        background-color: rgb(248, 179, 179);
        width: auto;
        clear: left;
    }
    #scenarios-table-body {
        border: 2px solid rgb(4, 0, 253);
        border-radius: 10px;
        padding: 15px;
        margin: 2%;
        width: 50%;
        background-color:rgb(204, 205, 253);
        display: inline-block;
        vertical-align:top;  
        font-size: 18px;   
        text-align: center; 
    }
    #scenario-factors-input-files-dropzone {
        /* font-size: 18px; */
        margin: auto;
        width: 50%;
        min-height: 0px !important;
        margin-bottom: 10px;
    }
    #scenario-setup-model-files-dropzone {
        /* font-size: 18px; */
        margin: auto;
        width: 70%;
        min-height: 0px !important;
        margin-top: 10px;
        margin-bottom: 10px;
    }
    #scenario-definition-files-dropzone {
        /* font-size: 18px; */
        margin: auto;
        width: 70%;
        min-height: 0px !important;
        margin-top: 10px;
        margin-bottom: 10px;
    }
    #input-files-dropzone-text {
        margin-bottom: 7%; 
        margin-top: 7%; 
    }
    #database-input-files-dropzone-text {
        margin-bottom: 7%; 
        margin-top: 7%; 
    }
    </style>
</head>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>   
    <header class="header" id="extendsim-asp-header"></header>
    <div id="database-table-modal" class="modal">
        <div class="modal-form">
            <label id="selected-response-table-name-label">Table name:</label>
            <input id="selected-response-table-name" type='text' readonly></input>
            <button class="buttons, modal-buttons" id="view-model-chart-button" onclick="viewModalChart()">View chart</button>
            <button class="buttons, modal-buttons" id="export-table-contents-modal" onclick="exportDataTableToTextFile($('#selected-response-table-name').val())">Export</button>
            <button class="buttons, modal-buttons" id="close-database-table-contents-modal" onclick="closeDatabaseTableContentsModal(event)">Close</button>
            <div id='modal-chart-axes-selection-dropdowns'>
                <div id="chart-type">
                    <label id='chart-type-select-label' for='chart-type-select'>Chart type:</label>
                    <select id='chart-type-select'></select> 
                </div>
                <div id="chart-axes">
                    <label id='modal-x-axis-field-select-label' for='modal-x-axis-field-select'>X-axis:</label>
                    <select id='modal-x-axis-field-select'></select>
                    <label id='modal-y-axis-field-select-label' for='modal-y-axis-field-select'>Y-axis:</label>
                    <select id='modal-y-axis-field-select'></select>
                </div>
            </div>
       </div>  
        <div class="modal-content">
            <div id="modal-form-contents">
                <table class="scenario-tables" id="selected-database-outputs-table" style="width:auto">
                </table>
            </div>
            <div id="modal-chart-container">
                <canvas id="modal-form-chart" width=auto></canvas>
            </div>
        </div>
    </div> 

    <div id="file-contents-modal" class="modal">
        <div class="modal-form">
            <label id="selected-file-name-label">File name:</label>
            <input id="selected-file-name" type='text' readonly></input>
            <button class="buttons" id="export-file-contents-modal" onclick="exportDataTableToTextFile($('#selected-file-name').val())">Export</button>
            <button class="buttons" id="close-file-contents-modal" onclick="closeFileContentsModal(event)">Close</button>
        </div>  
        <div class="modal-content">
            <div id="modal-form-contents">
                <table class="scenario-tables" id="selected-file-contents-table" style="width:auto">
                </table>
            </div>
            <div class="container">
                <!-- <canvas id="modal-form-chart"  width=auto></canvas> -->
                <canvas id="modal-form-chart"  width=80% height=80%></canvas>
            </div>
        </div>
    </div>     

    <div id='page-container'>
    <div id="load_screen"><div id="loading">Loading data from server. Please wait...</div></div>
    <div id="extendsim-asp-axios-tester-frame">
        <div id="extendsim-asp-title-heading">ExtendSim ASP Scenario Manager</div>
        <div id="scenario-user-login">
            <!-- <header id="user-login-title-heading">User Login</header> -->
            <div class='section-header-checkboxes'>
                <input type='checkbox' id='scenario-user-login-checkbox' onclick='updateDOMelementVisibility("scenario-user-login")'>User Login</input>
            </div>
            <div id='scenario-user-login-body'>
                <div class="flex-container">
                    <label  for='username'>
                        Username:
                    </label> 
                    <input class="login" id="username" type="text" name="username" value="analyst2"></input>
                    <!-- <input class="login" id="username" type="text" name="username" value="reliability"></input> -->
                    <label  for='password'>
                        Password: 
                    </label>
                    <input class="login" id="password" type="password" name="password" value="model"></input>        
                </div>
                <div class="flex-container">
                    <label for='ip-address'>
                    IP address:
                    </label>
                    <input class="login" id="ip-address" value="184.171.246.58"></input>            
                </div>
                <div class="flex-container" id='login-section'>
                    <button class="buttons" id="login-button" onclick='loginToServer()'>Login to server</button>
                    <label id="user-login-session-id-label">User Login Session ID:</label>
                    <input class="login" id="user-login-session-id"></input>        
                </div>
            </div>
        </div>
        <div id="scenario-definition">
            <div class='section-header-checkboxes'>
                <input class='scenario-definition-checkboxes' type='checkbox' id='scenario-definition-checkbox' onclick='updateDOMelementVisibility("scenario-definition")'>Scenario Definition</input>
            </div>  
            <div id="scenario-definition-body">
                <div id="scenario-setup">
                    <div class='sub-section-header-checkboxes'>
                        <input type='checkbox' id='scenario-setup-checkbox' onclick='updateDOMelementVisibility("scenario-setup")'>Setup</input>
                    </div>
                    <!-- <div class="flex-container" id='scenario-setup-body'> -->
                    <div  id='scenario-setup-body'>
                        <div>
                            <label id="scenario-model-label">Scenario model:</button>
                            <select onchange="respondToUserModelSelection()" id="user-models"></select>           
                            <div id="setup-scenario-name">
                                <label id="scenario-name-label">Scenario name:</label>
                                <input id="scenario-name"></input>              
                            </div>
                        </div>
                        <form action="/file-upload" class="dropzone" id="scenario-setup-model-files-dropzone"></form>
                    </div>
                </div>
                <div id="scenario-factors">
                    <div class='sub-section-header-checkboxes'>
                        <input type='checkbox' id='scenario-factors-checkbox' onclick='updateDOMelementVisibility("scenario-factors")'>ExtendSim Model Factors</input>
                    </div>
                    <div id='scenario-factors-body'>
                        <div id="scenario-file-inputs">
                            <div>
                                <input id="scenario-file-inputs-checkbox" type="checkbox" onclick='updateDOMelementVisibility("scenario-file-inputs")'>Input Files</input>    
                            </div>
                            <div id="scenario-file-inputs-body">
                                <form action="/file-upload" class="dropzone" id="scenario-factors-input-files-dropzone"></form>
                                <button class="scenario-file-input-buttons" onclick='addNewInputFilesTableRow(inputFileTableRows(), 1)'>Add row</button>
                                <button class="scenario-file-input-buttons" onclick='deleteInputFilesTableRow()''>Delete row</button>
                                <table class="scenario-tables" id="file-inputs-table">
                                    <tr>
                                        <th>
                                            Input data file
                                        </th>
                                    </tr>
                                </table>
                                <button class="upload-files-button" onclick='uploadDataFilesToServer(0)''>Upload scenario input files to server</button>
                                <label id="files-uploaded-status-label">Files uploaded:</label>
                                <input id="files-uploaded-status" type="checkbox"></input>
                            </div>
                        </div>
                        <div id="scenario-database-inputs">
                            <div id="scenario-database-inputs-header">
                                <input type="checkbox" id="scenario-database-inputs-checkbox" onclick='updateDOMelementVisibility("scenario-database-inputs")'>ExtendSim DB Table Inputs</input>    
                            </div>
                            <div id="scenario-database-inputs-body">
                                <button class="scenario-database-input-buttons" id="add-database-inputs-table-row" onclick='addNewDatabaseInputsTableRow(databaseInputsTableRows(), (databaseInputsTableRows() + 1), false)'>Add row</button>
                                <button class="scenario-database-input-buttons" id="delete-database-inputs-table-row" onclick='deleteDatabaseInputsTableRow()'>Delete row</button>
                                <table class="scenario-tables" id="database-inputs-table">
                                    <tr>
                                        <th>
                                            Source data file
                                        </th>
                                        <th>
                                            Target Database
                                        </th>
                                        <th>
                                            Target Table
                                        </th>
                                    </tr>
                                </table>
                                <button class="upload-database-inputs-button" onclick='uploadDataStreamsToModel(0)'>Upload inputs to database tables</button>
                                <label id="database-inputs-uploaded-status-label">Files uploaded:</label>
                                <input id="database-inputs-uploaded-status" type="checkbox"></input>
                            </div>
                        </div>
                        <div id="scenario-dialog-inputs">
                            <div >
                                <input type="checkbox" id="scenario-dialog-inputs-checkbox" onclick='updateDOMelementVisibility("scenario-dialog-inputs")'>Dialog Variable Inputs</input>    
                            </div>
                            <div id="scenario-dialog-inputs-body">
                                <button class="scenario-dialog-input-buttons" id="add-dialog-inputs-table-row" onclick='addNewDialogInputsTableRow(dialogInputsTableRows(), 1, false)'>Add row</button>
                                <button class="scenario-dialog-input-buttons" id="delete-dialog-inputs-table-row" onclick='deleteDialogInputsTableRow()'>Delete row</button>
                                <button class="scenario-dialog-input-buttons" id="upload-dialog-inputs-file" onclick='uploadDialogInputsFile()'>Upload file</button>
                                <table class="scenario-tables" id="dialog-inputs-table" style="width:auto">
                                    <tr>
                                        <th>
                                            Block Type
                                        </th>
                                        <th>
                                            Block Number
                                        </th>
                                        <th>
                                            Type
                                        </th>
                                        <th>
                                            Name
                                        </th>
                                        <th>
                                            Value
                                        </th>
                                    </tr>
                                </table>
                                <button class="upload-dialog-inputs-button" onclick="uploadDialogVariableDataToModel(0)">Upload inputs to dialog variables</button>
                                <label id="dialog-inputs-uploaded-status-label">Inputs uploaded:</label>
                                <input id="dialog-inputs-uploaded-status" type="checkbox"></input>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="scenario-responses">
                    <div class='sub-section-header-checkboxes'>
                        <input type='checkbox' id='scenario-responses-checkbox' onclick='updateDOMelementVisibility("scenario-responses")'>ExtendSim Model Responses</input>
                    </div>
                    <div id='scenario-responses-body'>
                        <div id="scenario-file-outputs">
                            <div id="scenario-file-outputs-header">
                                <!-- <label id="scenario-file-outputs-checkbox-label">Model Files</label> -->
                                <input id="scenario-file-outputs-checkbox" type="checkbox" onclick='updateDOMelementVisibility("scenario-file-outputs")'>Output Files</input>    
                            </div>
                            <div id="scenario-file-outputs-body">
                                <button class="scenario-file-output-buttons" id="add-file-outputs-table-row" onclick='addNewOutputFilesTableRow(outputFileTableRows(), 0)'>Add row</button>
                                <button class="scenario-file-output-buttons" id="delete-file-outputs-table-row" onclick='deleteOutputFilesTableRow()'>Delete row</button>
                                <table class="scenario-tables" id="file-outputs-table" style="width:auto">
                                    <tr>
                                        <th>
                                            Folder
                                        </th>  
                                        <th>
                                            Matching Folder Pattern
                                        </th>                  
                                        <th>
                                            Matching File Pattern
                                        <th>
                                            Action
                                        </th>    
                                    </tr>
                                </table>
                            </div>  
                        </div>         
                        <div id="scenario-database-outputs">
                            <div id="scenario-database-outputs-header">
                                <!-- <label id="scenario-database-outputs-checkbox-label">Database Tables</label> -->
                                <input id="scenario-database-outputs-checkbox" type="checkbox" onclick='updateDOMelementVisibility("scenario-database-outputs")'>ExtendSim DB Table Outputs</input>    
                            </div>
                            <div id="scenario-database-outputs-body">
                                <!-- <h3>Scenario Database Outputs</h3> -->
                                <button class="scenario-database-output-buttons" id="add-database-outputs-table-row" onclick='addNewDatabaseOutputsTableRow(databaseOutputsTableRows(), 1)'>Add row</button>
                                <button class="scenario-database-output-buttons" id="delete-database-outputs-table-row" onclick='deleteDatabaseOutputsTableRow()'>Delete row</button>
                                <table class="scenario-tables" id="database-outputs-table" style="width:auto">
                                    <tr>
                                        <th>
                                            Source Database
                                        </th>
                                        <th>
                                            Source Table
                                        </th>
                                        <th>
                                            Data
                                        </th>
                                        <th>
                                            Chart
                                        </th>
                                        <th>
                                            Export
                                        </th>           
                                    </tr>
                                </table>
                            </div>  
                        </div>    
                        <div id="scenario-dialog-outputs">
                            <div id="scenario-dialog-outputs-header">
                                <!-- <label id="scenario-dialog-outputs-checkbox-label">Dialog Variables</label> -->
                                <input id="scenario-dialog-outputs-checkbox" type="checkbox" onclick='updateDOMelementVisibility("scenario-dialog-outputs")'>Dialog Variable Outputs</input>    
                            </div>
                            <div id="scenario-dialog-outputs-body">
                                <button class="scenario-dialog-output-buttons" id="add-dialog-outputs-table-row" onclick='addNewDialogOutputsTableRow(dialogOutputsTableRows(), 1)'>Add row</button>
                                <button class="scenario-dialog-output-buttons" id="delete-dialog-outputs-table-row" onclick='deleteDialogOutputsTableRow()'>Delete row</button>
                                <table class="scenario-tables" id="dialog-outputs-table" style="width:auto">
                                    <tr>
                                        <th>
                                            Block Type
                                        </th>
                                        <th>
                                            Block Number
                                        </th>
                                        <th>
                                            Type
                                        </th>
                                        <th>
                                            Name
                                        </th>
                                        <th>
                                            Value
                                        </th>
                                    </tr>
                                </table>
                                <!-- <button class="download-dialog-outputs-button" onclick="downloadDialogVariableDataFromModel(0)">Get dialog variable values</button>
                                <label id="dialog-outputs-uploaded-status-label">Inputs uploaded:</label>
                                <input id="dialog-outputs-uploaded-status" type="checkbox"></input> -->
                            </div>
                        </div>     
                    </div>
                </div>
                <!-- <label for='load-scenario-definition' class="btn">Load scenario definition</label> -->
                <!-- <button onclick='$("#load-scenario-definition").click()'>Load scenario definition</button>
                <input type="file" id='load-scenario-definition' style='display: none' onchange='loadScenarioDefinition(event)'></input> -->
                <form action="/file-upload" class="dropzone" id="scenario-definition-files-dropzone"></form>
                <button class='scenario-buttons' id='save-scenario-definition' onclick='saveScenarioDefinition()'>Save scenario definition</button>
            </div>
        </div>
        <div id="scenarios">
            <div class='section-header-checkboxes'>
                <input type='checkbox' id='scenarios-checkbox' onclick='updateDOMelementVisibility("scenarios")'>Scenarios</input>
            </div>
            <div id='scenarios-body'>
                <div>
                    <!-- <div>
                        <div id='submit-scenarios'>
                            <button class="scenario-buttons" id="submit-scenarios-button" onclick='submitSelectedSimulationScenarios(0)'>Submit scenario</button>
                        </div>            
                    </div>
                    <label id="scenario-id-label">Scenario ID:</label>
                    <input id="scenario-id"></input>    
                    <label id="scenario-status-label">Scenario status:</label>
                    <input id="scenario-status"></input> 
                    <br></br>
                    <label id="user-scenario-folder-pathname-label">Selected Scenario folder pathname:</label> -->
                    <label id="user-scenario-folder-pathname-label">Selected Scenario folder pathname:</label>
                    <input id="user-scenario-folder-pathname" readonly></input> 
                </div>
                <div id="scenarios-table-body">
                    <table class="scenario-tables" id="scenarios-table">
                        <tr>
                            <th>
                                Select
                            </th>
                            <th>
                                ID
                            </th>
                            <th>
                                Name
                            </th>
                            <th>
                                Repetitions
                            </th>
                            <th>
                                Status
                            </th>
                            <th nowrap>
                                % Complete
                            </th>
                            <th>
                                Folder
                            </th>
                        </tr>
                    </table>
                    <div id='remove-selected-button'>
                        <button class="scenario-buttons" id="run-selected-scenarios-button" onclick='submitSelectedSimulationScenarios(0)'>Run selected scenarios</button>
                        <button id="get-selected-scenario-responses-button" onclick="getSelectedScenarioResponses(0)">Get selected scenario responses from server</button>
                        <button id="remove-selected-scenario-folders-button"  onclick="removeSelectedScenarioFolders()">Remove selected scenario folders from server</button>
                    </div>
                </div>
            </div>
        </div>    
    </div>
</div> 
<script type="text/javascript">
    Dropzone.options.mydropzone = {
        init: function() {
            this.on("sending", function(file, xhr, formData) { 
                uploadUserModelPathnameToServer(g_userModelsRootPath, file.name)
                .then(function() {
                    alert("Successfully sent model pathname to server");                    
                })
            });

        }
    };
    var modelBlocks = [];
    var blockNumbers = [];
    var dialogVariableTypes = [];
    var uploadedFiles = [];
    var uploadedDatabaseFiles = [];
    var selectedFiles = [];
    var selectedDatabaseFiles = [];
    var scenarioFolderFiles = [];
    var modelDatabases = [];
    var g_tableSchema = {};
    var g_tableDataArray = [];
    var g_fileDataArray = [];
    var g_submittedScenarios = [];
    var modelBlockInfo;
    // var inputFileTableRows = 0;
    // var outputFileTableRows = 0;
    // var databaseInputsTableRows = 0;
    // var dialogInputsTableRows = 0;
    // var dialogOutputsTableRows = 0;
    // var databaseOutputsTableRows = 0;
    var g_scenariosTableRows = 0;
    const scenarioStatusValues = ['Unsubmitted', 'Submitted', 'Running', 'Completed', 'Aborted']
    // var numFilesUploaded = 0;
    var numDatabaseFilesUploaded = 0;
    var tableDataHtmlCode = "";
    var myCheckStatusInterval;
    var loadedScenarioModelpathname = "";
    var g_modelChartCreated = false;
    var g_loadingScenarioData = false;
    var g_RSMblockNumber = -1;
    var g_chartData = {
        labels: [],
        data: []
    }
    var g_scenarioDefinition = {
        factors: {
                scenarioName: "",
                uploadedFiles: [],
                uploadedDatabaseFiles: [],
                modelName: "",
                scenarioFolderPathname: "",
                modelPathname: "",
                factorDatabasenames: [],
                factorTablenames: [],
                blockTypes: [],
                variableTypes: [],
                variableNames: [],
                variableValues: [],
                blockNumbers: []
            },
            responses: {
            }
    }
    var g_ScenarioDefinitions = [
        {
            factors: {
                scenarioName: "",
                uploadedFiles: [],
                uploadedDatabaseFiles: [],
                modelName: "",
                scenarioFolderPathname: "",
                modelPathname: "",
                factorDatabasenames: [],
                factorTablenames: [],
                blockTypes: [],
                variableTypes: [],
                variableNames: [],
                variableValues: [],
                blockNumbers: []
            },
            responses: {
                outputFiles: [
                    {
                        folder: '',
                        matchingFolderpattern: '',
                        matchingFilePattern: ''
                    }
                ],
                responseDatabasenames: [],
                responseTablenames: [],
                blockTypes: [],
                variableTypes: [],
                variableNames: [],
                variableValues: [],
                blockNumbers: []               
            },
            scenarioRunDetails: {
                ID: -1,
                modelPath: "",
                runButtonName: "",
                blockNumber: "",
                quitExtendSim: true,
                quitExcel: false,
                submissionTime: 0,
                startTime: 0,
                completionTime: 0,
                currentSimulationTime: 0,
                endSimulationTime: 0,
                runNumber: -1,
                Aborted: false           
            }
        }
    ]
    var g_uploadedUserModelFile = {
        name: '',
        filedata: '',
        arrayBuffer: []
    }
    var g_containers = [
        {
            name: 'scenario-user-login',
            width: {
                checked: 'auto',
                unchecked: '50%'
            },
            parent: {
                name: '',
                width: {
                    checked: '',
                    unchecked: ''
                }
            },
            children: [
                {
                    name: '',
                    width: {
                        checked: '',
                        unchecked: ''
                    }
                },
            ],
        },
        {
            name: 'scenario-definition',
            width: {
                checked: 'auto',
                unchecked: '50%'
            },
            parent: {
                name: '',
                width: {
                    checked: '',
                    unchecked: ''
                }
            },
            children: [
                {
                    name: 'scenario-setup',
                    width: {
                        checked: 'auto',
                        unchecked: '70%'
                    }
                },
                {
                    name: 'scenario-factors',
                    width: {
                        checked: 'auto',
                        unchecked: '70%'
                    }
                },
                {
                    name: 'scenario-responses',
                    width: {
                        checked: 'auto',
                        unchecked: '70%'
                    }
                }
            ]
        },
        {
            name: 'scenarios',
            width: {
                checked: 'auto',
                unchecked: '50%'
            },
            parent: {
                name: '',
                width: {
                    checked: '',
                    unchecked: ''
                }
            },
            children: [
                {
                    name: '',
                    width: {
                        checked: '',
                        unchecked: ''
                    }
                },
            ],
        },
        {
            name: 'scenario-setup',
            width: {
                checked: '70%',
                unchecked: '70%',
                minimum: 300
            },
            parent: {
                name: 'scenario-definition',
                width: {
                    checked: 'auto',
                    unchecked: 'auto'
                }
            },
            children: [
                {
                    name: '',
                    width: {
                        checked: '',
                        unchecked: ''
                    }
                },
            ],
        },
        {
            name: 'scenario-factors',
            width: {
                checked: 'auto',
                unchecked: '70%',
                minimum: 300
            },
            parent: {
                name: 'scenario-definition',
                width: {
                    checked: 'auto',
                    unchecked: 'auto'
                }
            },
            children: [
                {
                    name: 'scenario-file-inputs',
                    width: {
                        checked: 'auto',
                        unchecked: '70%'
                    }
                },
                {
                    name: 'scenario-database-inputs',
                    width: {
                        checked: 'auto',
                        unchecked: '70%'
                    }
                },
                {
                    name: 'scenario-dialog-inputs',
                    width: {
                        checked: 'auto',
                        unchecked: '70%'
                    }
                }
            ],
        },
        {
            name: 'scenario-responses',
            width: {
                checked: 'auto',
                unchecked: '70%',
            },
            parent: {
                name: 'scenario-definition',
                width: {
                    checked: 'auto',
                    unchecked: 'auto'
                }
            },
            children: [
                {
                    name: 'scenario-file-outputs',
                    width: {
                        checked: 'auto',
                        unchecked: '70%'
                    }
                },
                {
                    name: 'scenario-database-outputs',
                    width: {
                        checked: 'auto',
                        unchecked: '70%'
                    }
                },
                {
                    name: 'scenario-dialog-outputs',
                    width: {
                        checked: 'auto',
                        unchecked: '70%'
                    }
                }
            ],
        },
        {
            name: 'scenario-file-inputs',
            width: {
                checked: 'auto',
                unchecked: '70%',
                minimum: 300
            },
            parent: {
                name: 'scenario-factors',
                width: {
                    checked: 'auto',
                    unchecked: '70%'
                }
            },
            children: [
                {
                    name: '',
                    width: {
                        checked: '',
                        unchecked: ''
                    }
                },
            ],
        },
        {
            name: 'scenario-database-inputs',
            width: {
                checked: 'auto',
                unchecked: '70%',
                minimum: 300
            },
            parent: {
                name: 'scenario-factors',
                width: {
                    checked: 'auto',
                    unchecked: '70%'
                }
            },
            children: [
                {
                    name: '',
                    width: {
                        checked: '',
                        unchecked: ''
                    }
                },
            ],
        },
        {
            name: 'scenario-dialog-inputs',
            width: {
                checked: 'auto',
                unchecked: '70%',
                minimum: 300
            },
            parent: {
                name: 'scenario-factors',
                width: {
                    checked: 'auto',
                    unchecked: '70%'
                }
            },
            children: [
                {
                    name: '',
                    width: {
                        checked: '',
                        unchecked: ''
                    }
                },
            ],
        },    
        {
            name: 'scenario-file-outputs',
            width: {
                checked: 'auto',
                unchecked: '70%',
                minimum: 300
            },
            parent: {
                name: 'scenario-responses',
                width: {
                    checked: 'auto',
                    unchecked: '70%'
                }
            },
            children: [
                {
                    name: '',
                    width: {
                        checked: '',
                        unchecked: ''
                    }
                },
            ],
        },
        {
            name: 'scenario-database-outputs',
            width: {
                checked: 'auto',
                unchecked: '70%',
                minimum: 300
            },
            parent: {
                name: 'scenario-responses',
                width: {
                    checked: 'auto',
                    unchecked: '70%'
                }
            },
            children: [
                {
                    name: '',
                    width: {
                        checked: '',
                        unchecked: ''
                    }
                },
            ],
        },
        {
            name: 'scenario-dialog-outputs',
            width: {
                checked: 'auto',
                unchecked: '70%',
                minimum: 300
            },
            parent: {
                name: 'scenario-responses',
                width: {
                    checked: 'auto',
                    unchecked: '70%'
                }
            },
            children: [
                {
                    name: '',
                    width: {
                        checked: '',
                        unchecked: ''
                    }
                },
            ],
        } 
    ];
    var g_userModelsRootPath = "";
    var g_myModalChart;
    var IPaddress = "";
    // var IPaddress = "http://184.171.246.58"; 

    // const IPaddress = "localhost";
    // var queryURL_root = "http://" + IPaddress + ":8090/StreamingService/web/"
    var queryURL_root =  IPaddress + ":3001/api/"
    // var queryURL_root2 = "http://" + IPaddress + ":3001/api/users/login/"
    // var queryURL = "http://" + IPaddress + ":8090/StreamingService/web/LoginToServer"
    // var queryURL2 = "http://" + IPaddress + ":8090/StreamingService/web/EchoWithGet"
    // var queryURL3 = "http://" + IPaddress + ":8090/StreamingService/web/GetServerDirectoryFiles"
    // var queryURL = "http://" + IPaddress + ":8090/StreamingService/web/LoginToServer?username=analyst1&password=model"
    // const proxyurl = "https://cors-anywhere.herokuapp.com/";
    const c_dropzone_inputfileupload_defaultMessage = 'Drop scenario input files here';
    const c_dropzone_modelfileupload_defaultMessage = 'Drop model files here to upload to server';
    const c_dropzone_scenarioDefinitionFileupload_defaultMessage = 'Drop scenario definition files here';
    const c_ModelFolder_outputFolderOption="Model folder"
    const c_AllModelSubFolders_outputFolderOption="All model sub-folders"
    const c_ModelSubFoldersWithMatchingPattern_outputFolderOption="Model sub-folders with matching pattern"

    const c_undefined_ScenarioDetailsTime = -1;
    const c_undefined_scenarioID = -1;

    const proxyurl = "";
    const pathname = "C:\Users\Administrator\Documents\ExtendSim10ASP_Prod\ASP\ASP Servers\ExtendSim Models\Analyst 1";
    const c_Completed_status = 3;
    const c_Aborted_status = 4;
    const c_scenarioSelectedColumn = 0;
    const c_scenarioIDColumn = 1;
    const c_scenarioNameColumn = 2;
    const c_scenarioStatusColumn = 4; 
    const c_PercentComplete = 5;
    const c_scenarioFolderPathnameColumn = 6;
    const c_waitForRunningSimulationScenariosInterval = 1000;
    const c_statusCheckInterval = 500;
    const c_statusCheckTimeout = 500;
 
    const c_ReliabilityScenarioManager_blockName = "Reliability Scenario Manager";
    const c_ReliabilityScenarioManager_runButtonName = "SCEN_RunSelected_btn";
    const c_DB_FIELDTYPE_INTEGER_VALUE = 4096;
    const c_DB_FIELDTYPE_INTEGER_BOOLEAN = 4097;
    const c_DB_FIELDTYPE_REAL_GENERAL = 8192;
    const DB_FIELDTYPE_REAL_SCIENTIFIC = 8193;
    const DB_FIELDTYPE_REAL_PERCENT = 8194;
    const DB_FIELDTYPE_REAL_CURRENCY = 8195;
    const DB_FIELDTYPE_REAL_DATE_TIME = 8196;
    const DB_FIELDTYPE_REAL_DB_ADDRESS = 8197;
    const DB_FIELDTYPE_STRING_VALUE = 16384;
    const DB_FIELDTYPE_TABLELIST = 16385;
    // const username = 'analyst1';
    // const password = 'model';
    $('.buttons').prop('disabled', true);
    $('.scenario-file-input-buttons').prop('disabled', true);
    $('.scenario-file-output-buttons').prop('disabled', true);
    $('.scenario-database-input-buttons').prop('disabled', true);
    $('.scenario-database-output-buttons').prop('disabled', true);
    $('.scenario-dialog-input-buttons').prop('disabled', true);
    $('.scenario-dialog-output-buttons').prop('disabled', true);
    $('.scenario-buttons').prop('disabled', true);
    $('.user-login-buttons').prop('disabled', true);
    $('.scenario-checkbox').prop('disabled', true);
    $('#load-scenario-definition').prop('disabled', false);
    
    $('#scenario-user-login-checkbox').prop('checked', false);
    $('#scenario-setup-checkbox').prop('checked', false);
    $('#scenario-factors-checkbox').prop('checked', false);
    $('#scenario-responses-checkbox').prop('checked', false);
    $('#scenario-factors-checkbox').prop('disabled', true);
    $('#scenario-responses-checkbox').prop('disabled', true);
    $('#scenarios-checkbox').prop('checked', false);
    $('#scenarios-checkbox').prop('disabled', true);
    $('.scenario-definition-checkboxes').prop('disabled', true);
    $('#remove-selected-scenario-folders-button').prop('disabled', !areScenariosSelected());
    $('#get-selected-scenario-responses-button').prop('disabled', !areScenariosSelected());
    $('#responses-checkbox').prop('checked', false);
    $('#scenarios-checkbox').prop('checked', false);
    $('#scenario-file-inputs-checkbox').prop('checked', false);
    $("#model-copied-status").prop('checked', false);
    $("#server-actions").hide();
    $('#modal-form-chart').hide();
    $("#database-table-modal").hide();
    $("#file-contents-modal").hide();
    $(".upload-files-button").hide();
    $("#files-uploaded-status-label").hide();
    $("#files-uploaded-status").hide();
    $(".upload-database-inputs-button").hide();
    $("#database-inputs-uploaded-status-label").hide();
    $("#database-inputs-uploaded-status").hide();
    $(".upload-dialog-inputs-button").hide();
    $("#dialog-inputs-uploaded-status-label").hide();
    $("#dialog-inputs-uploaded-status").hide();

    enableDisableUserLoginButton();
    validateUserInputs();

    // page sections
    updateDOMelementVisibility("scenario-user-login");
    updateDOMelementVisibility("scenario-definition");
    updateDOMelementVisibility("scenario-setup");
    updateDOMelementVisibility("scenario-factors");
    updateDOMelementVisibility("scenario-responses");
    updateDOMelementVisibility("scenarios");
    $("#scenario-factors").hide();
    $('#scenario-responses').hide();

    // factors
    updateDOMelementVisibility("scenario-file-inputs");
    updateDOMelementVisibility("scenario-database-inputs");
    updateDOMelementVisibility("scenario-dialog-inputs");
    // responses
    updateDOMelementVisibility("scenario-file-outputs");
    updateDOMelementVisibility("scenario-database-outputs");
    updateDOMelementVisibility("scenario-dialog-outputs");
    updateLoadingDivVisibility(false);

    g_ScenarioDefinitions = [];

    jQuery.fn.centerElement = function () {
        this.css ("position", "absolute");
        this.css ("top", ($ (window). height () - this.height ()) / 2 + $ (window). scrollTop () + "px");
        this.css ("left", ($ (window). width () - this.width ()) / 2 + $ (window). scrollLeft () + "px")
        
        return this;
    }
    function setupDropzone(dropzoneID, dropzoneMessage) {
        var myDropzone = $('#' + dropzoneID);
        $(myDropzone).removeClass('dz-started');
        $('.dz-preview').remove();
        $(myDropzone).html('<div class="dz-default dz-message"><span>' + dropzoneMessage + '</span></div>');
    }
    Dropzone.options.scenarioFactorsInputFilesDropzone = {
        createImageThumbnails: false, // NO THUMBS!
        dictDefaultMessage: c_dropzone_inputfileupload_defaultMessage,
        init: function() {
            this.on("addedfile", function(file) { 
                addNewInputFilesTableRow(inputFileTableRows(), 1)
                .then(function(rowIndex) {
                    setupDropzone('scenario-factors-input-files-dropzone', c_dropzone_inputfileupload_defaultMessage);
                    readAndPreviewInputFile(file, 'my-id-' + rowIndex);
                })
            });
        }
    };
    Dropzone.options.scenarioSetupModelFilesDropzone = {
        createImageThumbnails: false, // NO THUMBS!
        dictDefaultMessage: c_dropzone_modelfileupload_defaultMessage,
        init: function() {
            this.on("addedfile", function(file) { 
                readAndPreviewUserModelFile(file)
                .then(function(rowIndex) {
                    setupDropzone('scenario-setup-model-files-dropzone', c_dropzone_modelfileupload_defaultMessage);
                })
            });
        }
    };
    Dropzone.options.scenarioDefinitionFilesDropzone = {
        createImageThumbnails: false, // NO THUMBS!
        dictDefaultMessage: c_dropzone_scenarioDefinitionFileupload_defaultMessage,
        init: function() {
            initializeScenarioData();
            this.on("addedfile", function(file) { 
                readAndPreviewScenarioDefinitionFile(file)
                .then(function(rowIndex) {
                    setupDropzone('scenario-definition-files-dropzone', c_dropzone_scenarioDefinitionFileupload_defaultMessage);
                    // enable scenarios checkbox
                    $('#scenarios-checkbox').prop('disabled', false);
                    $('#load-scenario-definition').val("");
                })
            });
        }
    };

    function dz_complete(file) {
        $('.dz-preview').remove();  // ...delete the template gen'd html.
    }
    // myAwesomeDropzone.on("complete", function(file) {
    //     myAwesomeDropzone.removeFile(file);
    // });

    function getNumScenariosSelected() {
        var numRowsSelected = 0;
        $('#scenarios-table tr').each(function(i) {
            // Cache checkbox selector
            var $chkbox = $(this).find('input[type="checkbox"]');

            // Only check rows that contain a checkbox
            if($chkbox.length) {
                var status = $chkbox.prop('checked');
                if (status === true) {
                    numRowsSelected++;
                }
            }
        });
        return numRowsSelected;
    }
    function updateScenariosTableCellValue(rowIndex, columnIndex, cellValue) {
        var table = $("#scenarios-table");
        var statusValue = table.find('tr:eq(' + rowIndex + ') t' + (rowIndex == 0 ?  "h" : "d") + ':eq(' + columnIndex + ')').text(); 
        table.find('tr:eq(' + rowIndex + ') t' + (rowIndex == 0 ?  "h" : "d") + ':eq(' + columnIndex + ')').text(cellValue); 
    }
    function updateScenariosTableProgressBarValue(rowIndex, percentComplete) {
        var progressBar = $('#scenario-progress-bar-' + (rowIndex + 1));
        $(progressBar).attr('value', percentComplete);
        var progressValue = $('#scenario-progress-value-' + (rowIndex + 1));
        $(progressValue).text(percentComplete.toString() + '%');
    }
    $("#the-form").submit(function(event) {
        event.preventDefault();

        var formData = new FormData(this);
        var extendsimmodelfile = $('#extendsim-model-file');
        var fakepath = $('#extendsim-model-file').val();
        extendSimModelFilename = fakepath.substring(fakepath.lastIndexOf("\\") + 1);
        uploadUserModelPathnameToServer(g_userModelsRootPath, extendSimModelFilename)
        .then(function() {
            var xhr = new XMLHttpRequest();
            // Add any event handlers here...
            xhr.open('POST', "http://184.171.246.58:3001/api/ExtendSim/sendmodelfile", true);
            xhr.send(formData);
            updateLoadingDivVisibility(false);
            return false; // To avoid actual submission of the form
        })
    });
        
    function prepCSVRow(arr, columnCount, initial) {
        var row = ''; // this will hold data
        var delimeter = ','; // data slice separator, in excel it's `;`, in usual CSv it's `,`
        var newLine = '\r\n'; // newline separator for CSV row
        var plainArr = splitArray(arr, columnCount);
        plainArr.forEach(function(arrItem) {
            arrItem.forEach(function(item, idx) {
            row += item + ((idx + 1) === arrItem.length ? '' : delimeter);
            });
            row += newLine;
        });
        return initial + row;
    }
    function splitArray(_arr, _count) {
        var splitted = [];
        var result = [];
        _arr.forEach(function(item, idx) {
            if ((idx + 1) % _count === 0) {
                splitted.push(item);
                result.push(splitted);
                splitted = [];
            } else {
                splitted.push(item);
            }
        });
        return result;
    }
    function exportToCsv(filename, rows) {
        var processRow = function (row) {
            var finalVal = '';
            for (var j = 0; j < row.length; j++) {
                var innerValue = row[j] === null ? '' : row[j].toString();
                if (row[j] instanceof Date) {
                    innerValue = row[j].toLocaleString();
                };
                var result = innerValue.replace(/"/g, '""');
                if (result.search(/("|,|\n)/g) >= 0)
                    result = '"' + result + '"';
                if (j > 0)
                    finalVal += ',';
                finalVal += result;
            }
            return finalVal + '\n';
        };

        var csvFile = '';
        for (var i = 0; i < rows.length; i++) {
            csvFile += processRow(rows[i]);
        }

        var blob = new Blob([csvFile], { type: 'text/csv;charset=utf-8;' });
        if (navigator.msSaveBlob) { // IE 10+
            navigator.msSaveBlob(blob, filename);
        } else {
            var link = document.createElement("a");
            if (link.download !== undefined) { // feature detection
                // Browsers that support HTML5 download attribute
                var url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    }
    function exportDataTableToTextFile(tableName) {
        var titles = [];
        var data = [];
        var tableId = 'selected-database-outputs-table';
        $('#' + tableId + ' th').each(function() {
            titles.push($(this).text());
        });
        $('#' + tableId + ' td').each(function() {
            data.push($(this).text());
        });
        var tableData = [];
        g_tableSchema.fields.forEach(function(element) {
            tableData.push(element);
        })
        // concat(g_tableDataArray);
        convertArrayToCSVfile(titles, data, g_tableDataArray.length, tableName + ".csv");
    }
    function setUsersModelRootPath(userModelPaths) {
        var rootPath = '';
        for (var i = 0; i < userModelPaths.length; i++) {
            rootPath = userModelPaths[i].substring(0, userModelPaths[i].lastIndexOf("\\"));
            if (i === 0) {
                g_userModelsRootPath = rootPath;
            }
            if (rootPath.length < g_userModelsRootPath.length) {
                g_userModelsRootPath = rootPath;
            }
        }
    }
    function convertArrayToCSVfile(titles, data, numColumns, filename) {
        var CSVString = "";
        if (titles.length > 0) {
            CSVString = prepCSVRow(titles, numColumns, '');
        }
        CSVString = prepCSVRow(data, numColumns, CSVString);
        var downloadLink = document.createElement("a");
        var blob = new Blob(["\ufeff", CSVString]);
        var url = URL.createObjectURL(blob);
        downloadLink.href = url;
        downloadLink.download = filename;
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
    }
    function exportScenarioModelTableToTextFile(event) {
        var rowIndex = getRowIndexFromTableRowId(event.target.id);
        updateLoadingDivVisibility(true, 'Loading data from server. Please wait...');
        var modelInfo = buildDatabaseTableContentsStreamModelInfo(event.target.id);
        getDatabaseTableContentsStream(modelInfo, true)
        .then(function(response) {
            var titles = response.data.modelDatabaseTableFields.fields;
            var data = [];
            g_tableDataArray.forEach(function(elements, index) {
                for (var i=0;i<elements.length;i++) {            
                    data.push(elements[i]);
                }
            });
            convertArrayToCSVfile(titles, data, titles.length, modelInfo.Tablename + ".csv");
            updateLoadingDivVisibility(false);
        });
    }
    function isFieldNumeric(dataType) {
        if ((dataType === c_DB_FIELDTYPE_INTEGER_VALUE) ||
            (dataType === c_DB_FIELDTYPE_INTEGER_BOOLEAN) ||
            (dataType === c_DB_FIELDTYPE_REAL_GENERAL) ||
            (dataType === DB_FIELDTYPE_REAL_SCIENTIFIC) ||
            (dataType === DB_FIELDTYPE_REAL_PERCENT) ||
            (dataType === DB_FIELDTYPE_REAL_CURRENCY) ||
            (dataType === DB_FIELDTYPE_REAL_DATE_TIME)) {
            return true;
        } else {
             return false;
        }
    }
    function populateDropdownElement(tableSchema, dropdownElement, restrictToNumbers) {
        var firstFieldIndex = -1;

        dropdownElement.empty(0);
        for (var i = 0; i < tableSchema.fields.length; i++) {
            if (!restrictToNumbers || isFieldNumeric(tableSchema.dataTypes[i])) {
                dropdownElement.append('<option value="' + tableSchema.fields[i] + '">' + tableSchema.fields[i] + '</option>');
                if (firstFieldIndex === -1) {
                    firstFieldIndex = i;
                }
            }
        }
        if (firstFieldIndex !== -1) {
            dropdownElement.val(tableSchema.fields[firstFieldIndex]);
        }
    }

    function makeChartDataSeries(dataArray, dataSchema, labelHeading, dataHeading) {
        return new Promise((resolve, reject) => {
            console.log('makeChartDataSeries: dataSchema' + JSON.stringify(dataSchema));
            var dataColumnIndex = dataSchema.fields.indexOf(dataHeading);
            var labelColumnIndex = dataSchema.fields.indexOf(labelHeading);
            g_chartData.labels = [];
            g_chartData.values = [];
            dataArray.forEach(function(elements, index) {
                g_chartData.labels.push(elements[labelColumnIndex]);
                g_chartData.values.push(elements[dataColumnIndex]);
            });
            resolve(true);
        });
    }

    function makeCycleTimeChartData(cycleTimeData, dataType) {
        const dataRow = [];
        cycleTimeData.map((rowData, key) => {
        const {
                stepname,
                totalJobsProcessed, 
                totalProcessTime, 
                totalWaitTime,
                avgProcessTime,
                avgWaitTime,
                avgCycleTime,
                CoVarrivals,
                CoVdepartures
                } = rowData; //destructuring
        var value;
    
        switch (dataType) {
            case 'totalJobsProcessed':
            value = totalJobsProcessed;
            break;

            case 'totalProcessTime':
            value = totalProcessTime;
            break;

            case 'totalWaitTime':
            value = totalWaitTime;
            break;

            case 'avgProcessTime':
            value = avgProcessTime;
            break;

            case 'avgWaitTime':
            value = avgWaitTime;
            break;

            case 'avgCycleTime':
            value = avgCycleTime;
            break;

            case 'CoVarrivals':
            value = CoVarrivals;
            break;
            
            case 'CoVdepartures':
            value = CoVdepartures;
            break; 

            default:
            value = '';
            break;    
            }
            dataRow.push({"value": value, "label": stepname });
            return true;
        });
        return dataRow;
    }
    function downloadFiles(fileIndex, serverFiles) {
        return new Promise((resolve, reject) => {
            if (fileIndex < serverFiles.length) {
                getServerFile(serverFiles[fileIndex].serverFilepath)
                .then(function(response) {
                    console.log(JSON.stringify(response.data.result));
                    var fileData  = response.data.result;
                    g_fileDataArray = fileData.split('\r\n').map(function(ln){
                        return ln.split('\t');
                    });
                    // Remove last empty element from array
                    if (g_fileDataArray.length > 1) {
                        g_fileDataArray.pop();
                    }
                 
                    // var blob = new Blob([JSON.stringify(response.data.result)],
                    //                     { type: 'text/csv;charset=utf-8;' });
                                //    { type: "text/plain;charset=utf-8", endings:'native' });
                    // saveAs(blob, serverFiles[fileIndex].clientFilepath);
                    // var titles = response.data.modelDatabaseTableFields.fields;
                    var data = [];
                    g_fileDataArray.forEach(function(elements, index) {
                        for (var i=0;i<elements.length;i++) {            
                            data.push(elements[i]);
                        }
                    });
                    var titles = [];
                    // convertArrayToCSVfile(titles, data, g_tableDataArray.length, serverFiles[fileIndex].clientFilepath);
                    exportToCsv(serverFiles[fileIndex].clientFilepath, g_fileDataArray);
                    fileIndex++;
                    resolve(downloadFiles(fileIndex, serverFiles));
                });
            } else {
                resolve(true);                                
            }
        });
    }
    function downloadDatabaseTableDataFromServer(DBtableResponseIndex, scenarioIndex) {
        return new Promise((resolve, reject) => {
            if (DBtableResponseIndex >= g_ScenarioDefinitions[scenarioIndex].responses.responseDatabasenames[DBtableResponseIndex].length) {
                resolve(true);
            } else {
                var modelInfo = {
                    Modelpathname: g_ScenarioDefinitions[scenarioIndex].factors.modelPathname,
                    Databasename:  g_ScenarioDefinitions[scenarioIndex].responses.responseDatabasenames[DBtableResponseIndex],
                    Tablename: g_ScenarioDefinitions[scenarioIndex].responses.responseTablenames[DBtableResponseIndex],
                }
                getDatabaseTableContentsStream(modelInfo, true)
                .then(function(response) {
                    var titles = response.data.modelDatabaseTableFields.fields;
                    var data = [];
                    g_tableDataArray.forEach(function(elements, index) {
                        for (var i=0;i<elements.length;i++) {            
                            data.push(elements[i]);
                        }
                    });
                    convertArrayToCSVfile(titles, data, titles.length, modelInfo.Tablename + ".csv");
                    DBtableResponseIndex++;
                    if (DBtableResponseIndex < g_ScenarioDefinitions[scenarioIndex].responses.responseDatabasenames[DBtableResponseIndex].length) {
                        resolve(downloadDatabaseTableDataFromServer(DBtableResponseIndex, scenarioIndex));
                    } else {
                        resolve(true);
                        updateLoadingDivVisibility(false);
                    }
                });
            };
        });
    }
    function downloadDialogVariableDataFromServer(fileIndex, scenarioIndex) {
        return new Promise((resolve, reject) => {
            resolve(true);
        });
    }
    function downloadOutputFilesFromServer(fileIndex, scenarioIndex) {
        return new Promise((resolve, reject) => {
            var folder;
            // alert('uploadDataFilesToServer_new: Uploading ' + g_ScenarioDefinitions[scenarioIndex].factors.uploadedFiles.length + ' files');
            if (g_ScenarioDefinitions[scenarioIndex].responses.outputFiles.length < 1) {
                // Exit since there are no files to copy
                resolve(true);
            } else {
                event.preventDefault();
                folder = g_ScenarioDefinitions[scenarioIndex].responses.outputFiles[fileIndex].folder;
                if (folder === c_ModelFolder_outputFolderOption) {
                    // Pull the list of files from the scenario model folder
                    getScenarioFolderFiles(g_ScenarioDefinitions[scenarioIndex].factors.scenarioFolderPathname)
                    .then(function(response) {
                        var scenarioFolderFiles = response.data.scenarioFolderFiles;
                        var matchingFilePattern = g_ScenarioDefinitions[scenarioIndex].responses.outputFiles[fileIndex].matchingFilePattern.trim();
                        var position = matchingFilePattern.indexOf('*');
                        if (position >= 0) {
                            matchingFilePattern = matchingFilePattern.replace(/[*]/g,"");
                        }
                        var pattern = ".txt";
                        var serverFiles = [];
                        for (var i = 0; i < scenarioFolderFiles.length; i++) {
                            if (scenarioFolderFiles[i].OriginalPath.indexOf(matchingFilePattern) >= 0) {
                                serverFilepath = g_ScenarioDefinitions[scenarioIndex].factors.scenarioFolderPathname + "\\" + scenarioFolderFiles[i].OriginalPath;
                                // alert('Getting server file=' + serverFilepath);
                                var clientFilepath = scenarioFolderFiles[i].OriginalPath;
                                serverFiles.push({
                                    serverFilepath: serverFilepath,
                                    clientFilepath: clientFilepath
                                });
                            }
                        }
                        if (serverFiles.length > 0) {
                            downloadFiles(0, serverFiles)
                            .then(function(response) {
                                resolve(response);
                            })
                        }
                    });
                } else if (folder === c_AllModelSubFolders_outputFolderOption) {
                    // Pull the list of folders from the scenario model folder

                } else if (folder === c_ModelSubFoldersWithMatchingPattern_outputFolderOption) {
                    // Pull the list of folders from the scenario model folder and filter
                    //  on matching folder name pattern

                }
            }
        });
    }

    function getSelectedScenarioResponses(rowIndex) {
        return new Promise((resolve, reject) => {
            // Loop on all responses:
            //  1) Output files
            //      a) Depending on folder type, get list of folders or use the scenario folder as the root
            //      b) Get list of files in the folders
            //      c) Using file pattern, pull files that match pattern to the user specified client outputs folder
            //  2) Database tables
            //  3) Dialog variables
            // Loop on all selected scenarios that have a completed status

            var scenariosTable = $('#scenarios-table');
            var thisRow = $(scenariosTable).find("tr:eq(" + (rowIndex + 1) + ")");
            var selectElementId = $(thisRow).attr('id');
            // var scenarioIndex = Number(selectElementId.substring(selectElementId.lastIndexOf("-") + 1)) - 1;
            var scenarioIndex = getScenariosTableScenarioIndex(rowIndex + 1);
            selected = isScenarioSelected(scenarioIndex);
            if (selected) {
                var scenarioFolderName = $(thisRow).find('td:eq(' + c_scenarioNameColumn + ')').text();
                // download all files generated by the scenario that match user-specified pattern
                downloadOutputFilesFromServer(0, scenarioIndex)
                .then(function(downloadOutputFilesResponse) {
                    // download data as text files from all user specified database table responses
                    downloadDatabaseTableDataFromServer(0, scenarioIndex)
                    .then(function(downloadDatabaseTableDataResponse) {
                    // download data as a text file from all user specified dialog variable responses
                    downloadDialogVariableDataFromServer(0, scenarioIndex) 
                        .then(function(downloadDialogVariableDataResponse) {
                            rowIndex++;
                            if (rowIndex < $('#scenarios-table tr').length) {
                                resolve(getSelectedScenarioResponses(rowIndex));
                            } else {
                                resolve(true);
                            }
                        });
                    });
                })
            } else {
                // advance to the next row in the scenarios table
                rowIndex++;
                if (rowIndex < $('#scenarios-table tr').length) {
                    resolve(getSelectedScenarioResponses(rowIndex));
                } else {
                    resolve(true);
                }
            }
        });   
    }
    function removeSelectedScenarioFolders() {
        var deletedRows = 0;

        $('#scenarios-table').find('tr').each(function () {
            var row = $(this);
            if (row.find('input[type="checkbox"]').is(':checked')) {
                $("#user-scenario-folder-pathname").val("");
                var rowIndex = parseInt($(this).attr('id').slice(2)) - deletedRows;
                deletedRows++;
                g_scenariosTableRows--;
                scenarioFolderPathnameID = 'scenario-folder-pathname-' + parseInt($(this).attr('id').slice(2));
                var scenarioFolderPathname = $(this).find("#" + scenarioFolderPathnameID).html();
                var id = $(this).attr('id');
                $(this).remove();
                removeScenarioFolder(scenarioFolderPathname);
            }
        });
    }
    function transferScenarioDefinitionToUserSessionsData(scenarioIndex) {
        uploadedFiles = g_ScenarioDefinitions[scenarioIndex].factors.uploadedFiles;
        uploadedDatabaseFiles = g_ScenarioDefinitions[scenarioIndex].factors.uploadedDatabaseFiles;
        addNewScenarioTableRow();
        g_loadingScenarioData = false;
    }
    function transferUserSessionDataToScenarioDefinition() {
        g_ScenarioDefinitions.push(g_scenarioDefinition);
        var scenarioIndex = g_ScenarioDefinitions.length - 1;
        g_ScenarioDefinitions[scenarioIndex].factors.uploadedFiles = uploadedFiles;
        g_ScenarioDefinitions[scenarioIndex].factors.uploadedDatabaseFiles = uploadedDatabaseFiles;
        g_ScenarioDefinitions[scenarioIndex].factors.modelPathname = $("#user-models").val();
        g_ScenarioDefinitions[scenarioIndex].factors.modelName = g_ScenarioDefinitions[scenarioIndex].factors.modelPathname.substring(g_ScenarioDefinitions[scenarioIndex].factors.modelPathname.lastIndexOf("\\") + 1);
        g_ScenarioDefinitions[scenarioIndex].factors.scenarioFolderPathname = $("#user-scenario-folder-pathname").val();
        g_ScenarioDefinitions[scenarioIndex].factors.scenarioName = $('#scenario-name').val();
        g_ScenarioDefinitions[scenarioIndex].factors.factorDatabasenames = [];
        g_ScenarioDefinitions[scenarioIndex].factors.factorTablenames = [];
        // database factors
        for (rowIndex=0;rowIndex<databaseInputsTableRows();rowIndex++) {
            g_ScenarioDefinitions[scenarioIndex].factors.factorDatabasenames.push($('#target-database-' + (rowIndex + 1)).val());
            g_ScenarioDefinitions[scenarioIndex].factors.factorTablenames.push($('#target-table-' + (rowIndex + 1)).val());
        }
        // dialog factors
        g_ScenarioDefinitions[scenarioIndex].factors.blockTypes = [];
        g_ScenarioDefinitions[scenarioIndex].factors.variableTypes = [];
        g_ScenarioDefinitions[scenarioIndex].factors.variableNames = [];
        g_ScenarioDefinitions[scenarioIndex].factors.variableValues = [];
        g_ScenarioDefinitions[scenarioIndex].factors.blockNumbers = [];

        for (rowIndex=0;rowIndex<dialogInputsTableRows();rowIndex++) {
            g_ScenarioDefinitions[scenarioIndex].factors.blockTypes.push($('#target-block-type-select-' + (rowIndex + 1)).val());
            g_ScenarioDefinitions[scenarioIndex].factors.variableTypes.push($('#target-variable-type-select-' + (rowIndex + 1)).val());            
            g_ScenarioDefinitions[scenarioIndex].factors.variableNames.push($('#target-variable-name-select-' + (rowIndex + 1)).val());
            g_ScenarioDefinitions[scenarioIndex].factors.variableValues.push($('#target-variable-value-' + (rowIndex + 1)).val());
            g_ScenarioDefinitions[scenarioIndex].factors.blockNumbers.push($('#target-block-number-select-' + (rowIndex + 1)).val());
        }
        //  Responses
        g_ScenarioDefinitions[scenarioIndex].responses.outputFiles = [];
        var outputFile = {};
        for (rowIndex=0;rowIndex<outputFileTableRows();rowIndex++) {
            outputFile = {};
            outputFile.folder = $("#output-folder-select-" + (rowIndex + 1)).val();
            outputFile.matchingFolderpattern = $("#scenario-output-folder-match-pattern-" + (rowIndex + 1)).val();
            outputFile.matchingFilePattern = $("#scenario-output-file-match-pattern-" + (rowIndex + 1)).val();
            g_ScenarioDefinitions[scenarioIndex].responses.outputFiles.push(outputFile);
        }
        g_ScenarioDefinitions[scenarioIndex].responses.responseDatabasenames = [];
        g_ScenarioDefinitions[scenarioIndex].responses.responseTablenames = [];
        for (rowIndex=0;rowIndex<databaseInputsTableRows();rowIndex++) {
            g_ScenarioDefinitions[scenarioIndex].responses.responseDatabasenames.push($('#source-database-' + (rowIndex + 1)).val());
            g_ScenarioDefinitions[scenarioIndex].responses.responseTablenames.push($('#source-table-' + (rowIndex + 1)).val());
        }

        g_ScenarioDefinitions[scenarioIndex].responses.blockTypes = [];
        g_ScenarioDefinitions[scenarioIndex].responses.variableTypes = [];
        g_ScenarioDefinitions[scenarioIndex].responses.variableNames = [];
        g_ScenarioDefinitions[scenarioIndex].responses.variableValues = [];
        g_ScenarioDefinitions[scenarioIndex].responses.blockNumbers = [];
        for (rowIndex=0;rowIndex<dialogOutputsTableRows();rowIndex++) {
            g_ScenarioDefinitions[scenarioIndex].responses.blockTypes.push($('#source-block-type-select-' + (rowIndex + 1)).val());
            g_ScenarioDefinitions[scenarioIndex].responses.variableTypes.push($('#source-variable-type-select-' + (rowIndex + 1)).val());            
            g_ScenarioDefinitions[scenarioIndex].responses.variableNames.push($('#source-variable-name-select-' + (rowIndex + 1)).val());
            g_ScenarioDefinitions[scenarioIndex].responses.variableValues.push($('#source-variable-value-' + (rowIndex + 1)).val());
            g_ScenarioDefinitions[scenarioIndex].responses.blockNumbers.push($('#source-block-number-select-' + (rowIndex + 1)).val());
        }

        addNewScenarioTableRow();
        return scenarioIndex;
    }
    function saveScenarioDefinition() {
        var scenarioIndex = transferUserSessionDataToScenarioDefinition();
        // save by index
        var blob = new Blob([JSON.stringify(g_ScenarioDefinitions[scenarioIndex])],
                { type: "text/plain;charset=utf-8" });
        saveAs(blob, $('#scenario-name').val() + '_scenarioData.txt');
        $('#scenarios-checkbox').prop('disabled', false);
        // $('#submit-scenarios-button').prop('disabled', false); 
        
    }

    function doesScenarioFolderExist() {
        if ($("#user-scenario-folder-pathname").val() === "") {
            return false;
        } else {
            return true;
        }
    }

    function validateUserInputs() {
        if (($("#username").val() === '') || ($("#password").val() === '') || (!ValidateIPaddress($("#ip-address").val()))) {
            //Check to see if there is any text entered
            // If there is no text within the input ten disable the button
            $('.buttons').prop('disabled', true);
        } else {
            //If there is text in the input, then enable the button
            IPaddress = "http://" + $("#ip-address").val();
            queryURL_root =  IPaddress + ":3001/api/";
            $('.buttons').prop('disabled', false);
            $('#create-scenario-folder-button').prop('disabled', true);
            $('#copy-model-to-scenario-folder').prop('disabled', true);
        }
    }

    function enableDisableUserLoginButton() {
        if (($("#username").val() === '') || ($("#password").val() === '') || (!ValidateIPaddress($("#ip-address").val()))) {
            $('#login-button').prop('disabled', true);
        } else {
            $('#login-button').prop('disabled', false);
        }
    }

    function updateButtonsState() {
        if ($("#scenario-name").val() !== '') {
            if ($('#user-models').val() !== null) {
                $('#create-scenario-folder-button').prop('disabled', false);
                $('.scenario-file-input-buttons').prop('disabled', false);
                $('.scenario-database-input-buttons').prop('disabled', false);
                $('.scenario-dialog-input-buttons').prop('disabled', false);
                $('#save-scenario-definition').prop('disabled', false);
                $('#scenario-factors-checkbox').prop('disabled', false);
                $('#scenario-responses-checkbox').prop('disabled', false);

                // if ($("#user-scenario-folder-pathname").val() !== "") {
                    $('.scenario-file-output-buttons').prop('disabled', false);    
                    $('.scenario-database-output-buttons').prop('disabled', false);
                    $('.scenario-dialog-output-buttons').prop('disabled', false);
                // }   
            }
        }
    }


    function ValidateIPaddress(inputText)
    {
        return /^(([1-9]?\d|1\d\d|2[0-4]\d|25[0-5])(\.(?!$)|(?=$))){4}$/.test(inputText||"");
    }    
    function displayFileContents() {
        var modalTable = $('#selected-file-contents-table');
        $(modalTable).empty();
        tableDataHtmlCode = '';
        tableDataHtmlCode += '<tr>';
        for (var i=0;i<g_fileDataArray[0].length;i++) {
            tableDataHtmlCode += '<th>Field ' + (i + 1) + '</th>';
        }
        g_fileDataArray.forEach(function(elements, index) {
            tableDataHtmlCode += '<tr>';
                for (var i=0;i<elements.length;i++) {
                    tableDataHtmlCode += '<td>' + elements[i] + '</td>';
                }
            // }
            tableDataHtmlCode += '</tr>';
        });
        $(modalTable).find("tr:not(:first)").remove();
        $(modalTable).append(tableDataHtmlCode); 
        $("#file-contents-modal").show();
        updateLoadingDivVisibility(false);
    }

    function displayTableContents(modelDatabaseTableFields) {
        var modalTable = $("#selected-database-outputs-table");
        $(modalTable).empty();
        g_tableSchema = modelDatabaseTableFields;
        tableDataHtmlCode = '';
        tableDataHtmlCode += '<tr>';
        for (var i=0;i<g_tableSchema.fields.length;i++) {
            tableDataHtmlCode += '<th>' + g_tableSchema.fields[i] + '</th>';
        }
        g_tableDataArray.forEach(function(elements, index) {
            tableDataHtmlCode += '<tr>';
                for (var i=0;i<elements.length;i++) {
                    tableDataHtmlCode += '<td>' + elements[i] + '</td>';
                }
            // }
            tableDataHtmlCode += '</tr>';
        });
        // $("#selected-database-outputs-table").empty(); 
        $(modalTable).find("tr:not(:first)").remove();
        $(modalTable).append(tableDataHtmlCode); 
        $('#modal-form-chart').hide();
        $("#database-table-modal").show();
        $('#modal-form-contents').show();
        updateLoadingDivVisibility(false);
    }
    function viewModalChart() {
        if (($('#modal-x-axis-field-select').val() !== '') && ($('#modal-x-axis-field-select').val() !== '')) {
            makeChartDataSeries(g_tableDataArray, g_tableSchema, $('#modal-x-axis-field-select').val(), $('#modal-y-axis-field-select').val())
            .then(function(response) {
                g_myModalChart.destroy();
                displayTableChart(g_chartData, $('#modal-x-axis-field-select').val(), $('#modal-y-axis-field-select').val(), $('#modal-y-axis-field-select').val() + ' vs ' + $('#modal-x-axis-field-select').val());
            });
        }
    }
    function displayTableChart(chartData, xAxislabel, yAxislabel, chartTitle) {
        if (g_modelChartCreated) {
            g_myModalChart.destroy();
        }
        g_myModalChart = new Chart($("#modal-form-chart"), {
            type: 'bar',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        // label: dataSetsLabel,
                        backgroundColor: 'rgb(255, 0, 0)',
                        // ["#3e95cd", "#8e5ea2","#3cba9f","#e8c3b9","#c45850", "#3e95cd", "#8e5ea2","#3cba9f","#e8c3b9","#c45850"],
                        data:  chartData.values
                    }
                ]
            },
            options: {
                legend: { display: false },
                title: {
                    display: true,
                    text: chartTitle,
                    fontSize: 23,
                    fontStyle: 'bold'
                },
                scales: {
                    xAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: xAxislabel,
                            fontSize: 18,
                            fontStyle: 'bold'
                        },   
                        barPercentage: 0.5                     
                    }],
                    yAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: yAxislabel,
                            fontSize: 18,
                            fontStyle: 'bold'
                        }, 
                        ticks: {
                            beginAtZero: true   
                        }                    
                    }]
                },
                responsive: true
            }
        });
        g_modelChartCreated = true;
    }
    function displayTableChartModal() {
        $("#database-table-modal").hide();
        $('#modal-form-chart').show();
        $('#modal-form-contents').hide();

        var charTypes = ['Bar chart'];
        $('#chart-type-select').append('<option value="Bar chart">Bar chart</option>');
        populateDropdownElement(g_tableSchema, $('#modal-x-axis-field-select'), false);
        populateDropdownElement(g_tableSchema, $('#modal-y-axis-field-select'), true);
        if (($('#modal-x-axis-field-select').val() !== '') && ($('#modal-x-axis-field-select').val() !== '')) {
            displayTableChart(g_chartData, $('#modal-x-axis-field-select').val(), $('#modal-y-axis-field-select').val(), $('#modal-y-axis-field-select').val() + ' vs ' + $('#modal-x-axis-field-select').val());
        }
        updateLoadingDivVisibility(false);
    }

    function showDatabaseTableChartModal() {
        $('#modal-form-chart').show();
        $('#modal-form-contents').hide();
    }
    function updateLoadingDivVisibility(show, textMessage) {
        if (show) {
            $('#load_screen').show();
            $('#loading').show();
            $('#loading').text(textMessage);
        } else {
            $('#load_screen').hide();
            $('#loading').hide();
        }
    }
    function populateScenarioFactorsSettings(scenarioIndex) {
        return new Promise((resolve, reject) => {
            var inputLabel = "";
            // set scenario DOM elements
            $('#scenario-name').val(g_ScenarioDefinitions[scenarioIndex].factors.scenarioName);
            $("#user-models").val(g_ScenarioDefinitions[scenarioIndex].factors.modelPathname);
            loadedScenarioModelpathname = $("#user-models").val();
            // $("#user-scenario-folder-pathname").val(g_ScenarioDefinitions[scenarioIndex].factors.scenarioFolderPathname);
            $("#user-scenario-folder-pathname").val('');
            updateButtonsState();
            addNewInputFilesTableRow(0, g_ScenarioDefinitions[scenarioIndex].factors.uploadedFiles.length)
            .then(function(response) {
                for (var i=0;i<g_ScenarioDefinitions[scenarioIndex].factors.uploadedFiles.length;i++) {
                    inputLabel = '#input-label-' + (i + 1);
                    updateInputLabel(inputLabel, g_ScenarioDefinitions[scenarioIndex].factors.uploadedFiles[i].name, 20);
                }
                addNewDatabaseInputsTableRow(0, g_ScenarioDefinitions[scenarioIndex].factors.uploadedDatabaseFiles.length, false)
                .then(function(response) {
                    var targetDatabase;
                    var targetTable;
                    for (var j=0;j<g_ScenarioDefinitions[scenarioIndex].factors.uploadedDatabaseFiles.length;j++) {
                        inputLabel = '#database-input-label-' + (j + 1);
                        updateInputLabel(inputLabel, g_ScenarioDefinitions[scenarioIndex].factors.uploadedDatabaseFiles[j].name, 20);
                        targetDatabase = '#target-database-' + (j + 1);
                        $(targetDatabase).val(g_ScenarioDefinitions[scenarioIndex].factors.factorDatabasenames[j]);
                        updateTargetTableList(j + 1);
                        targetTable = '#target-table-' + (j + 1);
                        $(targetTable).val(g_ScenarioDefinitions[scenarioIndex].factors.factorTablenames[j]);
                    }
                    addNewDialogInputsTableRow(0, g_ScenarioDefinitions[scenarioIndex].factors.variableNames.length, false)
                    .then(function(response) {
                        var selectValue;
                        var inputValue;
                        for (var k=0;k<g_ScenarioDefinitions[scenarioIndex].factors.variableNames.length;k++) {
                            selectValue = '#target-block-type-select-' + (k + 1);
                            $(selectValue).val(g_ScenarioDefinitions[scenarioIndex].factors.blockTypes[k]);
                            updateTargetBlockNumbersDropdown(k + 1);
                            selectValue = '#target-block-number-select-' + (k + 1);
                            $(selectValue).val(g_ScenarioDefinitions[scenarioIndex].factors.blockNumbers[k]);
                            updateTargetDialogVariableTypeDropdown(k + 1);
                            selectValue = '#target-variable-type-select-' + (k + 1);
                            $(selectValue).val(g_ScenarioDefinitions[scenarioIndex].factors.variableTypes[k]);
                            updateTargetDialogVariableDropdown(k + 1);  

                            selectValue = '#target-variable-name-select-' + (k + 1);
                            $(selectValue).val(g_ScenarioDefinitions[scenarioIndex].factors.variableNames[k]);

                            inputValue = '#target-variable-value-' + (k + 1);
                            $(inputValue).val(g_ScenarioDefinitions[scenarioIndex].factors.variableValues[k]);
                        }
                        resolve(true);
                    })
                    .catch(function(error) {
                        alert('Error returned from addNewDialogInputsTableRow');
                        reject(error);
                    })
                })
                .catch(function(error) {
                    alert('Error returned from addNewDatabaseInputsTableRow');              
                    reject(error);
                })
            })
            .catch(function(error) {
                alert('Error returned from addNewInputFilesTableRow');
                reject(error);
            })
        });
        // });
    }
    function populateScenarioResponsesSettings(scenarioIndex) {
        // updateModelInfo($("#user-models").val(), true)
        return new Promise((resolve, reject) => {
            // populate the factors input files table
            addNewOutputFilesTableRow(0, g_ScenarioDefinitions[scenarioIndex].responses.outputFiles.length)
            .then(function(response) {
                for (var rowIndex=0;rowIndex<g_ScenarioDefinitions[scenarioIndex].responses.outputFiles.length;rowIndex++) {
                    $("#output-folder-select-" + (rowIndex + 1)).val(g_ScenarioDefinitions[scenarioIndex].responses.outputFiles[rowIndex].folder);
                    $("#scenario-output-folder-match-pattern-" + (rowIndex + 1)).val(g_ScenarioDefinitions[scenarioIndex].responses.outputFiles[rowIndex].matchingFolderpattern);
                    $("#scenario-output-file-match-pattern-" + (rowIndex + 1)).val(g_ScenarioDefinitions[scenarioIndex].responses.outputFiles[rowIndex].matchingFilePattern);
                    if ($("#output-folder-select-" + (rowIndex + 1)).val() === c_ModelSubFoldersWithMatchingPattern_outputFolderOption) {
                        $("#scenario-output-folder-match-pattern-" + (rowIndex + 1)).show();
                    } else {
                        $("#scenario-output-folder-match-pattern-" + (rowIndex + 1)).hide();
                    }
                }
                addNewDatabaseOutputsTableRow(0, g_ScenarioDefinitions[scenarioIndex].responses.responseDatabasenames.length, false)
                .then(function(response) {
                    for (rowIndex=0;rowIndex<g_ScenarioDefinitions[scenarioIndex].responses.responseDatabasenames.length;rowIndex++) {
                        $('#source-database-' + (rowIndex + 1)).val(g_ScenarioDefinitions[scenarioIndex].responses.responseDatabasenames[rowIndex]);
                        updateSourceTableList(rowIndex + 1);
                        $('#source-table-' + (rowIndex + 1)).val(g_ScenarioDefinitions[scenarioIndex].responses.responseTablenames[rowIndex]);
                    }
                    addNewDialogOutputsTableRow(0, g_ScenarioDefinitions[scenarioIndex].responses.blockTypes.length, false)
                    .then(function(response) {
                        var selectValue;
                        var inputValue;
                        for (var rowIndex=0;rowIndex<g_ScenarioDefinitions[scenarioIndex].responses.blockTypes.length;rowIndex++) {
                            // block type
                            $('#source-block-type-select-' + (rowIndex + 1)).val(g_ScenarioDefinitions[scenarioIndex].responses.blockTypes[rowIndex]); 
                            updateSourceBlockNumbersDropdown(rowIndex + 1);
                            
                            // block number
                            $('#source-block-number-select-' + (rowIndex + 1)).val(g_ScenarioDefinitions[scenarioIndex].responses.blockNumbers[rowIndex]);
                            updateSourceDialogVariableTypeDropdown(rowIndex + 1);
                            
                            // variable type
                            $('#source-variable-type-select-' + (rowIndex + 1)).val(g_ScenarioDefinitions[scenarioIndex].responses.variableTypes[rowIndex]);
                            updateSourceDialogVariableDropdown(rowIndex + 1);  

                            // variable name
                            $('#source-variable-name-select-' + (rowIndex + 1)).val(g_ScenarioDefinitions[scenarioIndex].responses.variableNames[rowIndex]);                           
                            
                            // $('#source-variable-value-' + (rowIndex + 1)).val(g_ScenarioDefinitions[scenarioIndex].responses.variableValues[rowIndex]);
                        }
                        // transferScenarioDefinitionToUserSessionsData(scenarioIndex);
                        resolve(true);
                    })
                    .catch(function(error) {
                        alert('Error returned from addNewDialogInputsTableRow');
                        reject(error);
                    })
                })
                .catch(function(error) {
                    alert('Error returned from addNewDatabaseInputsTableRow');  
                    reject(error);            
                })
            })
            .catch(function(error) {
                alert('Error returned from addNewInputFilesTableRow');
                reject(error);
            })
        });
    }
    function initializeScenarioData() {
        initializeWebPage();
        g_loadingScenarioData = true;
        loadedScenarioModelpathname = '';
        // inputFileTableRows = 0;
        // databaseInputsTableRows = 0;
        numDatabaseFilesUploaded = 0;
        loadedScenarioModelpathname = '';   //  force a query to the server to get the loaded model's data
    }
    function loadScenarioDefinition(event) {
        g_loadingScenarioData = true;
        loadedScenarioModelpathname = '';
        var files = $("#" + event.target.id)[0].files;
        initializeWebPage();
        // inputFileTableRows = 0;
        // databaseInputsTableRows = 0;
        numDatabaseFilesUploaded = 0;
        loadedScenarioModelpathname = '';   //  force a query to the server to get the loaded model's data
        if (files) {
            [].forEach.call(files, readAndPreviewScenarioDefinitionFile);
        }
        $('#scenarios-checkbox').prop('disabled', false);
        $('#load-scenario-definition').val("");
        // $('#submit-scenarios-button').prop('disabled', false); 
    }
    function getCurrentTime() {
        var today = new Date();
        var date = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate();
        var time = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
        var dateTime = date+' '+time;
        return dateTime;
    }
    function initializeScenarioRunDetails(scenarioIndex) {
        g_ScenarioDefinitions[scenarioIndex].scenarioRunDetails = {
            ID: c_undefined_scenarioID,
            modelPath: g_ScenarioDefinitions[scenarioIndex].factors.modelPathname,
            runButtonName: "",
            blockNumber: -1,
            quitExtendSim: true,
            quitExcel: false,
            submissionTime: c_undefined_ScenarioDetailsTime,
            startTime: c_undefined_ScenarioDetailsTime,
            completionTime: c_undefined_ScenarioDetailsTime,
            currentSimulationTime: c_undefined_ScenarioDetailsTime,
            endSimulationTime: c_undefined_ScenarioDetailsTime,
            runNumber: -1,
            Aborted: false        
        }
    }
    function readAndPreviewScenarioDefinitionFile(file) {
        return new Promise((resolve, reject) => {
            var reader  = new FileReader();
            reader.onload = function(event) {
                g_ScenarioDefinitions.push(g_scenarioDefinition);
                var scenarioIndex = g_ScenarioDefinitions.length - 1;
                g_ScenarioDefinitions[scenarioIndex] = JSON.parse(event.target.result);
                initializeScenarioRunDetails(scenarioIndex);
                updateModelInfo(g_ScenarioDefinitions[scenarioIndex].factors.modelPathname, true)
                .then(function(response) {
                    populateScenarioFactorsSettings(scenarioIndex)
                    .then(function(response) {
                        populateScenarioResponsesSettings(scenarioIndex)
                        .then(function(response) {
                            transferScenarioDefinitionToUserSessionsData(scenarioIndex);
                            resolve(true);
                        })
                    })
                });
            }
            if (file) {
                console.log(file);
                reader.readAsText(file);
            }
        });
    }
    function databasefilesSelected(event) {
        var fileList = event.target.files
        var files = $("#" + event.target.id)[0].files;
        if (files) {
            readAndPreviewDatabaseInputFile(fileList[0], event.target.id);
            // [].forEach.call(files, readAndPreviewDatabaseInputFile(fileList[0], event.target.id));
        }
        enableDisableUploadFilesToDatabaseTablesButton();    
    }
    function inputFilesSelected(event) {
        var fileList = event.target.files
        var files = $("#" + event.target.id)[0].files;
        if (files) {
            readAndPreviewInputFile(fileList[0], event.target.id);
        }
        enableDisableUploadFilesButton();
    }
    String.prototype.width = function(font) {
        var f = font || '12px arial',
            o = $('<div>' + this + '</div>')
                    .css({'position': 'absolute', 'float': 'left', 'white-space': 'nowrap', 'visibility': 'hidden', 'font': f})
                    .appendTo($('body')),
            w = o.width();

        o.remove();

        return w;
    }
    function updateInputLabel(inputLabel, inputValue, padding) {
        $(inputLabel).val(inputValue);
        var inputWidth = $(inputLabel).val().width($(inputLabel).css( "fontSize" ) + " arial");
        $(inputLabel).css({
            width: inputWidth + padding
        })
    }
    function ab2str(buf) {
        return String.fromCharCode.apply(null, new Uint8Array(buf));
    }
    function uploadModelFile() {
        
    }
    function Decodeuint8arr(uint8array){
        return new TextDecoder("utf-8").decode(uint8array);
    }
    function readAndPreviewUserModelFile(file) {
        return new Promise((resolve, reject) => {
            var reader  = new FileReader();
            var data = new FormData();

            reader.onload = function(event) {
                var contents = event.target.result;
                console.log('Contents=' + contents);
                var binary = "";
                var bytes = new Uint8Array(contents);
                var length = bytes.byteLength;
                for (var i = 0; i < length; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                var binaryString = Decodeuint8arr(bytes);

                console.log('File data=' + binaryString);
                g_uploadedUserModelFile.data = binary;
                g_uploadedUserModelFile.arrayBuffer = bytes;
                uploadUserModelToServer()
                .then(function(response) {
                    getUserModelPaths()
                    .then(function(getUserModelPathsResponse) {
                        updateLoadingDivVisibility(false);
                        resolve(true);
                    });
                });
            };
            if (file) {
                console.log(file);
                g_uploadedUserModelFile.name = file.name;
                reader.readAsArrayBuffer(file);
            }
        });
    }
    function readAndPreviewUserExcelFile(file) {
        return new Promise((resolve, reject) => {
            var reader  = new FileReader();
            var data = new FormData();

            reader.onload = function(event) {
                var contents = event.target.result;
                console.log('Contents=' + contents);
                var binary = "";
                var bytes = new Uint8Array(contents);
                var length = bytes.byteLength;
                for (var i = 0; i < length; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                var binaryString = Decodeuint8arr(bytes);

                console.log('File data=' + binaryString);
                g_uploadedUserModelFile.data = binary;
                g_uploadedUserModelFile.arrayBuffer = bytes;
                uploadUserModelToServer()
                .then(function(response) {
                    getUserModelPaths()
                    .then(function(getUserModelPathsResponse) {
                        updateLoadingDivVisibility(false);
                        resolve(true);
                    });
                });
            };
            if (file) {
                console.log(file);
                g_uploadedUserModelFile.name = file.name;
                reader.readAsArrayBuffer(file);
            }
        });
    }
    
    function readAndPreviewInputFile(file, id) {
        var fileIndex = Number(id.substring(id.lastIndexOf("-") + 1)) - 1;
        var reader  = new FileReader();
        reader.onload = function(event) {
            var contents = event.target.result;
            var inputLabel = '#input-label-' + (fileIndex + 1);
            updateInputLabel(inputLabel, file.name, 20);
            if (file.name.indexOf('.xls') > 0) {
                var binary = "";
                var bytes = new Uint8Array(contents);
                var length = bytes.byteLength;
                for (var i = 0; i < length; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                uploadedFiles[fileIndex].data = binary;
            } else {
                uploadedFiles[fileIndex].data = contents;
            }
        };

        if (file) {
            console.log(file);
            uploadedFiles.push({ name: file.name });
            selectedFiles.push(file);
            if (file.name.indexOf('.xls') > 0) {
                reader.readAsArrayBuffer(file);
            } else {
                reader.readAsText(file);
            }
        }
    }
    function readAndPreviewDatabaseInputFile(file, id) {
        var rowIndex = Number(id.substring(id.lastIndexOf("-") + 1));
        var reader  = new FileReader();
        reader.onload = function(event) {
            var contents = event.target.result;
            uploadedDatabaseFiles[rowIndex - 1].data = contents;
            var inputLabel = '#database-input-label-' + rowIndex;
            updateInputLabel(inputLabel, file.name, 20);
        };

        if (file) {
            uploadedDatabaseFiles.push({ name: file.name });
            selectedDatabaseFiles.push(file);
            reader.readAsText(file);
        }
    }
    function enableDisableUploadFilesButton() {
        if (selectedFiles.length === 0)  {
            $('.upload-files-button').prop('disabled', true);
        }
        else {
            $('.upload-files-button').prop('disabled', false);
        }
    }
    function enableDisableUploadFilesToDatabaseTablesButton() {
        if (selectedDatabaseFiles.length === 0)  {
            $('.upload-database-inputs-button').prop('disabled', true);
        }
        else {
            $('.upload-database-inputs-button').prop('disabled', false);
        }
    }
    function enableDisableCopyModelToScenarioFolderButton() {
        const scenarioFolderPathname = $("#user-scenario-folder-pathname").val();
        const userModelPathname = $("#user-models").val();
    }
    function areScenarioDefinitionChildredChecked() {
        if ($('#scenario-factors-checkbox'). prop("checked") == true) {
            return true;
        } else if ($('#scenario-responses-checkbox'). prop("checked") == true) {
            return true;
        } else if ($('#scenario-setup-checkbox'). prop("checked") == true) {
            return true;
        } else {
            return false;
        }
    }
    function uploadUserModelFile(file) {
        return new Promise((resolve, reject) => {
            var files = $("#" + event.target.id)[0].files;
            if (files) {
                [].forEach.call(files, readAndPreviewUserModelFile);
            }
            resolve(true);
        });
    }
    function updateDOMelementVisibility(DOMelementIDname) {
        if ($('#' + DOMelementIDname + '-checkbox').prop("checked") == true) {
            $('#' + DOMelementIDname + '-body').show();
            // $('#' + DOMelementIDname).width('auto');
            if (DOMelementIDname === "scenario-user-login") {
                // $('#' + DOMelementIDname).width('70%');

            } else if (DOMelementIDname === "scenario-definition") {
                $("#scenario-factors").show();
                $('#scenario-responses').show();
                // if (areScenarioDefinitionChildredChecked()) {
                //     $('#' + DOMelementIDname).width('70%');
                // } else {
                //     $('#' + DOMelementIDname).width('50%');
                // }
            } else if (DOMelementIDname === "scenarios") {
                // $('#' + DOMelementIDname).width('70%');
            } else if (DOMelementIDname === "scenario-database-inputs") {
                // $('#scenario-definition').width('70%');
            } else if (DOMelementIDname === "scenario-dialog-inputs") {
                // $('#scenario-factors').width('70%');
            } else if (DOMelementIDname === "scenario-database-outputs") {
                // $('#scenario-definition').width('70%');
            } else if (DOMelementIDname === "scenario-dialog-outputs") {
                // $('#scenario-definition').width('70%');
            }
        } else {
            $('#' + DOMelementIDname + '-body').hide();
            $('#' + DOMelementIDname).width('25%');
            if (DOMelementIDname === "scenario-definition") {
                $("#scenario-factors").hide();
                $('#scenario-responses').hide();
            } if ($('#scenario-definition-checkbox'). prop("checked") == true) {
                if (DOMelementIDname === "scenario-factors") {
                    // if ($('#scenario-responses-checkbox'). prop("checked") == false)
                        // $('#scenario-definition').width('70%');
                } else if (DOMelementIDname === "scenario-responses") {
                    // if ($('#scenario-factors-checkbox'). prop("checked") == false)
                        // $('#scenario-definition').width('70%');
                }
            }
        }
    }

    function addNewInputFilesTableRow(rowIndex, numRows) {
        return new Promise((resolve, reject) => {
            var table = $("#file-inputs-table");
            var myID = 'input-button-' + (rowIndex + 1);
            var myLabelID = 'input-label-' + (rowIndex + 1);
            var $myID = "'#" + myID + "'";
            var newrow = '<tr><td><button onclick="$(' + $myID + ').click()">Upload file</button><input type="file" style="display: none" onchange="inputFilesSelected(event)" class="input-file-row" id="' + myID + '"><input type="text" class="input-label" id="' + myLabelID + '" readonly></td></tr>';
            table.append(newrow);
            rowIndex++;
            if (rowIndex < numRows) {
                resolve(addNewInputFilesTableRow(rowIndex, numRows));
            } else {
                resolve(rowIndex);
            }
        });
    }
    function deleteInputFilesTableRow(event) {
        $("#file-inputs-table tr:last").remove();
        uploadedFiles.pop();
    }
    function isSelectedScenarioModelLoaded() {
        if (loadedScenarioModelpathname !== getModelPathname()) {
            return false;
        } else {
            return true;
        }
    }
    function respondToUserModelSelection() {
        // clear tables
        clearTableData();
        // clear scenario pathname
        $("#user-scenario-folder-pathname").val("");
        // update state of web page DOM elements
        updateButtonsState();
    }
    function getModelPathname() {
        // if (g_loadingScenarioData) {
        var modelPathname = $("#user-models").val();
        // } else {
        //     var modelName =  $("#user-models").val();
        //     modelName = modelName.substring(modelName.lastIndexOf("\\") + 1);
        //     var modelPathname = $("#user-scenario-folder-pathname").val() + '\\' + modelName;
        // }
        return modelPathname;
    }
    function inputFileTableRows() {
        return ($('#file-inputs-table tr').length - 1);
    }
    function outputFileTableRows() {
        return ($('#file-outputs-table tr').length - 1);
    }
    function databaseInputsTableRows() {
        return ($('#database-inputs-table tr').length - 1);
    }
    function dialogInputsTableRows() {
        return ($('#dialog-inputs-table tr').length - 1);
    }
    function dialogOutputsTableRows() {
        return ($('#dialog-outputs-table tr').length - 1);
    }
    function databaseOutputsTableRows() {
        return ($('#database-outputs-table tr').length - 1);
    }
    function createDatabaseInputsTableRow(rowIndex, numRows) {
        return new Promise((resolve, reject) => {
            // if (rowIndex < numRows) {
                var table = $("#database-inputs-table");
                var myID = 'database-input-button-' + (rowIndex + 1);
                var myLabelID = 'database-input-label-' + (rowIndex + 1);
                var $myID = "'#" + myID + "'";
                var newrow = 
                '<tr><td><button onclick="$(' + $myID + ').click()">Upload file</button><input type="file" id="' + myID + '" style="display: none" onchange="databasefilesSelected(event)" class="input-file-row"><input type="text" class="input-label" id="' + myLabelID + '" readonly></td><td><select onchange="updateTargetTableSelect(event)" id="target-database-' + (rowIndex + 1) + '"></select></td><td><select id="target-table-' + (rowIndex + 1) + '"></select></td></tr>'
                table.append(newrow);
                var targetDatabase = '#target-database-' + (rowIndex + 1);
                for (var i = 0; i < modelDatabases.length; i++) {
                    $(targetDatabase).append('<option value="' + modelDatabases[i].name + '">' + modelDatabases[i].name + '</option>');
                }
                if (modelDatabases.length > 0) {
                    $(targetDatabase).val(modelDatabases[0].name);
                }
                var targetTable = '#target-table-' + (rowIndex + 1);
                for (var i = 0; i < modelDatabases[0].tableNames.length; i++) {
                    $(targetTable).append('<option value="' + modelDatabases[0].tableNames[i] + '">' + modelDatabases[0].tableNames[i] + '</option>');
                }
                if (modelDatabases[0].tableNames.length > 0) {
                    $(targetTable).val(modelDatabases[0].tableNames[0]);
                }
                rowIndex++;
                if (rowIndex < numRows) {
                    resolve(createDatabaseInputsTableRow(rowIndex, numRows));
                } else {
                    resolve(true);
                }
            // } else {
            //     resolve(true);               
            // }
        });
    }
    function addNewDatabaseInputsTableRow(startRowIndex, numRows , clearTableDataFlag) {
        return new Promise((resolve, reject) => {
            if (!isSelectedScenarioModelLoaded()) {
                updateModelInfo($("#user-models").val(), true)
                .then(function(response) {
                    createDatabaseInputsTableRow(startRowIndex, numRows)
                    .then(function(response) {
                        resolve(true);
                    })
                    .catch(function(error) {
                        reject(error);
                    })
                })
            } else {
                createDatabaseInputsTableRow(startRowIndex, numRows)
                .then(function(response) {
                    resolve(true);
                })
                .catch(function(error) {
                    reject(error);
                })
            }
            // }         
        });
    }

    function deleteDatabaseInputsTableRow(event) {
        // if (databaseInputsTableRows > 0) {
        //     databaseInputsTableRows--;
        // }
        $("#database-inputs-table tr:last").remove();  
        uploadedDatabaseFiles.pop();
    }
    
    function createDialogInputsTableRow(rowIndex, numRows) {
        return new Promise((resolve, reject) => {
            // if (rowIndex < numRows) {
                var table = $("#dialog-inputs-table");
                // dialogInputsTableRows++;
                var newrow = 
                // '<tr><td><select id="target-block-type-select-' + (rowIndex + 1) + '" onchange="targetBlockTypeSelected(event)"></select></td><td><select id="target-block-number-select-' + (rowIndex + 1) + '" onchange="targetBlockNumberSelected(event)"></select></td><td><select id="target-variable-type-select-' + (rowIndex + 1) + '" onchange="targetDialogVariableTypeSelected(event)"></select></td><td><select id="target-variable-name-select-' + (rowIndex + 1) + '" onchange="targetDialogVariableSelected(event)"></select></td><td><input type="text" id="target-variable-value-' + (rowIndex + 1) + '"></input></td></tr>'     
                // '<tr><td><select id="target-block-type-select-' + dialogInputsTableRows + '" onchange="targetBlockTypeSelected(event)"></select></td><td><select id="target-block-number-select-' + dialogInputsTableRows + '" onchange="targetBlockNumberSelected(event)"></select></td><td><select id="target-variable-type-select-' + dialogInputsTableRows + '" onchange="targetDialogVariableTypeSelected(event)"></select></td><td><select id="target-variable-name-select-' + dialogInputsTableRows + '" onchange="targetDialogVariableSelected(event)"></select></td><td><input type="text" id="target-variable-value-' + dialogInputsTableRows + '"></input></td></tr>'     
                '<tr><td><select id="target-block-type-select-' + (rowIndex + 1) + '" onchange="targetBlockTypeSelected(event)"></select></td><td><select id="target-block-number-select-' + (rowIndex + 1) + '" onchange="targetBlockNumberSelected(event)"></select></td><td><select id="target-variable-type-select-' + (rowIndex + 1) + '" onchange="targetDialogVariableTypeSelected(event)"></select></td><td><select id="target-variable-name-select-' + (rowIndex + 1) + '" onchange="targetDialogVariableSelected(event)"></select></td><td><input type="text" id="target-variable-value-' + (rowIndex + 1) + '"></input></td></tr>'     
                table.append(newrow);
                // var blockType = '#target-block-type-select-' + dialogInputsTableRows;
                var blockType = '#target-block-type-select-' + (rowIndex + 1);
                for (var i = 0; i < modelBlocks.length; i++) {
                    $(blockType).append('<option value="' + modelBlocks[i] + '">' + modelBlocks[i] + '</option>');
                }
                if (modelBlocks.length > 0) {
                    $(blockType).val(modelBlocks[0]);
                    // var blockNumber = '#target-block-number-select-' + dialogInputsTableRows;
                    var blockNumber = '#target-block-number-select-' + (rowIndex + 1);
                    updateTargetBlockNumbersDropdown((rowIndex + 1));
                    updateTargetDialogVariableTypeDropdown((rowIndex + 1));
                    // updateTargetBlockNumbersDropdown(dialogInputsTableRows);
                    // updateTargetDialogVariableTypeDropdown(dialogInputsTableRows);
                }
                rowIndex++;
                if (rowIndex < numRows) {
                    resolve(createDialogInputsTableRow(rowIndex, numRows));
                } else {
                    resolve(true);
                }
        // }
        });
    }
    function addNewDialogInputsTableRow(startRowIndex, numRows , clearTableDataFlag) {
        return new Promise((resolve, reject) => {
            if (!isSelectedScenarioModelLoaded()) {
                updateModelInfo($("#user-models").val(), true)
                .then(function(response) {
                    createDialogInputsTableRow(startRowIndex, numRows)
                    .then(function(response) {
                        resolve(true);
                    })
                    .catch(function(error) {
                        reject(error);
                    })
                })
            } else {
                createDialogInputsTableRow(startRowIndex, numRows)
                .then(function(response) {
                    resolve(true);
                })
                .catch(function(error) {
                    reject(error);
                })
            }
            // }         
        });
    }
    function deleteDialogInputsTableRow(event) {
        // if (dialogInputsTableRows > 0) {
        //     dialogInputsTableRows--;
        // }
        $("#dialog-inputs-table tr:last").remove();  
    }

    function createDialogOutputsTableRow(rowIndex) {
        return new Promise((resolve, reject) => {
            var table = $("#dialog-outputs-table");
            var newrow = 
            '<tr><td><select id="source-block-type-select-' + (rowIndex + 1) + '" onchange="sourceBlockTypeSelected(event)"></select></td><td><select id="source-block-number-select-' + (rowIndex + 1) + '" onchange="sourceBlockNumberSelected(event)"></select></td><td><select id="source-variable-type-select-' + (rowIndex + 1) + '" onchange="sourceDialogVariableTypeSelected(event)"></select></td><td><select id="source-variable-name-select-' + (rowIndex + 1) + '" onchange="sourceDialogVariableSelected(event)"></select></td><td><input type="text" id="source-variable-value-' + (rowIndex + 1) + '"></input></td></tr>'     
            table.append(newrow);
            var blockType = '#source-block-type-select-' + (rowIndex + 1);
            for (var i = 0; i < modelBlocks.length; i++) {
                $(blockType).append('<option value="' + modelBlocks[i] + '">' + modelBlocks[i] + '</option>');
            }
            if (modelBlocks.length > 0) {
                $(blockType).val(modelBlocks[0]);
                var blockNumber = '#source-block-number-select-' + (rowIndex + 1);
                updateSourceBlockNumbersDropdown((rowIndex + 1));
                updateSourceDialogVariableTypeDropdown((rowIndex + 1));
                resolve(true);
            } else {
            //  ATTENTION: This logic needs to be completed
                resolve(true);
            }
        });
    }
    function addNewDialogOutputsTableRow(rowIndex, numRows, clearTableDataFlag) {
        return new Promise((resolve, reject) => {
            if (!isSelectedScenarioModelLoaded()) {
                updateModelInfo($("#user-models").val(), true)
                .then(function(response) {
                    createDialogOutputsTableRow(rowIndex)
                    .then(function(response) {
                        rowIndex++;
                        if (rowIndex < numRows) {
                            resolve(addNewDialogOutputsTableRow(rowIndex, numRows));
                        } else {
                            resolve(response);
                        }
                    })
                })
                .catch(function(error) {
                    reject(error);
                })
            } else {
                createDialogOutputsTableRow(rowIndex)
                .then(function(response) {
                    rowIndex++;
                    if (rowIndex < numRows) {
                        resolve(addNewDialogOutputsTableRow(rowIndex, numRows));
                    } else {
                        resolve(response);
                    }
                })
            }
        });
    }

    function deleteDialogOutputsTableRow(event) {
        // if (dialogOutputsTableRows > 0) {
        //     dialogOutputsTableRows--;
        // }
        $("#dialog-inputs-table tr:last").remove();  
    }
    function createDatabaseOutputsTableRow(rowIndex) {
        return new Promise((resolve, reject) => {
            var table = $("#database-outputs-table");
            // databaseOutputsTableRows++;
            var newrow = 
            '<tr><td><select onchange="updateSourceTableSelect(event)" id="source-database-' + (rowIndex + 1) + '"></select></td><td><select id="source-table-' + (rowIndex + 1) + '"></select></td><td><button class="scenario-database-output-buttons" id="view-source-database-table-' + (rowIndex + 1) + '" onclick="openDatabaseTableContentsModal(event)">View data</button></td><td><button class="scenario-database-output-buttons" id="view-source-database-table-chart-' + (rowIndex + 1) + '" onclick="openViewDatabaseTableChartModal(event)">View chart</button></td><td><button class="scenario-database-output-buttons" id="export-source-database-table-' + (rowIndex + 1) + '" onClick="exportScenarioModelTableToTextFile(event)">Export data</button></td></tr>'
            table.append(newrow);
            var sourceDatabase = '#source-database-' + (rowIndex + 1);
            for (var i = 0; i < modelDatabases.length; i++) {
                $(sourceDatabase).append('<option value="' + modelDatabases[i].name + '">' + modelDatabases[i].name + '</option>');
            }
            if (modelDatabases.length > 0) {
                $(sourceDatabase).val(modelDatabases[0].name);
            }
            var sourceTable = '#source-table-' + (rowIndex + 1);
            for (var i = 0; i < modelDatabases[0].tableNames.length; i++) {
                $(sourceTable).append('<option value="' + modelDatabases[0].tableNames[i] + '">' + modelDatabases[0].tableNames[i] + '</option>');
            }
            if (modelDatabases[0].tableNames.length > 0) {
                $(sourceTable).val(modelDatabases[0].tableNames[0]);
            }
            resolve(true);
        });
    }
    function addNewDatabaseOutputsTableRow(rowIndex, numRows, clearTableDataFlag) {
        return new Promise((resolve, reject) => {
            if (!isSelectedScenarioModelLoaded()) {
                updateModelInfo($("#user-models").val(), true)
                .then(function(response) {
                    createDatabaseOutputsTableRow(rowIndex)
                    .then(function(response) {
                        rowIndex++;
                        if (rowIndex < numRows) {
                            resolve(addNewDatabaseOutputsTableRow(rowIndex, numRows));
                        } else {
                            resolve(response);
                        }
                    })
                })
                .catch(function(error) {
                    reject(error);
                })
            } else {
                createDatabaseOutputsTableRow(rowIndex)
                .then(function(response) {
                    rowIndex++;
                    if (rowIndex < numRows) {
                        resolve(addNewDatabaseOutputsTableRow(rowIndex, numRows));
                    } else {
                        resolve(response);
                    }
                })
            }        
        });      
    }
    function outputFolderSelected(event) {
        var rowIndex = getRowIndexFromTableRowId(event.target.id);
        var thisId = $('#output-folder-select-' + rowIndex);
        if ($(thisId).val() === "Model sub-folders with matching pattern") {
            $("#scenario-output-folder-match-pattern-" + rowIndex).show();
        } else {
            $("#scenario-output-folder-match-pattern-" + rowIndex).hide();
        }
    } 
    function createOutputsFileTableRow(rowIndex) {
        return new Promise((resolve, reject) => {
            var table = $("#file-outputs-table");
            // outputFileTableRows++;
            var newrow = '<tr><td><select class="output-file-row" onchange="outputFolderSelected(event)" id="output-folder-select-' + (rowIndex + 1) + '"></td><td style="text-align: center"><input type="text" rows="1" value=" " class="text-area" id="scenario-output-folder-match-pattern-' + (rowIndex + 1) + '"></input></td><td style="text-align: center"><input type="text" rows="1" value=" " class="text-area" id="scenario-output-file-match-pattern-' + (rowIndex + 1) + '"></td><td><button id="view-source-file-' + (rowIndex + 1) + '" onclick="openFileContentsModal(event)">Get files</button></td></tr>';
            table.append(newrow);
            $("#scenario-output-folder-match-pattern-" + (rowIndex + 1)).hide();
            var outputFoldersSelect = $('#output-folder-select-' + (rowIndex + 1));
            $(outputFoldersSelect).empty(0);
            $(outputFoldersSelect).append('<option value="' + c_ModelFolder_outputFolderOption + '">Model folder</option>');
            $(outputFoldersSelect).append('<option value="' + c_AllModelSubFolders_outputFolderOption + '">All model sub-folders</option>');
            $(outputFoldersSelect).append('<option value="' + c_ModelSubFoldersWithMatchingPattern_outputFolderOption + '">Model sub-folders with matching pattern</option>');
            if (scenarioFolderFiles.length > 0) {
                $(outputFilesSelect).val(scenarioFolderFiles[0].OriginalPath);
                $(outputFilesSelect).prop('selectedIndex', 0);
            }
            resolve(true);
        });
            // })
        // } else {
        //     var newrow = '<tr><td><select onchange="outputFilesSelected(event)" class="output-file-row" id="output-file-select-' + outputFileTableRows + '"></td></tr>';
        //     table.append(newrow);
        // }
    }
    function clearScenarioTables() {
        var table = $("#scenarios-table");
    }
    function addNewOutputFilesTableRow(rowIndex, numRows) {
        return new Promise((resolve, reject) => {
            if (!isSelectedScenarioModelLoaded()) {
                updateModelInfo($("#user-models").val(), true)
                .then(function(response) {
                    createOutputsFileTableRow(rowIndex)
                    .then(function(response) {
                        rowIndex++;
                        if (rowIndex < numRows) {
                            resolve(addNewOutputFilesTableRow(rowIndex, numRows));
                        } else {
                            resolve(true);
                        }
                    })
                    .catch(function(error) {
                        reject(error);
                    })
                })
            } else {
                createOutputsFileTableRow(rowIndex)
                .then(function(response) {
                    rowIndex++;
                    if (rowIndex < numRows) {
                        resolve(addNewOutputFilesTableRow(rowIndex, numRows));
                    } else {
                        resolve(true);
                    }
                })
            }
        });
    }
    function deleteOutputFilesTableRow(event) {
        // if (outputFileTableRows > 0) {
        //     outputFileTableRows--;
        // }
        $("#file-outputs-table tr:last").remove();
    }
    function areScenariosSelected() {
        if (getNumScenariosSelected() > 0) {
            return true;
        } else {
            return false;
        }
    }
    function scenarioSelected(event) {
        $('#run-selected-scenarios-button').prop('disabled', !areScenariosSelected()); 
        $('#remove-selected-scenario-folders-button').prop('disabled', !areScenariosSelected());
        $('#get-selected-scenario-responses-button').prop('disabled', !areScenariosSelected());
    }
    function addNewScenarioTableRow() {
        var table = $("#scenarios-table");
        g_scenariosTableRows++;
        var newrow = 
        '<tr class="scenarios-table-row" id="scenario-index-' + g_scenariosTableRows + '" onclick="scenarioSelected(event)"><td class="table-checkboxes"><input id="scenario-selection-' + g_scenariosTableRows + '" type="checkbox"></td><td nowrap id="scenario-id-' + g_scenariosTableRows + '">' + $("#scenario-id").val() + '</td><td nowrap id="scenario-name-' + g_scenariosTableRows + '">' + $("#scenario-name").val() + '</td><td style="text-align: center"><input type="text" rows="1" value="1" class="text-area" id="scenario-repetitions-' + g_scenariosTableRows + '"></input></td><td nowrap id="scenario-status-' + g_scenariosTableRows + '">' + scenarioStatusValues[0] + '</td><td nowrap class="percentage-value" id="scenario-progress-' + g_scenariosTableRows + '"><progress id="scenario-progress-bar-' + g_scenariosTableRows + '" value="0" max="100"></progress><div id="scenario-progress-value-' + g_scenariosTableRows + '">0%</div></td><td nowrap id="scenario-folder-pathname-' + g_scenariosTableRows + '">' + $("#user-scenario-folder-pathname").val() + '</td></tr>'
        table.append(newrow);
        $('#scenarios-table-body').width('90%');
    }
    function updateTargetTableList(rowIndex) {
        var targetDatabase = '#target-database-' + rowIndex;
        var matchindex = modelDatabases.findIndex(x => x.name === $(targetDatabase).val());
        if (matchindex >= 0) {
            var targetTable = '#target-table-' + rowIndex;
            $(targetTable).empty();
            for (var i = 0; i < modelDatabases[matchindex].tableNames.length; i++) {
                $(targetTable).append('<option value="' + modelDatabases[matchindex].tableNames[i] + '">' + modelDatabases[matchindex].tableNames[i] + '</option>');
            }
            if (modelDatabases[matchindex].tableNames.length > 0) {
                $(targetTable).val(modelDatabases[matchindex].tableNames[0]);
            }
        }
    }     
    function updateTargetTableSelect(event) {
        var rowIndex = getRowIndexFromTableRowId(event.target.id);
        updateTargetTableList(rowIndex);
    }
    function updateSourceTableList(rowIndex) {
    var sourceDatabase = '#source-database-' + rowIndex;
        var matchindex = modelDatabases.findIndex(x => x.name === $(sourceDatabase).val());
        if (matchindex >= 0) {
            var sourceTable = '#source-table-' + rowIndex;
            $(sourceTable).empty();
            for (var i = 0; i < modelDatabases[matchindex].tableNames.length; i++) {
                $(sourceTable).append('<option value="' + modelDatabases[matchindex].tableNames[i] + '">' + modelDatabases[matchindex].tableNames[i] + '</option>');
            }
            if (modelDatabases[matchindex].tableNames.length > 0) {
                $(sourceTable).val(modelDatabases[matchindex].tableNames[0]);
            }
        }
    }
    function updateSourceTableSelect(event) {
        var rowIndex = getRowIndexFromTableRowId(event.target.id);
        updateSourceTableList(rowIndex);
    }

    function deleteDatabaseOutputsTableRow(event) {
        // if (databaseOutputsTableRows > 0) {
        //     databaseOutputsTableRows--;
        // }
        $("#database-outputs-table tr:last").remove();  
    }

    function openViewDatabaseTableContentsForm() {
        
    }
    function closeFileContentsModal() {
        $("#file-contents-modal").hide();
    }
    function closeDatabaseTableContentsModal() {
        $("#database-table-modal").hide();
    }
    function openFileContentsModal(event) {
        // var index = event.target.id.lastIndexOf('-') + 1;
        // var rowIndex = event.target.id.substring(index);
        var rowIndex = getRowIndexFromTableRowId(event.target.id);
        var outputFileSelect = $('#output-file-select-' + rowIndex);
        var filepath =  $(outputFileSelect).val();
        getServerFile(filepath)
        .then(function(response) {
            console.log(JSON.stringify(response.data.result));
            var fileData  = response.data.result;
            g_fileDataArray = fileData.split('\r\n').map(function(ln){
                return ln.split('\t');
            });
            // Remove last empty element from array
            g_fileDataArray.pop();

            $('#selected-file-name').val(filepath.substring(filepath.lastIndexOf("\\") + 1));
            displayFileContents();
            updateLoadingDivVisibility(false);
            $("#file-contents-modal").show();
        })
    }
    function getRowIndexFromTableRowId(tableRowId) {
        var index = tableRowId.lastIndexOf('-') + 1;
        var rowIndex = tableRowId.substring(index);
        return rowIndex;
    }
    function buildDatabaseTableContentsStreamModelInfo(tableRowId) {
        var rowIndex = getRowIndexFromTableRowId(tableRowId);
        var modelName =  $("#user-models").val();
        if ($("#user-scenario-folder-pathname").val() !== "") {
            modelName = modelName.substring(modelName.lastIndexOf("\\") + 1);
            var modelpathname = $("#user-scenario-folder-pathname").val() + "\\" + modelName;
        } else {
            var modelpathname = modelName;
        }
        var modelInfo = {
            Modelpathname: modelpathname,
            Databasename:  $("#source-database-" + rowIndex).val(),
            Tablename: $("#source-table-" + rowIndex).val()
        }
        return modelInfo;
    }
    function openDatabaseTableContentsModal(event) {
        var rowIndex = getRowIndexFromTableRowId(event.target.id);
        $('#modal-chart-axes-selection-dropdowns').hide();
        $('#view-model-chart-button').hide();
        $('#selected-response-table-name').val($("#source-table-" + rowIndex).val());
        updateLoadingDivVisibility(true, 'Loading data from server. Please wait...');
        var modelInfo = buildDatabaseTableContentsStreamModelInfo(event.target.id);
        getDatabaseTableContentsStream(modelInfo, true)
        .then(function(response) {
            displayTableContents(response.data.modelDatabaseTableFields);
            updateLoadingDivVisibility(false);
            $("#database-table-modal").show();
            return(response);
        })
    }
    
    function openViewDatabaseTableChartModal(event) {
        // var index = event.target.id.lastIndexOf('-') + 1;
        // var rowIndex = event.target.id.substring(index);
        var rowIndex = getRowIndexFromTableRowId(event.target.id);
        var modelName =  $("#user-models").val();
        modelName = modelName.substring(modelName.lastIndexOf("\\") + 1);
        var modelpathname = $("#user-scenario-folder-pathname").val() + "\\" + modelName;
        var modelInfo = {
            Modelpathname: modelpathname,
            Databasename:  $("#source-database-" + rowIndex).val(),
            Tablename: $("#source-table-" + rowIndex).val()
        }
        $('#modal-chart-axes-selection-dropdowns').show();
        $('#view-model-chart-button').show();
        $('#selected-response-table-name').val($("#source-table-" + rowIndex).val());
        updateLoadingDivVisibility(true, 'Loading data from server. Please wait...');
        // getDatabaseTableContentsStream(modelInfo, true, displayTableChartModal)
        getDatabaseTableContentsStream(modelInfo, true)
        .then(function(response) {
            console.log('Heading fields=' + JSON.stringify(response.data.modelDatabaseTableFields));
            g_tableSchema = response.data.modelDatabaseTableFields;
            makeChartDataSeries(g_tableDataArray, response.data.modelDatabaseTableFields, 'Step Name', 'Total Jobs Processed')
            .then(function(makeChartResponse) {
                console.log('char data=' + JSON.stringify(g_chartData));
                displayTableChartModal();
                updateLoadingDivVisibility(false);
                $("#database-table-modal").show();
                return(response);
            });
        })
    }

    function updateSourceBlockNumbersDropdown(rowIndex) {
        var blockType = '#source-block-type-select-' + rowIndex;
        var blockNumber = '#source-block-number-select-' + rowIndex;

        blockNumbers = [];
        var tempArray = [];
        for (var i=0;i<modelBlockInfo.length;i++) {
            if ($(blockType).val() === modelBlockInfo[i].blockName) {
                tempArray.push(modelBlockInfo[i].blockNumber);
            }
        }
        blockNumbers = Array.from(new Set(tempArray));
        blockNumbers.sort();
        $(blockNumber).empty();
        for (var i = 0; i < blockNumbers.length; i++) {
            $(blockNumber).append('<option value="' + blockNumbers[i] + '">' + blockNumbers[i] + '</option>');
        }
        updateSourceDialogVariableTypeDropdown(rowIndex);
    }
    function getReliabilityScenarioManagerBlockNumber() {
        for (var i=0;i<modelBlockInfo.length;i++) {
            if (modelBlockInfo[i].blockName === c_ReliabilityScenarioManager_blockName) {
                return modelBlockInfo[i].blockNumber;
            }
        }
        return -1;
    }
    function updateTargetBlockNumbersDropdown(rowIndex) {
        var blockType = '#target-block-type-select-' + rowIndex;
        var blockNumber = '#target-block-number-select-' + rowIndex;

        blockNumbers = [];
        var tempArray = [];
        for (var i=0;i<modelBlockInfo.length;i++) {
            if ($(blockType).val() === modelBlockInfo[i].blockName) {
                tempArray.push(modelBlockInfo[i].blockNumber);
            }
        }
        blockNumbers = Array.from(new Set(tempArray));
        blockNumbers.sort();
        $(blockNumber).empty();
        for (var i = 0; i < blockNumbers.length; i++) {
            $(blockNumber).append('<option value="' + blockNumbers[i] + '">' + blockNumbers[i] + '</option>');
        }
        updateTargetDialogVariableTypeDropdown(rowIndex);
    }
    function updateTargetDialogVariableTypeDropdown(rowIndex) {
        var blockNumber = '#target-block-number-select-' + rowIndex;
        var dialogVariableType = '#target-variable-type-select-' + rowIndex;
        dialogVariableTypes = [];
        var tempArray = [];
        for (var i=0;i<modelBlockInfo.length;i++) {
            if ($(blockNumber).val() === modelBlockInfo[i].blockNumber) {
                tempArray.push(modelBlockInfo[i].dialogVariableType);
            }
        }
        dialogVariableTypes = Array.from(new Set(tempArray));
        dialogVariableTypes.sort();
        $(dialogVariableType).empty();
        for (var i = 0; i < dialogVariableTypes.length; i++) {
            $(dialogVariableType).append('<option value="' + dialogVariableTypes[i] + '">' + dialogVariableTypes[i] + '</option>');
        }
        updateTargetDialogVariableDropdown(rowIndex);
    }

    function updateSourceDialogVariableTypeDropdown(rowIndex) {
        var blockNumber = '#source-block-number-select-' + rowIndex;
        var dialogVariableType = '#source-variable-type-select-' + rowIndex;
        dialogVariableTypes = [];
        var tempArray = [];
        for (var i=0;i<modelBlockInfo.length;i++) {
            if ($(blockNumber).val() === modelBlockInfo[i].blockNumber) {
                tempArray.push(modelBlockInfo[i].dialogVariableType);
            }
        }
        dialogVariableTypes = Array.from(new Set(tempArray));
        dialogVariableTypes.sort();
        $(dialogVariableType).empty();
        for (var i = 0; i < dialogVariableTypes.length; i++) {
            $(dialogVariableType).append('<option value="' + dialogVariableTypes[i] + '">' + dialogVariableTypes[i] + '</option>');
        }
        updateSourceDialogVariableDropdown(rowIndex);
    }

    function updateSourceDialogVariableDropdown(rowIndex) {
        var blockNumber = '#source-block-number-select-' + rowIndex;
        var dialogVariableType = '#source-variable-type-select-' + rowIndex;
        var dialogVariable = '#source-variable-name-select-' + rowIndex;
        dialogVariables = [];
        var tempArray = [];
        for (var i=0;i<modelBlockInfo.length;i++) {
            if (($(blockNumber).val() === modelBlockInfo[i].blockNumber) &&
                ($(dialogVariableType).val() === modelBlockInfo[i].dialogVariableType)) {
                tempArray.push(modelBlockInfo[i].variableName);
            }
        }
        dialogVariables = Array.from(new Set(tempArray));
        dialogVariables.sort();
        $(dialogVariable).empty();
        for (var i = 0; i < dialogVariables.length; i++) {
            $(dialogVariable).append('<option value="' + dialogVariables[i] + '">' + dialogVariables[i] + '</option>');
        }      
    }
    function updateTargetDialogVariableDropdown(rowIndex) {
        var blockNumber = '#target-block-number-select-' + rowIndex;
        var dialogVariableType = '#target-variable-type-select-' + rowIndex;
        var dialogVariable = '#target-variable-name-select-' + rowIndex;
        dialogVariables = [];
        var tempArray = [];
        for (var i=0;i<modelBlockInfo.length;i++) {
            if (($(blockNumber).val() === modelBlockInfo[i].blockNumber) &&
                ($(dialogVariableType).val() === modelBlockInfo[i].dialogVariableType)) {
                tempArray.push(modelBlockInfo[i].variableName);
            }
        }
        dialogVariables = Array.from(new Set(tempArray));
        dialogVariables.sort();
        $(dialogVariable).empty();
        for (var i = 0; i < dialogVariables.length; i++) {
            $(dialogVariable).append('<option value="' + dialogVariables[i] + '">' + dialogVariables[i] + '</option>');
        }      
    }

    function sourceBlockTypeSelected(event) {
        // var index = event.target.id.lastIndexOf('-') + 1;
        // var rowIndex = event.target.id.substring(index);
        var rowIndex = getRowIndexFromTableRowId(event.target.id);
        updateSourceBlockNumbersDropdown(rowIndex);
    }

    function targetBlockTypeSelected(event) {
        // var index = event.target.id.lastIndexOf('-') + 1;
        // var rowIndex = event.target.id.substring(index);
        var rowIndex = getRowIndexFromTableRowId(event.target.id);
        updateTargetBlockNumbersDropdown(rowIndex);
    }
    
    function sourceBlockNumberSelected(event) {
        // var index = event.target.id.lastIndexOf('-') + 1;
        // var rowIndex = event.target.id.substring(index);
        var rowIndex = getRowIndexFromTableRowId(event.target.id);
        updateSourceDialogVariableTypeDropdown(rowIndex);
    }

    function targetBlockNumberSelected(event) {
        // var index = event.target.id.lastIndexOf('-') + 1;
        // var rowIndex = event.target.id.substring(index);
        var rowIndex = getRowIndexFromTableRowId(event.target.id);
        updateTargetDialogVariableTypeDropdown(rowIndex);
    }

    function sourceDialogVariableTypeSelected(event) {
        // var index = event.target.id.lastIndexOf('-') + 1;
        // var rowIndex = event.target.id.substring(index);
        var rowIndex = getRowIndexFromTableRowId(event.target.id);
        updateSourceDialogVariableDropdown(rowIndex);  
    }
    function targetDialogVariableTypeSelected(event) {
        // var index = event.target.id.lastIndexOf('-') + 1;
        // var rowIndex = event.target.id.substring(index);
        var rowIndex = getRowIndexFromTableRowId(event.target.id);
        updateTargetDialogVariableDropdown(rowIndex);  
    }

    function targetDialogVariableSelected(event) {
    }
    function sourceDialogVariableSelected(event) {

    }
    function clearTableData() {
        // $("#file-inputs-table").empty();
        $("#file-inputs-table").find("tr:not(:first)").remove();
        $("#database-inputs-table").find("tr:not(:first)").remove();
        $("#dialog-inputs-table").find("tr:not(:first)").remove();
        $("#file-outputs-table").find("tr:not(:first)").remove();
        $("#database-outputs-table").find("tr:not(:first)").remove();
        $("#dialog-outputs-table").find("tr:not(:first)").remove(); 
    }

    function updateModelInfo(modelPathname, clearTableDataFlag) {
        return new Promise((resolve, reject) => {
            updateLoadingDivVisibility(true, 'Loading data from server. Please wait...');
            if (clearTableDataFlag) {
                clearTableData();
            }
            getmodeldatabases(modelPathname, getModelInfo)
            .then(function(response) {
                // save the currently loaded model name
                loadedScenarioModelpathname = modelPathname;
                resolve(true);
            })
            .catch(function(error) {
                reject(error);
            })
        });
    }
    function removeScenarioFolder(scenarioFolderPathname) {
        return new Promise((resolve, reject) => {
            axios({
                url: proxyurl + queryURL_root + 'ExtendSim/removescenariofolder',
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data: {
                    scenarioFolderPathname: scenarioFolderPathname,
                }
            })
            .then(function(response) {
                resolve(true);
            });
        });
    }

    function checkScenarioStatus(tableRowIndex, submittedScenarioIndex) {
        axios({
            url: proxyurl + queryURL_root + 'ExtendSim/checkmodelrunstatus',
            method: 'post',
            accept : 'application/json',
            contentType: 'application/json;charset=utf-8',
            data: {
                scenarioID: g_submittedScenarios[submittedScenarioIndex].scenarioID,
            }
        })
        .then(function(response) {
            g_submittedScenarios[submittedScenarioIndex].status = response.data.modelRunStatus;
            updateScenariosTableCellValue((tableRowIndex + 1), c_scenarioStatusColumn, scenarioStatusValues[response.data.modelRunStatus]);
            if ((g_submittedScenarios[submittedScenarioIndex].status == c_Completed_status) || (g_submittedScenarios[submittedScenarioIndex].status == c_Aborted_status)) {
                clearInterval(myCheckStatusInterval);
                updateScenariosTableProgressBarValue(tableRowIndex, 100);
                var scenarioIndex = g_submittedScenarios[submittedScenarioIndex].scenarioIndex;
                g_ScenarioDefinitions[scenarioIndex].scenarioRunDetails.completionTime = getCurrentTime();
                // updateScenariosTableCellValue((tableRowIndex + 1), c_PercentComplete, "100%");
                // $('#submit-scenarios-button').prop('disabled', false);
                $('#run-selected-scenarios-button').prop('disabled', !areScenariosSelected());
                $('#get-selected-scenario-responses-button').prop('disabled', !areScenariosSelected());
                $('#remove-selected-scenario-folders-button').prop('disabled', !areScenariosSelected());
                updateButtonsState();
                tableRowIndex++;
                if ((tableRowIndex + 1) < ($('#scenarios-table tr').length)) {
                    submitSelectedSimulationScenarios(tableRowIndex);
                }
            } else {
                axios({
                    url: proxyurl + queryURL_root + 'ExtendSim/getscenariorundetails',
                    method: 'post',
                    accept : 'application/json',
                    contentType: 'application/json;charset=utf-8',
                    data: {
                        scenarioID: g_submittedScenarios[submittedScenarioIndex].scenarioID,
                    }
                })
                .then(function(response) {  
                    var scenarioRunDetails = response.data.scenarioRunDetails;
                    var currentTime = scenarioRunDetails.currentSimulationTime;
                    var endTime = scenarioRunDetails.endSimulationTime;
                    var percentComplete = (currentTime / endTime) * 100;
                    percentComplete = percentComplete.toFixed(2);
                    if (percentComplete >= 0) {
                        updateScenariosTableProgressBarValue(tableRowIndex, percentComplete);
                    }
                    myCheckStatusInterval = setTimeout(()=> {checkScenarioStatus(tableRowIndex, submittedScenarioIndex)}, c_statusCheckTimeout);
                });
            }
        });
    }
    function getServerFile(filepath) {
        return new Promise((resolve, reject) => {
            axios({
                url: proxyurl + queryURL_root + 'ExtendSim/getfile',
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                // params: {
                data: {
                    filepath: filepath
                }
            })
            .then(function(response) {
                resolve(response);
            })
            .catch(function(error) {
                reject(error);
            })
        });   
    }
    function getScenarioFolderFiles(scenarioFolderPathname) {
        return new Promise((resolve, reject) => {
            axios({
                url: proxyurl + queryURL_root + 'ExtendSim/getserverscenariofolderdirectory',
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                // params: {
                data: {
                    // scenarioFolderPathname : $("#user-scenario-folder-pathname").val(),
                    scenarioFolderPathname : scenarioFolderPathname
                }
            })
            .then(function(response) {
                resolve(response);
            })
            .catch(function(error) {
                reject(error);
            })
        });
    }
    function createScenarioFolder(callServer, copyModelToFolder, scenarioFolderName, rowIndex) {
        return new Promise((resolve, reject) => {
            if (callServer) {
            axios({
                url: proxyurl + queryURL_root + 'ExtendSim/createScenarioFolder',
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                // params: {
                data: {
                    userLoginSessionID : $("#user-login-session-id").val(),
                    scenarioFolderName : scenarioFolderName,
                    // scenarioFolderName : $("#scenario-name").val(),
                }
            })
            .then(function(response) {
                // Storing an array of results in the results variable
                updateScenariosTableCellValue((rowIndex + 1), c_scenarioFolderPathnameColumn, response.data.scenarioFolderPathname);
                $("#user-scenario-folder-pathname").val(response.data.scenarioFolderPathname);
                $('#create-scenario-folder-button').prop('disabled', true);
                $('#copy-model-to-scenario-folder').prop('disabled', false);
                if (copyModelToFolder) {
                    copyModelToScenarioFolder(callServer)
                    .then(function(copyModelToScenarioFolderResponse) {
                        resolve(response.data.scenarioFolderPathname);
                    })
                }else {
                    resolve(response.data.scenarioFolderPathname);
                }
            })
            .catch(function(error) {
                reject(error);
            })
        } else {
            resolve(true);
        }
        });
    }

    function copyModelToScenarioFolder(callServer, scenarioFolderPathname) {
        return new Promise((resolve, reject) => {
            if (callServer) {
                axios({
                    url: proxyurl + queryURL_root + 'ExtendSim/copyModelToScenarioFolder',
                    method: 'post',
                    accept : 'application/json',
                    contentType: 'application/json;charset=utf-8',
                    // params: {
                    data: {
                        modelPathname: $("#user-models").val(),
                        scenarioFolderPathname: scenarioFolderPathname,
                        copyFolderContents: false
                    }
                })
                .then(function(response) {
                    resolve(true);
                })
                .catch(function(error) {
                    reject(error);
                })  
            } else {
                resolve(true);           
            }
        });   
    }

    function sendFactorDataToServer() {
        uploadDataFilesToServer(0, uploadDataStreamsToModel, uploadDialogVariableDataToModel);
    }

    function downloadDialogVariableDataFromModel(rowIndex) {
        return new Promise((resolve, reject) => {
            if (dialogOutputsTableRows() < 1) {
                // Exit since there is not data to push 
                resolve(true);
            } else {
                var modelName =  $("#user-models").val();
                modelName = modelName.substring(modelName.lastIndexOf("\\") + 1);
                var modelpathname = $("#user-scenario-folder-pathname").val() + "\\" + modelName;
                var variableName = $('#source-variable-name-select-' + (rowIndex + 1)).val();
                var variableValue = $('#source-variable-value-' + (rowIndex + 1)).val();
                var blockNumber = $('#source-block-number-select-' + (rowIndex + 1)).val();
                axios({
                    url: proxyurl + queryURL_root + "ExtendSim/getdialogvariabledata",
                    method: 'post',
                    accept : 'application/json',
                    contentType: 'application/json;charset=utf-8',
                    data : {
                        variableName: variableName,
                        blockNumber: blockNumber,
                        row: 0,
                        column: 0,
                        modelPathname: modelpathname
                    }
                })
                .then(function(response) {
                    // deposit result in dialog outputs table cell
                    $("#source-variable-value-" + (rowIndex + 1)).val(response.data.result);
                //  Advance to the next row
                    rowIndex++;
                    if (rowIndex < dialogOutputsTableRows()) {
                        resolve(downloadDialogVariableDataFromModel(rowIndex));
                    } else {
                        // All dialog variable values pushed to server
                        resolve(true);
                    }
                });
            }
        });
    }

    function uploadDialogVariableDataToModel(rowIndex, scenarioIndex, scenarioFolderPathname) {
        return new Promise((resolve, reject) => {
            if (dialogInputsTableRows() < 1) {
                // Exit since there is not data to push 
                resolve(true);
            } else {
                var modelName =  $("#user-models").val();
                modelName = modelName.substring(modelName.lastIndexOf("\\") + 1);
                var modelpathname = scenarioFolderPathname + "\\" + modelName;
                var variableName = g_ScenarioDefinitions[scenarioIndex].factors.variableNames[rowIndex];
                var variableValue = g_ScenarioDefinitions[scenarioIndex].factors.variableValues[rowIndex];
                var blockNumber = g_ScenarioDefinitions[scenarioIndex].factors.blockNumbers[rowIndex];
                axios({
                    url: proxyurl + queryURL_root + "ExtendSim/senddialogvariabledata",
                    method: 'post',
                    accept : 'application/json',
                    contentType: 'application/json;charset=utf-8',
                    data : {
                        variableName: variableName,
                        variableValue: variableValue,
                        blockNumber: blockNumber,
                        row: 0,
                        column: 0,
                        modelPathname: modelpathname
                    }
                })
                .then(function(response) {
                //  Advance to the next row
                    rowIndex++;
                    if (rowIndex < g_ScenarioDefinitions[scenarioIndex].factors.variableNames.length) {
                        resolve(uploadDialogVariableDataToModel(rowIndex, scenarioIndex, scenarioFolderPathname));
                    } else {
                        // All dialog variable values pushed to server
                        resolve(true);
                    }
                });
            }
        });
    }
    function uploadDataStreamsToModel_new(rowIndex, scenarioIndex, scenarioFolderPathname) {
        return new Promise((resolve, reject) => {
            if (g_ScenarioDefinitions[scenarioIndex].factors.uploadedDatabaseFiles.length < 1) {
                // Exit since there is not data to push 
                resolve(true);
            } else {
                var modelName =  g_ScenarioDefinitions[scenarioIndex].factors.modelName;
                modelName = modelName.substring(modelName.lastIndexOf("\\") + 1);
                var modelpathname = scenarioFolderPathname + "\\" + modelName;
                var databasename = g_ScenarioDefinitions[scenarioIndex].factors.factorDatabasenames[rowIndex];
                var tablename = g_ScenarioDefinitions[scenarioIndex].factors.factorTablenames[rowIndex];
                var dataContent = g_ScenarioDefinitions[scenarioIndex].factors.uploadedDatabaseFiles[rowIndex].data;
                axios({
                    url: proxyurl + queryURL_root + "ExtendSim/senddatastream",
                    method: 'post',
                    accept : 'application/json',
                    contentType: 'application/json;charset=utf-8',
                    data : {
                        modelPathname: modelpathname,
                        modelDatabaseName: databasename,
                        databaseTableName: tablename,
                        tabledata: dataContent
                    }
                })
                .then(function(response) {
                    rowIndex++;
                    if (rowIndex < g_ScenarioDefinitions[scenarioIndex].factors.uploadedDatabaseFiles.length) {
                        resolve(uploadDataStreamsToModel_new(rowIndex, scenarioIndex, scenarioFolderPathname));
                    } else {
                        // All data streams have been sent to the user's models on the server
                        $("#database-inputs-uploaded-status").prop('checked', true);
                        resolve(true);
                    }
                });
            }
        });
    }
    function uploadDataStreamsToModel(rowIndex) {
        return new Promise((resolve, reject) => {
            if (databaseInputsTableRows() < 1) {
                // Exit since there is not data to push 
                resolve(true);
            } else {
                var reader = new FileReader();
                var modelName =  $("#user-models").val();
                modelName = modelName.substring(modelName.lastIndexOf("\\") + 1);
                var modelpathname = $("#user-scenario-folder-pathname").val() + "\\" + modelName;
                var databasename = $('#target-database-' + (rowIndex + 1)).val();
                var tablename = $('#target-table-' + (rowIndex + 1)).val();
                reader.onload = function(event) {
                event.preventDefault();
                    axios({
                        url: proxyurl + queryURL_root + "ExtendSim/senddatastream",
                        method: 'post',
                        accept : 'application/json',
                        contentType: 'application/json;charset=utf-8',
                        data : {
                            modelPathname: modelpathname,
                            modelDatabaseName: databasename,
                            databaseTableName: tablename,
                            tabledata: reader.result
                        }
                    })
                    .then(function(response) {
                        rowIndex++;
                        if (rowIndex < databaseInputsTableRows()) {
                            resolve(uploadDataStreamsToModel(rowIndex));
                        } else {
                            // All data streams have been sent to the user's models on the server
                            $("#database-inputs-uploaded-status").prop('checked', true);
                            resolve(true);
                        }
                    });
                }
                reader.readAsText(selectedDatabaseFiles[rowIndex]);
            }
        });
    }
    function uploadUserModelPathnameToServer(modelpathname, modelfilename) {
        return new Promise((resolve, reject) => {
            updateLoadingDivVisibility(true, 'Uploading model to server. Please wait...');
            axios({
                url: proxyurl + queryURL_root + "ExtendSim/sendmodelpathname",
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                // contentType: 'application/octet-stream',
                // contentType: 'blob',
                // contentType: 'multipart/form-data',
                data : {
                    scenarioFolderPathname: modelpathname,
                    filename: modelfilename
                }
            })
            .then(function(response) {
                resolve(true);
            });
        });
    }
    function uploadUserModelToServer() {
        return new Promise((resolve, reject) => {
            event.preventDefault();
            updateLoadingDivVisibility(true, 'Uploading model to server. Please wait...');
            axios({
                // url: proxyurl + queryURL_root + "ExtendSim/sendfile",
                url: proxyurl + queryURL_root + "ExtendSim/uploadmodelfile",
                method: 'post',
                accept : 'application/json',
                // contentType: 'application/json;charset=utf-8',
                // contentType: 'application/octet-stream',
                // contentType: 'blob',
                // contentType: 'multipart/form-data',
                data : {
                    scenarioFolderPathname: g_userModelsRootPath,
                    filename: g_uploadedUserModelFile.name,
                    filedata: g_uploadedUserModelFile.data
                }
            })
            .then(function(response) {
                resolve(true);
            });
        });
    }
    function uploadExcelFilesToServer(fileIndex, scenarioIndex, scenarioFolderPathname) {
        return new Promise((resolve, reject) => {
            event.preventDefault();
            updateLoadingDivVisibility(true, 'Uploading model to server. Please wait...');
            axios({
                // url: proxyurl + queryURL_root + "ExtendSim/sendfile",
                url: proxyurl + queryURL_root + "ExtendSim/uploadmodelfile",
                method: 'post',
                accept : 'application/json',
                // contentType: 'application/json;charset=utf-8',
                // contentType: 'application/octet-stream',
                // contentType: 'blob',
                // contentType: 'multipart/form-data',
                data : {
                    scenarioFolderPathname: scenarioFolderPathname,
                    filename: g_ScenarioDefinitions[scenarioIndex].factors.uploadedFiles[fileIndex].name,
                    filedata: g_ScenarioDefinitions[scenarioIndex].factors.uploadedFiles[fileIndex].data
                }
            })
            .then(function(response) {
                resolve(true);
            });
        });
    }
    function uploadDataFilesToServer_new(fileIndex, scenarioIndex, scenarioFolderPathname) {
        return new Promise((resolve, reject) => {
            if (g_ScenarioDefinitions[scenarioIndex].factors.uploadedFiles.length < 1) {
                // Exit since there are no files to copy
                resolve(true);
            } else {
                if (g_ScenarioDefinitions[scenarioIndex].factors.uploadedFiles[fileIndex].name.indexOf('.xls') > 0) {
                    var url = proxyurl + queryURL_root + "ExtendSim/uploadmodelfile";
                } else {
                    var url = proxyurl + queryURL_root + "ExtendSim/sendfile";
                }
                event.preventDefault();
                axios({
                    url: url,
                    method: 'post',
                    accept : 'application/json',
                    contentType: 'application/json;charset=utf-8',
                    data : {
                        scenarioFolderPathname: scenarioFolderPathname,
                        filename: g_ScenarioDefinitions[scenarioIndex].factors.uploadedFiles[fileIndex].name,
                        filedata: g_ScenarioDefinitions[scenarioIndex].factors.uploadedFiles[fileIndex].data
                    }
                })
                .then(function(response) {
                    fileIndex++;
                    if (fileIndex < g_ScenarioDefinitions[scenarioIndex].factors.uploadedFiles.length) {
                        resolve(uploadDataFilesToServer_new(fileIndex, scenarioIndex, scenarioFolderPathname));
                    } else {
                        resolve(true);
                        // Kick off next type of data push to the server model
                    }
                });
            }
        });
    }
    function uploadDataFilesToServer(fileIndex) {
        return new Promise((resolve, reject) => {
            if (inputFileTableRows() < 1) {
                // Exit since there are no files to copy
                resolve(true);
            } else {
                var reader = new FileReader();

                reader.onload = function(event) {
                event.preventDefault();
                    axios({
                        url: proxyurl + queryURL_root + "ExtendSim/sendfile",
                        method: 'post',
                        accept : 'application/json',
                        contentType: 'application/json;charset=utf-8',
                        data : {
                            scenarioFolderPathname: $("#user-scenario-folder-pathname").val(),
                            filename: selectedFiles[fileIndex].name,
                            filedata: reader.result
                        }
                    })
                    .then(function(response) {
                        fileIndex++;
                        if (fileIndex < inputFileTableRows()) {
                            resolve(uploadDataFilesToServer(fileIndex));
                        } else {
                            $("#files-uploaded-status").prop('checked', true);
                            resolve(true);
                            // Kick off next type of data push to the server model
                        }
                    });
                }
                reader.readAsText(selectedFiles[fileIndex]);
            }
        });
    }
    function getNumRunningSimulationScenarios() {
        var numRunningSimulationScenarios = 0;
        for (var i=0;i<g_submittedScenarios.length;i++) {
            if ((g_submittedScenarios[i].status !== c_Completed_status) &&
                (g_submittedScenarios[i].status !== c_Aborted_status)) {
                    numRunningSimulationScenarios++;
                }
        }
        return numRunningSimulationScenarios;
    }
    function getScenariosTableScenarioIndex(rowIndex) {
        var scenariosTable = $('#scenarios-table');
        var thisRow = $(scenariosTable).find("tr:eq(" + rowIndex + ")");
        var selectElementId = $(thisRow).attr('id');
        var scenarioIndex = Number(selectElementId.substring(selectElementId.lastIndexOf("-") + 1)) - 1;
        return scenarioIndex;
    }
    function isScenarioSelected(scenarioIndex) {
        var selected = $('#scenario-selection-' + (scenarioIndex + 1)).is(":checked");
        return selected;
    }
    function submitSelectedSimulationScenarios(rowIndex) {
        return new Promise((resolve, reject) => { 
            // Trigger the sequence of calls required to:
            //  1. create a scenario folder
            //  2. copy the user model and server files to the scenario folder
            //  3. Push factor data to the scenario folder and model
            //  4. Submit the scenario on the server

            // create the scenario folder
            var createScenariorFolderFlag;
            // waitForRunningSimulationScenarios()
            // .then(function(response) {
            var scenariosTable = $('#scenarios-table');
            var scenarioIndex;
            var selected = false;
            // mark the scenarios as being submitted
            if (rowIndex === 0) {
                for (var i=1;i<$('#scenarios-table tr').length;i++) {
                    scenarioIndex = getScenariosTableScenarioIndex(i);
                    selected = isScenarioSelected(scenarioIndex);
                    if (selected) {
                        updateScenariosTableCellValue(i, c_scenarioStatusColumn, scenarioStatusValues[1]);
                        updateScenariosTableCellValue(i, c_scenarioIDColumn, "undefined");
                        updateScenariosTableProgressBarValue(i, 0);
                    }
                }
            }
            scenarioIndex = getScenariosTableScenarioIndex(rowIndex + 1);
            selected = isScenarioSelected(scenarioIndex);
            if (selected) {
                var thisRow = $(scenariosTable).find("tr:eq(" + (rowIndex + 1) + ")");
                var scenarioFolderName = $(thisRow).find('td:eq(' + c_scenarioNameColumn + ')').text();
                $('#run-selected-scenarios-button').prop('disabled', !areScenariosSelected()); 
                // Check to see if there is more than the heading in the scenarios table
                if ($('#scenarios-table tr').length > 1) {
                    createScenariorFolderFlag = true;
                } else {
                    createScenariorFolderFlag = !doesScenarioFolderExist();
                }
                createScenarioFolder(createScenariorFolderFlag, false, scenarioFolderName, rowIndex)
                .then(function(createScenarioFolderResponse) {
                    var scenarioFolderPathname = createScenarioFolderResponse;
                    g_ScenarioDefinitions[scenarioIndex].factors.scenarioFolderPathname = scenarioFolderPathname;
                    // Copy user selected server model into scenario folder
                    copyModelToScenarioFolder(createScenariorFolderFlag, scenarioFolderPathname)
                    .then(function(copyModelToScenarioFolderResponse) {
                        // uploadDataStreamsToModel(0)
                        uploadDataStreamsToModel_new(0, scenarioIndex, scenarioFolderPathname)
                        .then(function(uploadDataStreamsToModelResponse) {
                            // uploadDataFilesToServer(0)
                            uploadDataFilesToServer_new(0, scenarioIndex, scenarioFolderPathname)
                            .then(function(uploadDataFilesToServerResponse) {
                                uploadDialogVariableDataToModel(0, scenarioIndex, scenarioFolderPathname)
                                .then(function(uploadDialogVariableDataToModelResponse) {
                                        // // Trigger the submission of the scenario
                                    if (g_RSMblockNumber > 0) {
                                    // if (g_RSMblockNumber === 0) {
                                        const c_ReliabilityScenarioManager_blockName = "Reliability Scenario Manager";
                                        const c_ReliabilityScenarioManager_runButtonName = "SCEN_RunSelected_btn";
                                        var modelName =  $("#user-models").val();
                                        modelName = modelName.substring(modelName.lastIndexOf("\\") + 1);
                                        var modelPathname = scenarioFolderPathname + "\\" + modelName;
                                        var userLoginSessionID = $("#user-login-session-id").val();
                                        axios({
                                            url: proxyurl + queryURL_root + 'ExtendSim/submitsimulationscenariotoblock',
                                            method: 'post',
                                            accept : 'application/json',
                                            contentType: 'application/json;charset=utf-8',
                                            data: {
                                                userLoginSessionID: userLoginSessionID,
                                                modelPathname: modelPathname,
                                                runButtonName: c_ReliabilityScenarioManager_runButtonName,
                                                blockNumber: g_RSMblockNumber,
                                                quitExtendSim: true,
                                                removeFolderOnCompletion: false,
                                                sysGlobalStr5: ""
                                            }
                                        })
                                        .then(function(response) {
                                            updateScenariosTableCellValue((rowIndex + 1), c_scenarioIDColumn, response.data.scenarioID);
                                            g_submittedScenarios.push({ scenarioID: response.data.scenarioID,
                                                                        rowIndex: rowIndex,
                                                                        status: 0,
                                                                        scenarioIndex: scenarioIndex});
                                            g_ScenarioDefinitions[scenarioIndex].scenarioRunDetails.completionTime = c_undefined_ScenarioDetailsTime;
                                            myCheckStatusInterval = setTimeout(()=> {checkScenarioStatus(rowIndex, (g_submittedScenarios.length - 1))}, c_statusCheckTimeout);
                                            updateButtonsState();
                                        });
                                    } else {
                                        var modelName =  $("#user-models").val();
                                        modelName = modelName.substring(modelName.lastIndexOf("\\") + 1);
                                        var modelPathname = scenarioFolderPathname + "\\" + modelName;
                                        var userLoginSessionID = $("#user-login-session-id").val();
                                        axios({
                                            url: proxyurl + queryURL_root + 'ExtendSim/submitsimulationscenario',
                                            method: 'post',
                                            accept : 'application/json',
                                            contentType: 'application/json;charset=utf-8',
                                            data: {
                                                userLoginSessionID: userLoginSessionID,
                                                modelPathname: modelPathname,
                                                removeFolderOnCompletion: false
                                            }
                                        })
                                        .then(function(response) {
                                            updateScenariosTableCellValue((rowIndex + 1), c_scenarioIDColumn, response.data.scenarioID);
                                            g_submittedScenarios.push({ scenarioID: response.data.scenarioID,
                                                                        rowIndex: rowIndex,
                                                                        status: 0, 
                                                                        scenarioIndex: scenarioIndex });
                                            myCheckStatusInterval = setTimeout(()=> {checkScenarioStatus(rowIndex, (g_submittedScenarios.length - 1))}, c_statusCheckTimeout);
                                            updateButtonsState();
                                        });
                                    }
                                })
                            });
                        })
                    })
                    .catch(function(copyModelToScenarioFolderError) {
                        alert('copyModelToScenarioFolder error=' + copyModelToScenarioFolderError);
                    })
                })
                .catch(function(error1) {
                    alert('createScenarioFolder error=' + error1);
                });
            } else {
                rowIndex++;
                if (rowIndex < $('#scenarios-table tr').length) {
                    resolve(submitSelectedSimulationScenarios(rowIndex));
                } else {
                    resolve(true);
                }
            }
        })
        // });
    }

    function getModelDatabaseTableFields(modelpathname, databasename, tablename) {  
        return new Promise((resolve, reject) => { 
            axios({
                url: proxyurl + queryURL_root + "ExtendSim/getmodeldatabasetablefields",
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data : {
                    modelpathname: modelpathname,
                    databasename: databasename,
                    tablename: tablename,
                    closeModel: false
                }
            })
            .then(function(response) {
                resolve(response);
            })
            .catch(function(error) {
                reject(error);
            })
        });
    }
    function getmodeldatabases(modelPathname, callback) {
        return new Promise((resolve, reject) => { 
            axios({
                url: proxyurl + queryURL_root + "ExtendSim/getmodeldatabases",
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data : {
                    modelPathname: modelPathname,
                    closeModel: false
                }
            })
            .then(function(response) {
                modelDatabases= [];
                for (var i=0;i<response.data.modelDatabases.length;i++) {
                    if (response.data.modelDatabases[i].charAt(0) !== "_") {
                        modelDatabases.push({ name: response.data.modelDatabases[i],
                                            tableNames: [] });
                    }
                }
                getDatabaseTables(0, callback, modelPathname)
                .then(function(getDatabaseTablesResponse) {
                    resolve(getDatabaseTablesResponse);
                });
            });
        });
    }

    function getDatabaseTables(databaseIndex, callback, modelpathname) {
        return new Promise((resolve, reject) => { 
            axios({
                url: proxyurl + queryURL_root + "ExtendSim/getmodeldatabasetables",
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data : {
                    modelPathname: modelpathname,
                    database: modelDatabases[databaseIndex].name,
                    closeModel: false
                }
            })
            .then(function(response) {
                modelDatabases[databaseIndex].tableNames = response.data.modelDatabaseTables;
                modelDatabases[databaseIndex].tableNames.sort();
                var dbIndex = databaseIndex + 1;
                if (dbIndex < modelDatabases.length) {
                    resolve(getDatabaseTables(dbIndex, callback, modelpathname));
                } else {
                    if (callback !== "") {
                        callback()
                        .then(function(callbackResponse) {
                            resolve(response);
                        });
                    } else {
                        resolve(response);
                    }
                }
            })
            .catch(function(error) {
                reject(error);
            })
        });
    }

    function getUserModelPaths() {
        return new Promise((resolve, reject) => { 
            clearTableData();
            $("#get-user-models-button").prop('disabled', true);
            updateLoadingDivVisibility(true, 'Loading data from server. Please wait...');
            axios({
                url: proxyurl + queryURL_root + 'ExtendSim/getUserModelPaths',
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data: {
                    username : $("#username").val(),
                }
            })
            .then(function(response) {
                var userModelPaths = response.data.userModelPaths;
                setUsersModelRootPath(userModelPaths);

                $('#user-models').empty(0);
                for (var i = 0; i < userModelPaths.length; i++) {
                    $('#user-models').append('<option value="' + userModelPaths[i] + '">' + userModelPaths[i].substring(userModelPaths[i].lastIndexOf("\\") + 1) + '</option>');
                }
                if (userModelPaths.length > 0) {
                    $('#user-models').val(userModelPaths[0]);
                }
                this.enableDisableCopyModelToScenarioFolderButton();
                this.updateButtonsState();
                updateLoadingDivVisibility(false);
                resolve(response);
            });
        });
    }

    function getModelInfo() {
        return new Promise((resolve, reject) => { 
            axios({
                url: proxyurl + queryURL_root + "ExtendSim/getmodelinfo",
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data : {
                    modelpathname: $("#user-models").val(),
                    modelInfoBlockName: 'Executive',
                    closeModel: false
                }
            })
            .then(function(response) {
                var modelInfo = {
                    Modelpathname: $("#user-models").val(),
                    Databasename: response.data.ModelInfo.Databasename,
                    Tablename: response.data.ModelInfo.Tablename
                }
                console.log("ModelInfo: " + JSON.stringify(modelInfo));
                getDatabaseTableContentsStream(modelInfo, false)
                .then(function(getDatabaseTableContentsStreamResponse) {
                    resolve(getDatabaseTableContentsStreamResponse);
                })
                .catch(function(getDatabaseTableContentsStreamError) {
                    reject(getDatabaseTableContentsStreamError);
                })
            })
            .catch(function(error) {
                reject(error);
            })
        });
    }
    function sendDataStreamToDatabaseTable(modelInfo, callback) {
        axios({
            url: proxyurl + queryURL_root + "ExtendSim/senddatastream",
            method: 'post',
            accept : 'application/json',
            contentType: 'application/json;charset=utf-8',
            data : {
                modelPathname: modelInfo.Modelpathname, 
                modelDatabaseName: modelInfo.Databasename,
                databaseTableName: modelInfo.Tablename
            }
        })
        .then(function(response) {
        });
    }
    function getDatabaseTableContentsStream(modelInfo, getFieldInfo) {
        return new Promise((resolve, reject) => { 
            axios({
                url: proxyurl + queryURL_root + "ExtendSim/getdatabasetablecontentsstream",
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data : {
                    modelPathname: modelInfo.Modelpathname, 
                    databaseName: modelInfo.Databasename,
                    tableName: modelInfo.Tablename
                }
            })
            .then(function(response) {
                if (modelInfo.Tablename === 'ModelDialogVariables') {
                    modelBlockInfo = [];
                    response.data.tableDataArray.forEach(function(elements, index) {
                        modelBlockInfo.push(
                        {
                            variableName: elements[0],
                            dialogVariableType: elements[1],
                            blockName: elements[2],
                            blockNumber: elements[3],
                            tabname: elements[4],
                            blockLabel: elements[5],
                            enclosingHblockNumber: elements[6],
                            enclosingHblockLabel: elements[7],  
                        });
                    })
                    modelBlocks = [];
                    var tempArray = [];
                    for (var i=0;i<modelBlockInfo.length;i++) {
                        tempArray.push(modelBlockInfo[i].blockName);
                    }
                    modelBlocks = Array.from(new Set(tempArray));
                    modelBlocks.sort();
                    g_RSMblockNumber = getReliabilityScenarioManagerBlockNumber();
                    updateLoadingDivVisibility(false);
                    resolve(response);
                } else {
                    // save results globally
                    g_tableDataArray = response.data.tableDataArray;
                    getModelDatabaseTableFields(modelInfo.Modelpathname, modelInfo.Databasename, modelInfo.Tablename)
                    .then(function(getModelDatabaseTableFieldsResponse) {
                        resolve(getModelDatabaseTableFieldsResponse);
                    })
                    .catch(function(error) {
                        reject(error);
                    })
                }
            });  
        });     
    }
    function initializeWebPage() {
        $('#user-scenario-folder-pathname').val("");
        clearTableData();
    }
    function loginToServer() {
        initializeWebPage();
        axios({
            url: proxyurl + queryURL_root + 'users/login',
            method: 'post',
            accept : 'application/json',
            contentType: 'application/json;charset=utf-8',
            data : {
                username:  $("#username").val(),
                password: $("#password").val()
            }
        })
        .then(function(response) {
            // Storing an array of results in the results variable
            getUserModelPaths()
            .then(function(getUserModelPathsResponse) {
                $("#user-login-session-id").val(response.data.userLoginSessionID);
                $('.user-login-buttons').prop('disabled', false);
                $('.scenario-definition-checkboxes').prop('disabled', false);
                $('.scenario-setup-checkbox').prop('disabled', false);
            });
        });
    }
    enableDisableUploadFilesButton();

    // Event listener for all button elements
    $("button").on("click", function() {
      // In this case, the "this" keyword refers to the button that was clicked
      switch (this.id) {
        case 'users/login':

            axios({
                url: proxyurl + queryURL_root + this.id,
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data : {
                    username:  $("#username").val(),
                    password: $("#password").val()
                }
            })
            .then(function(response) {
                // Storing an array of results in the results variable
                $("#user-login-session-id").val(response.data.userLoginSessionID);
                $('.user-login-buttons').prop('disabled', false);
            });
          break;

        case 'ExtendSim/createScenarioFolder':

            axios({
                url: proxyurl + queryURL_root + this.id,
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                // params: {
                data: {
                    userLoginSessionID : $("#user-login-session-id").val(),
                    scenarioFolderName : $("#scenario-name").val(),
                }
            })
            .then(function(response) {
                // Storing an array of results in the results variable
                $("#user-scenario-folder-pathname").val(response.data.scenarioFolderPathname);
            });
            break;

        case 'ExtendSim/copyModelToScenarioFolder':

            axios({
                url: proxyurl + queryURL_root + this.id,
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data: {
                    modelPathname: $("#user-models").val(),
                    scenarioFolderPathname: $("#user-scenario-folder-pathname").val(),
                    copyFolderContents: true
                }
            })
            .then(function(response) {
                $("#model-copied-status").prop('checked', true);
                $("#model-copied-status").prop('disabled', true);
            });
            break;

        case 'ExtendSim/submitsimulationscenario':

            var modelName =  $("#user-models").val();
            modelName = modelName.substring(modelName.lastIndexOf("\\") + 1);
            axios({
                url: proxyurl + queryURL_root + this.id,
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data: {
                    userLoginSessionID: $("#user-login-session-id").val(),
                    modelPathname:  $("#user-scenario-folder-pathname").val() + "\\" + modelName,
                    removeFolderOnCompletion: false
                }
            })
            .then(function(response) {
                $("#scenario-id").val(response.data.scenarioID);
            });
            break;

        case 'ExtendSim/checkmodelrunstatus':
        
            axios({
                url: proxyurl + queryURL_root + this.id,
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data: {
                    scenarioID: $("#scenario-id").val(),
                }
            })
            .then(function(response) {
                $("#scenario-status").val(scenarioStatusValues[response.data.modelRunStatus]);
            });
           break;
      }
    });

    $('.login').keyup(function () {
        validateUserInputs();
    });
    $('#scenario-name').keyup(function () {
        updateButtonsState();
    });
    // $(document).on("click", "#scenarios-table td", function() {
    $(document).on("click", "#scenarios-table tr", function() {
        console.log(JSON.stringify($(this).data()));
        var folder = $(this).closest('tr').find('td:eq(' + c_scenarioFolderPathnameColumn + ')').text();
        if (folder !== $("#user-scenario-folder-pathname").val()) {
        //  User has selected a scenario that is not currently loaded
            clearTableData();
        }
        $("#user-scenario-folder-pathname").val(folder);                
    });

    //  checkbox click event handler
    $('input[type=checkbox]').change(function () {
        // manage container display widths
        var thisCheckbox = $(this).attr('id');
        var thisContainerId = thisCheckbox.substring(0, thisCheckbox.indexOf('-checkbox'));
        setContainerWidth(thisContainerId, $(this).prop("checked"));
    });
    function setContainerWidth(elementName, checked) {
        for (var i=0;i<g_containers.length;i++) {
            if (g_containers[i].name === elementName) {
                $('#' + elementName).css('min-width', g_containers[i].width.minimum + 'px');
                if (checked) {
                    $('#' + elementName).width(g_containers[i].width.checked);
                    if (g_containers[i].parent.name !== '') {
                        $('#' + g_containers[i].parent.name).width(g_containers[i].parent.width.checked);
                    }
                    var childrenChecked = false;
                    var validChildren = 0;
                    for (var j=0;j<g_containers[i].children.length;j++) {
                        if (g_containers[i].children[j].name !== '') {
                            validChildren++;
                            if ($('#' + g_containers[i].children[j].name + '-checkbox').prop('checked')) {
                                childrenChecked = true;
                                $('#' + g_containers[i].children[j].name).width(g_containers[i].children[j].width.checked);
                            }
                            else {
                                $('#' + g_containers[i].children[j].name).width(g_containers[i].children[j].width.unchecked);
                            }
                        }
                    }
                    if (!childrenChecked && (validChildren > 0)) {
                        $('#' + elementName).width(g_containers[i].width.unchecked);  
                    } else {
                        $('#' + elementName).width(g_containers[i].width.checked);                       
                    }
                } else {
                    $('#' + elementName).width(g_containers[i].width.unchecked);
                    if (g_containers[i].parent.name !== '') {
                        $('#' + g_containers[i].parent.name).width(g_containers[i].parent.width.unchecked);
                    }
                }
            }
        }
        return $('#' + elementName).width();
    }
    $('#dialog-outputs-table').on('change', 'select', function () {
        var selectElementId = $(this).closest('select').attr('id');
        var rowIndex = Number(selectElementId.substring(selectElementId.lastIndexOf("-") + 1)) - 1;
        downloadDialogVariableDataFromModel(rowIndex);
    });
</script>
</body>

</html>
