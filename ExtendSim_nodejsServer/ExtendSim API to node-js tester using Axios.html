<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>ExtendSim ASP API tester</title>
  <style>
    table, th, td {
      border: 1px solid black;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 5px;
      text-align: left;    
    }
    .login {
        margin-right: 20px;
    }
    .input-file-row {
        width: 350px;
    }
    .database-input-row {
        width: 350px;
    }
    .upload-files {
        margin-top: 10px;
        margin-right: 10px;
    }
    .upload-database-inputs {
        margin-top: 10px;
        margin-right: 10px;
    }
    #extendsim-asp-axios-tester-frame {
        width: 90%;
        padding: 10px;
        border-color: blue,;
        border-width: 2px;
        border-style: solid;
        border-radius: 10px;
        background-color: #c9d6ff;
    }
    #user-form {
        width: auto;
        padding: 20px;
        margin-bottom: 20px;
        border-color: black;
        border-width: 2px;
        border-style: solid;
        border-radius: 10px;
        background-color: #c9ffd6;
    }
    #scenario-name {
        width: 30%;
    }

    #user-login-session-id {
        width: 300px;
    }
    #user-login-session-id-label {
        margin-left: 20px;
    }
    #user-scenario-folder-pathname {
        width: 600px;
    }
    #user-scenario-folder-pathname-label {
        margin-left: 20px;
    }
    #user-models-label {
        margin-left: 20px;
    }
    #model-copied-status-label {
        margin-left: 20px;
    }
    #upload-filename-label {
        margin-left: 20px;
    }
    #scenario-id-label {
        margin-left: 20px;
    }
    #scenario-id {
        margin-right: 20px;
    }
    #scenario-status-label {
        margin-left: 20px;
    }
    #scenario-input-files {
        border: 2px solid blue;
        border-radius: 10px;
        padding-left: 20px;
        padding-right: 20px;
        padding-bottom: 20px;
        margin-bottom: 20px;
        margin-right: 10px;
        width: auto;
        background-color:rgb(202, 202, 202);
        float: left;
    }
    #scenario-database-inputs {
        border: 2px solid blue;
        border-radius: 10px;
        padding-left: 20px;
        padding-right: 20px;
        padding-bottom: 20px;
        margin-bottom: 20px;
        background-color:rgb(202, 202, 202);
        width: auto;
        float: left;
    }
    #submit-simulation {
        border: 2px solid blue;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        background-color: rgb(248, 179, 179);
        width: auto;
        clear: left;
    }
    </style>
</head>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>        
    <div id="extendsim-asp-axios-tester-frame">
        <div id="user-form">
            Username: <input class="login" id="username" type="text" name="username" value=""></input>
            Password: <input class="login" id="password" type="password" name="password" value=""></input>
            <br></br>
            <button class="buttons" id="users/login">Login to server</button>
            <label id="user-login-session-id-label">User Login Session ID:</label>
            <input id="user-login-session-id"></input>    
            <br></br> 
            <button class="buttons" id="ExtendSim/getUserModelPaths">Get user model paths</button>
            <select id="user-models"></select>
            <br></br>   
            <label id="scenario-name-label">Scenario name:</label>
            <input id="scenario-name"></input>
        </div>
        <button class="buttons" id="ExtendSim/createScenarioFolder">Create scenario folder</button>
        <label id="user-scenario-folder-pathname-label">Scenario folder pathname:</label>
        <input id="user-scenario-folder-pathname"></input>
        <br></br>
        <button class="buttons" id="ExtendSim/copyModelToScenarioFolder">Copy model to scenario folder</button>
        <label id="model-copied-status-label">Model copied:</label>
        <input id="model-copied-status" type="checkbox"></input>
        <br></br>
        <div id="scenario-input-files">
            <h3>Scenario Input Files</h3>
            <button onclick='addInputFilesTableRow()'>Add row</button>
            <button onclick='deleteInputFilesTableRow()''>Delete row</button>
            <table id="input-files-table" style="width:auto">
            </table>
            <button class="upload-files" id="ExtendSim/sendfile">Upload scenario input files to server</button>
            <label id="files-uploaded-status-label">Files uploaded:</label>
            <input id="files-uploaded-status" type="checkbox"></input>
        </div>
        <div id="scenario-database-inputs">
            <h3>Scenario Database Inputs</h3>
            <button onclick='addNewDatabaseInputsTableRow()'>Add row</button>
            <button onclick='deleteDatabaseInputsTableRow()'>Delete row</button>
            <table id="database-inputs-table" style="width:auto">
                <tr>
                    <th>
                        Source data file
                    </th>
                    <th>
                        Target Database
                    </th>
                    <th>
                        Target Table
                    </th>
                </tr>
            </table>
            <button class="upload-database-inputs" id="ExtendSim/sendfile">Upload inputs to dialog variables</button>
            <label id="database-inputs-uploaded-status-label">Files uploaded:</label>
            <input id="database-inputs-uploaded-status" type="checkbox"></input>
        </div>
        <br></br>
        <div id="submit-simulation">
            <button class="buttons" id="ExtendSim/submitsimulationscenario">Submit scenario</button>
            <label id="scenario-id-label">Scenario ID:</label>
            <input id="scenario-id"></input>
            <button class="buttons" id="ExtendSim/checkmodelrunstatus">Check scenario status</button>
            <label id="scenario-status-label">Scenario status:</label>
            <input id="scenario-status"></input>
        </div>
    </div>
    <script type="text/javascript">
    var uploadedFiles = [];
    var selectedFiles = [];
    var modelDatabases = [];
    var inputFileTableRows = 0;
    var databaseInputsTableRows = 0;
    const scenarioStatusValues = ['Waiting to run', 'Running', 'Completed', 'Aborted']
    var numFilesUploaded = 0;
    function filesSelected(event) {
        var files = $("#" + event.target.id)[0].files;
        if (files) {
            [].forEach.call(files, readAndPreview);
        }
        enableDisableUploadFilesButton();
    }
    function readAndPreview(file) {
        var reader  = new FileReader();
        reader.onload = function(event) {
            var contents = event.target.result;
            uploadedFiles[numFilesUploaded].data = contents;
           numFilesUploaded++;
        };

        if (file) {
            uploadedFiles.push({ name: file.name });
            selectedFiles.push(file);
            reader.readAsText(file);
        }
    }
    function enableDisableUploadFilesButton() {
        if (selectedFiles.length === 0)  {
            $('.upload-files').prop('disabled', true);
        }
        else {
            $('.upload-files').prop('disabled', false);
        }
    }
    function enableDisableCopyModelToScenarioFolderButton() {
        const scenarioFolderPathname = $("#user-scenario-folder-pathname").val();
        const userModelPathname = $("#user-models").val();
    }
    function addInputFilesTableRow() {
        var table = $("#input-files-table");
        inputFileTableRows++;
        var newrow = '<tr><td><input type="file" onchange="filesSelected(event)" class="input-file-row" id="input-button-' + inputFileTableRows + '"></td></tr>';
        table.append(newrow);
    }

    function deleteInputFilesTableRow(event) {
        $("#input-files-table tr:last").remove();
    }

    function addNewDatabaseInputsTableRow() {
        var table = $("#database-inputs-table");
        databaseInputsTableRows++;
        var newrow = 
        '<tr><td><input type="file" id="database-input-button-' + databaseInputsTableRows + '" onchange="filesSelected(event)" class="input-file-row"></td><td><select id="target-database-' + databaseInputsTableRows + '"></select></td><td><select id="target-table' + databaseInputsTableRows + '"></select></td></tr>'
        table.append(newrow);
        var targetDatabase = '#target-database-' + databaseInputsTableRows;
        for (var i = 0; i < modelDatabases.length; i++) {
            $(targetDatabase).append('<option value="' + modelDatabases[i].name + '">' + modelDatabases[i].name + '</option>');
        }
        if (modelDatabases.length > 0) {
            $(targetDatabase).val(modelDatabases[0].name);
        }
        alert("Num tables = " + modelDatabases[0].tableNames.length);
        var targetTable = '#target-table-' + databaseInputsTableRows;
        for (var i = 0; i < modelDatabases[0].tableNames.length; i++) {
            $(targetTable).append('<option value="' + modelDatabases[0].tableNames[i] + '">' + modelDatabases[0].tableNames[i] + '</option>');
        }
        if (modelDatabases[0].tableNames.length > 0) {
            $(targetTable).val(modelDatabases[0].tableNames[0]);
        }
    }

    function deleteDatabaseInputsTableRow(event) {
        $("#database-inputs-table tr:last").remove();  
    }
    function CopyTextFilesToServer(fileIndex) {
        var reader = new FileReader();

        reader.onload = function(event) {
        event.preventDefault();
        // alert("Copying file=" + uploadedFiles[fileIndex].name);
            axios({
                url: proxyurl + queryURL_root + "ExtendSim/sendfile",
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data : {
                    scenarioFolderPathname: $("#user-scenario-folder-pathname").val(),
                    filename: selectedFiles[fileIndex].name,
                    filedata: reader.result
                }
            })
            .then(function(response) {
                fileIndex++;
                if (fileIndex < selectedFiles.length) {
                    CopyTextFilesToServer(fileIndex);
                } else {
                    $("#files-uploaded-status").prop('checked', true);
                }
            });
        }
        // alert('Reading uploaded file...');
        reader.readAsText(selectedFiles[fileIndex]);
    }
    
    function getmodeldatabases() {
        axios({
            url: proxyurl + queryURL_root + "ExtendSim/getmodeldatabases",
            method: 'post',
            accept : 'application/json',
            contentType: 'application/json;charset=utf-8',
            data : {
                modelPathname: $("#user-models").val(),
                closeModel: true
            }
        })
        .then(function(response) {
            modelDatabases= [];
            for (var i=0;i<response.data.modelDatabases.length;i++) {
                if (response.data.modelDatabases[i].charAt(0) !== "_") {
                    modelDatabases.push({ name: response.data.modelDatabases[i],
                                          tableNames: [] })
                    .then(getDatabaseTables(modelDatabases.length - 1));
                }
            };
        });
    }

    function getDatabaseTables(databaseIndex) {
        axios({
            url: proxyurl + queryURL_root + "ExtendSim/getmodeldatabasetables",
            method: 'post',
            accept : 'application/json',
            contentType: 'application/json;charset=utf-8',
            data : {
                modelPathname: $("#user-models").val(),
                database: modelDatabases[databaseIndex].name,
                closeModel: true
            }
        })
        .then(function(response) {
            modelDatabases[databaseIndex].tableNames = response.data.modelDatabaseTables;
        });
    }


    const IPaddress = "http://184.171.246.58";
    // const IPaddress = "localhost";
    // var queryURL_root = "http://" + IPaddress + ":8090/StreamingService/web/"
    var queryURL_root =  IPaddress + ":3001/api/"
    var queryURL_root2 = "http://" + IPaddress + ":3001/api/users/login/"
    var queryURL = "http://" + IPaddress + ":8090/StreamingService/web/LoginToServer"
    var queryURL2 = "http://" + IPaddress + ":8090/StreamingService/web/EchoWithGet"
    var queryURL3 = "http://" + IPaddress + ":8090/StreamingService/web/GetServerDirectoryFiles"
    // var queryURL = "http://" + IPaddress + ":8090/StreamingService/web/LoginToServer?username=analyst1&password=model"
    // const proxyurl = "https://cors-anywhere.herokuapp.com/";
    const proxyurl = "";
    const pathname = "C:\Users\Administrator\Documents\ExtendSim10ASP_Prod\ASP\ASP Servers\ExtendSim Models\Analyst 1";

    const username = 'analyst1';
    const password = 'model';

    $('.buttons').prop('disabled', true);
    $('.upload-files').prop('disabled', true);
    $("#model-copied-status").prop('checked', false);

    enableDisableUploadFilesButton();

    // Event listener for all button elements
    $("button").on("click", function() {
      // In this case, the "this" keyword refers to the button that was clicked
      switch (this.id) {
        case 'users/login':

            axios({
                url: proxyurl + queryURL_root + this.id,
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data : {
                    username:  $("#username").val(),
                    password: $("#password").val()
                }
            })
            .then(function(response) {
                // Storing an array of results in the results variable
                // alert('Axios POST parameters result=' + JSON.stringify(response.data));
                $("#user-login-session-id").val(response.data.userLoginSessionID);
            });
          break;

        case 'ExtendSim/createScenarioFolder':

            axios({
                url: proxyurl + queryURL_root + this.id,
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                // params: {
                data: {
                    userLoginSessionID : $("#user-login-session-id").val(),
                    scenarioFolderName : $("#scenario-name").val(),
                }
            })
            .then(function(response) {
                // Storing an array of results in the results variable
                // alert('Axios POST parameters result=' + JSON.stringify(response.data));
                $("#user-scenario-folder-pathname").val(response.data.scenarioFolderPathname);
                this.enableDisableCopyModelToScenarioFolderButton();
            });
            break;

        case 'ExtendSim/getUserModelPaths':

            axios({
                url: proxyurl + queryURL_root + this.id,
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data: {
                    username : $("#username").val(),
                }
            })
            .then(function(response) {
                var userModelPaths = response.data.userModelPaths;
                for (var i = 0; i < userModelPaths.length; i++) {
                    $('#user-models').append('<option value="' + userModelPaths[i] + '">' + userModelPaths[i] + '</option>');
                }
                if (userModelPaths.length > 0) {
                    $('#user-models').val(userModelPaths[0]);
                }
                this.enableDisableCopyModelToScenarioFolderButton();
                getmodeldatabases();
            });
            break;

        case 'ExtendSim/copyModelToScenarioFolder':

            axios({
                url: proxyurl + queryURL_root + this.id,
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data: {
                    modelPathname: $("#user-models").val(),
                    scenarioFolderPathname: $("#user-scenario-folder-pathname").val(),
                    copyFolderContents: true
                }
            })
            .then(function(response) {
                $("#model-copied-status").prop('checked', true);
                $("#model-copied-status").prop('disabled', true);
            });
            break;

        case 'ExtendSim/sendfile':

            CopyTextFilesToServer(0);
            break;

        case 'ExtendSim/submitsimulationscenario':

            var modelName =  $("#user-models").val();
            modelName = modelName.substring(modelName.lastIndexOf("\\") + 1);
            axios({
                url: proxyurl + queryURL_root + this.id,
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data: {
                    userLoginSessionID: $("#user-login-session-id").val(),
                    modelPathname:  $("#user-scenario-folder-pathname").val() + "\\" + modelName,
                    removeFolderOnCompletion: false
                }
            })
            .then(function(response) {
                $("#scenario-id").val(response.data.scenarioID);
            });
            break;

        case 'ExtendSim/checkmodelrunstatus':
        
            axios({
                url: proxyurl + queryURL_root + this.id,
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data: {
                    scenarioID: $("#scenario-id").val(),
                }
            })
            .then(function(response) {
                $("#scenario-status").val(scenarioStatusValues[response.data.modelRunStatus - 1]);
            });
           break;
      }
    });

  $('.login').keyup(function () {
    if (($("#username").val() === '') || ($("#password").val() === '')) {
        //Check to see if there is any text entered
        // If there is no text within the input ten disable the button
        $('.buttons').prop('disabled', true);
    } else {
        //If there is text in the input, then enable the button
        $('.buttons').prop('disabled', false);
    }
});
  </script>
</body>

</html>
