<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>ExtendSim ASP API tester</title>
</head>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>        
    <div id="extendsim-asp-axios-tester-frame">
        <form>
            Username: <input class="login" id="username" type="text" name="username" value=""></input>
            <br></br>
            Password: <input class="login" id="password" type="password" name="password" value=""></input>
            <br></br>
        </form>
        <button class="buttons" id="users/login">Login to server</button>
        <label id="user-login-session-id-label">User Login Session ID:</label>
        <input id="user-login-session-id"></input>
        <br></br>
        <button class="buttons" id="ExtendSim/createScenarioFolder">Create scenario folder</button>
        <label id="user-scenario-folder-pathname-label">Scenario folder pathname:</label>
        <input id="user-scenario-folder-pathname"></input>
        <br></br>
        <button class="buttons" id="ExtendSim/getUserModelPaths">Get user model paths</button>
        <label id="user-models-label" >User models:</label>
        <select id="user-models"></select>
        <br></br>
        <button class="buttons" id="ExtendSim/copyModelToScenarioFolder">Copy model to scenario folder</button>
        <label id="model-copied-status-label">Model copied:</label>
        <input id="model-copied-status" type="checkbox"></input>
        <br></br>
        <input type="file" onchange="filesSelected(event)" multiple>
        <button class="upload-files" id="ExtendSim/sendfile">Upload scenario input files to server</button>
        <label id="files-uploaded-status-label">Files uploaded:</label>
        <input id="files-uploaded-status" type="checkbox"></input>
        <br></br>
        <button class="buttons" id="ExtendSim/submitsimulationscenario">Submit scenario</button>
        <label id="scenario-id-label">Scenario ID:</label>
        <input id="scenario-id"></input>
        <button class="buttons" id="ExtendSim/checkmodelrunstatus">Check scenario status</button>
        <label id="scenario-status-label">Scenario status:</label>
        <input id="scenario-status"></input>

    </div>
    <script type="text/javascript">
    var uploadedFiles = [];
    var selectedFiles = [];
    const scenarioStatusValues = ['Waiting to run', 'Running', 'Completed', 'Aborted']
    var numFilesUploaded = 0;
    function filesSelected(event) {
        var files = $('input[type=file]')[0].files;
        if (files) {
            [].forEach.call(files, readAndPreview);
        }
        enableDisableUploadFilesButton();
    }
    function readAndPreview(file) {
        var reader  = new FileReader();
        reader.onload = function(event) {
            var contents = event.target.result;
            uploadedFiles[numFilesUploaded].data = contents;
            // alert('file name=' + uploadedFiles[numFilesUploaded].name);
           numFilesUploaded++;
        };

        if (file) {
            uploadedFiles.push({ name: file.name });
            selectedFiles.push(file);
            reader.readAsText(file);
        }
    }
    function enableDisableUploadFilesButton() {
        if (selectedFiles.length === 0)  {
            $('.upload-files').prop('disabled', true);
        }
        else {
            $('.upload-files').prop('disabled', false);
        }
    }
    function enableDisableCopyModelToScenarioFolderButton() {
        const scenarioFolderPathname = $("#user-scenario-folder-pathname").val();
        const userModelPathname = $("#user-models").val();
        // if ((scenarioFolderPathname.length === 0) ||
        //     (userModelPathname.length === 0)) {
        //     $('#ExtendSim/CopyModelToScenarioFolder').prop('disabled', true);
        // }
        // else {
        //     $('#ExtendSim/CopyModelToScenarioFolder').prop('disabled', false);
        // }
    }

    function CopyTextFilesToServer(fileIndex) {
        var reader = new FileReader();

        reader.onload = function(event) {
        event.preventDefault();
        // alert("Copying file=" + uploadedFiles[fileIndex].name);
            axios({
                url: proxyurl + queryURL_root + "ExtendSim/sendfile",
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data : {
                    scenarioFolderPathname: $("#user-scenario-folder-pathname").val(),
                    filename: selectedFiles[fileIndex].name,
                    filedata: reader.result
                }
            })
            .then(function(response) {
                fileIndex++;
                if (fileIndex < selectedFiles.length) {
                    CopyTextFilesToServer(fileIndex);
                } else {
                    $("#files-uploaded-status").prop('checked', true);
                }
            });
        }
        // alert('Reading uploaded file...');
        reader.readAsText(selectedFiles[fileIndex]);
    }

    $("#user-login-session-id").width(300);
    $("#user-login-session-id-label").css("margin-left", 20);
    $("#user-scenario-folder-pathname").width(600);
    $("#user-scenario-folder-pathname-label").css("margin-left", 20);
    $("#user-models-label").css("margin-left", 20);
    $("#extendsim-asp-axios-tester-frame").css("width", '90%'); 
    $("#extendsim-asp-axios-tester-frame").css("padding", 10); 
    $("#extendsim-asp-axios-tester-frame").css({"border-color": "blue", 
                                                "border-width":"2px", 
                                                "border-style":"solid",
                                                "border-radius": 10,
                                                "background-color": '#c9d6ff'});
    $("#model-copied-status-label").css("margin-left", 20);
    $("#upload-filename-label").css("margin-left", 20);
    $("#files-uploaded-status-label").css("margin-left", 20);
    $("#scenario-id-label").css("margin-left", 20);
    $("#scenario-id").css("margin-right", 20);
    $("#scenario-status-label").css("margin-left", 20);

    const IPaddress = "http://184.171.246.58";
    // const IPaddress = "localhost";
    // var queryURL_root = "http://" + IPaddress + ":8090/StreamingService/web/"
    var queryURL_root =  IPaddress + ":3001/api/"
    var queryURL_root2 = "http://" + IPaddress + ":3001/api/users/login/"
    var queryURL = "http://" + IPaddress + ":8090/StreamingService/web/LoginToServer"
    var queryURL2 = "http://" + IPaddress + ":8090/StreamingService/web/EchoWithGet"
    var queryURL3 = "http://" + IPaddress + ":8090/StreamingService/web/GetServerDirectoryFiles"
    // var queryURL = "http://" + IPaddress + ":8090/StreamingService/web/LoginToServer?username=analyst1&password=model"
    // const proxyurl = "https://cors-anywhere.herokuapp.com/";
    const proxyurl = "";
    const pathname = "C:\Users\Administrator\Documents\ExtendSim10ASP_Prod\ASP\ASP Servers\ExtendSim Models\Analyst 1";

    const username = 'analyst1';
    const password = 'model';

    $('.buttons').prop('disabled', true);
    $('.upload-files').prop('disabled', true);
    // $('#CopyModelToScenarioFolder').prop('disabled', true);
    $("#model-copied-status").prop('checked', false);
    // $("#model-copied-status").prop('disabled', true);
    // $("#ExtendSim/sendfile").prop('disabled', true);

    enableDisableUploadFilesButton();

    // Event listener for all button elements
    $("button").on("click", function() {
      // In this case, the "this" keyword refers to the button that was clicked
      switch (this.id) {
        case 'users/login':

          axios({
            url: proxyurl + queryURL_root + this.id,
            method: 'post',
            accept : 'application/json',
            contentType: 'application/json;charset=utf-8',
            data : {
                username:  $("#username").val(),
                password: $("#password").val()
            }
            })
            .then(function(response) {
                // Storing an array of results in the results variable
                // alert('Axios POST parameters result=' + JSON.stringify(response.data));
                $("#user-login-session-id").val(response.data.userLoginSessionID);
              });
          break;
        case 'ExtendSim/createScenarioFolder':

            axios({
                url: proxyurl + queryURL_root + this.id,
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                // params: {
                data: {
                    userLoginSessionID :  $("#user-login-session-id").val(),
                    scenarioFolderName : 'myTestScenario',
                }
            })
            .then(function(response) {
                // Storing an array of results in the results variable
                // alert('Axios POST parameters result=' + JSON.stringify(response.data));
                $("#user-scenario-folder-pathname").val(response.data.scenarioFolderPathname);
                this.enableDisableCopyModelToScenarioFolderButton();
            });
            break;

        case 'ExtendSim/getUserModelPaths':

            axios({
                url: proxyurl + queryURL_root + this.id,
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data: {
                    username : $("#username").val(),
                }
            })
            .then(function(response) {
                var userModelPaths = response.data.userModelPaths;
                for (var i = 0; i < userModelPaths.length; i++) {
                    $('#user-models').append('<option value="' + userModelPaths[i] + '">' + userModelPaths[i] + '</option>');
                }
                if (userModelPaths.length > 0) {
                    $('#user-models').val(userModelPaths[0]);
                }
                this.enableDisableCopyModelToScenarioFolderButton();
            });
            break;

        case 'ExtendSim/copyModelToScenarioFolder':

            axios({
                url: proxyurl + queryURL_root + this.id,
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data: {
                    modelPathname: $("#user-models").val(),
                    scenarioFolderPathname: $("#user-scenario-folder-pathname").val(),
                    copyFolderContents: true
                }
            })
            .then(function(response) {
                $("#model-copied-status").prop('checked', true);
                $("#model-copied-status").prop('disabled', true);
            });
            break;

        case 'ExtendSim/sendfile':

            CopyTextFilesToServer(0);
            break;

        case 'ExtendSim/submitsimulationscenario':

            var modelName =  $("#user-models").val();
            modelName = modelName.substring(modelName.lastIndexOf("\\") + 1);
            axios({
                url: proxyurl + queryURL_root + this.id,
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data: {
                    userLoginSessionID: $("#user-login-session-id").val(),
                    modelPathname:  $("#user-scenario-folder-pathname").val() + "\\" + modelName,
                    removeFolderOnCompletion: false
                }
            })
            .then(function(response) {
                $("#scenario-id").val(response.data.scenarioID);
            });
            break;

        case 'ExtendSim/checkmodelrunstatus':
        
            axios({
                url: proxyurl + queryURL_root + this.id,
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data: {
                    scenarioID: $("#scenario-id").val(),
                }
            })
            .then(function(response) {
                $("#scenario-status").val(scenarioStatusValues[response.data.modelRunStatus - 1]);
            });
           break;
      }
    });

  $('.login').keyup(function () {
    if (($("#username").val() === '') || ($("#password").val() === '')) {
        //Check to see if there is any text entered
        // If there is no text within the input ten disable the button
        $('.buttons').prop('disabled', true);
    } else {
        //If there is text in the input, then enable the button
        $('.buttons').prop('disabled', false);
    }
});
  </script>
</body>

</html>
