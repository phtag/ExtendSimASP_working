<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>ExtendSim ASP API tester</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.rawgit.com/eligrey/FileSaver.js/5ed507ef8aa53d8ecfea96d96bc7214cd2476fd2/FileSaver.min.js"></script>
<style>
    table, th, td {
      border: 1px solid black;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 5px;
      text-align: left;    
    }
    .login {
        margin-left: 5px;
        margin-right: 20px;
        flex: 1;
        max-width: 400px;
    }
    .input-file-row {
        width: auto;
    }
    .table-row {
        width: auto;
    }
    .database-input-row {
        width: auto;
    }
    .upload-files-button {
        margin-top: 10px;
        margin-right: 10px;
        
    }
    .upload-database-inputs-button {
        margin-top: 10px;
        margin-right: 10px;
    }
    .upload-dialog-inputs-button, .download-dialog-outputs-button {
        margin-top: 10px;
        margin-right: 10px;
    }
    /* The Modal (background) */
    .modal {
        font-family: Arial, Helvetica, sans-serif;
        font-size: 12px;
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        padding-top: 80px; /* Location of the box */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        background-color: rgb(0,0,0); /* Fallback color */
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
    }
    /* Modal Content */
    .modal-content {
        background-color: #fefefe;
        margin: auto;
        overflow: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        height: 60%;
        align-content: center;
    }
    div#load_screen {
        background: black;
        opacity: .8;
        position: fixed;
        top: 0px;
        width: 100%;
        height: 100%;
        z-index: 20;
    }
    div#load_screen > #loading {
        font-family: Arial, Helvetica, sans-serif;
        font-size: 30px;
        text-align: center;
        font-weight: bold;
        color: #FFFFFF;
        width: 50%;
        height: 20px;
        margin: 300px auto;
    }
    .scenario-buttons, #remove-selected-scenario-folders-button {
        margin: auto;
        text-align: center;
    }
    .table-checkboxes {
        text-align: center;
    }
    .input-label {
        margin-left: 5px;
        text-align: center;
        width: auto;
    }
    #chart-type-select-label, #modal-x-axis-field-select-label, #modal-y-axis-field-select-label {
        font-weight: bold;
    }
    #modal-chart-container {
        height: 100%;
    }
    /* #modal-form-chart {
        height: 100%;
    } */
    #modal-x-axis-field-select, #modal-y-axis-field-select  {
        margin-right: 10px;
    }
        
    #login-section, #remove-selected-button {
        text-align: left;
        margin: auto;
    }
    #remove-selected-button {
        text-align: center;
        margin: auto;
    }
    #save-scenario-definition {
        margin: 0px 20px 20px 20px;
    }
    #selected-response-table-name-label {
        font-size: 18px;
        font-family: Arial, Helvetica, sans-serif;
        font-weight: bold;
    }
    .section-header-checkboxes {
        text-align: center;
        font-weight: bold;
        font-size: 26px;
        margin-bottom: 15px;
    }
    .sub-section-header-checkboxes {
        text-align: center;
        font-weight: bold;
        font-size: 23px;
        margin-bottom: 15px;
    }
    .modal-form {
        padding: 10px;
        /* margin: 0px auto 10px; */
        margin: 10px auto;
        width: auto;
        max-width: 500px;
        z-index: 100;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 14px;
        border-width: 2px;
        border-style: solid;
        border-radius: 10px;
        border-color: blue,;
        background-color: #dbe3ff;
        text-align: center;
    }
    .modal-buttons {
        margin: 0px 10px 0px 10px;   
    }
    #modal-chart-axes-selection-dropdowns {
        /* padding: 20px; */
        margin: 2%;
        background-color: rgb(216, 216, 216);
        border-width: 2px;
        border-style: solid;
        border-radius: 10px;
        border-color: rgb(0, 0, 0);
    }
    #scenarios-table-container {
        text-align: center;
        margin: auto;
    }
    #create-scenario-folder-button {
        visibility: visible;
        margin-left: 20px;
    }

    #selected-database-outputs-table th, #selected-file-contents-table  th {
        background-color: rgb(251, 119, 119);
        color: white;
        position: sticky; top: -20px;
        text-align: center;
    }
    #selected-database-outputs-table td, #selected-file-contents-table td {
        background-color: rgb(255, 255, 255);
        color: black;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 14px;
        text-align: center;
        font-weight: normal;
    }
    #database-outputs-table th, #dialog-outputs-table th, #file-outputs-table th {
        background-color: #4CAF50;
        color: white;
        text-align: center;
    }
    #scenarios-table th {
        background-color: rgb(73, 70, 248);
        color: white;
        text-align: center;    
    }
    #scenarios-table td {
        font-size: 12px;
        font-weight: normal;
        background-color: #ecedf0;
    }
    #scenarios-table tr:hover {
        background-color:gray;
        cursor:pointer;
    }
    #scenarios-table {
        margin-bottom: 20px;
        margin-right: 2%;
        display: inline-table; 
        
    }
    .scroll-container {
        scroll-padding: 50px 50px 50px 50px;
    }

    .close {
        color: #aaaaaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close:hover,
    .close:focus {
        color: #000;
        text-decoration: none;
        cursor: pointer;
    }

    .flex-container {
        display: flex;
        margin-bottom: 5px;
    }
    .fill-width {
        flex: 1;
    }
    .scenario-tables {
        margin: 10px auto;
    }
    #extendsim-asp-title-heading {
        font-size: 28px;
        font-weight: bold;
        text-align: center;
        margin: 20px;
        color: rgb(0, 0, 172);
    }
    #user-login-title-heading {
        font-size: 20px;
        font-weight: bold;
        text-align: center;
        margin-bottom: 20px;
    }
    #scenario-factors-title-heading, #scenario-responses-title-heading {
        font-size: 20px;
        font-weight: bold;
        text-align: center;
    }
    #submit-scenario-title-heading {
        font-size: 20px;
        font-weight: bold;
        text-align: center;
        margin-bottom: 20px;
    }    
    #extendsim-asp-header {
        background-image:url(https://extendsim.com/templates/extendsim/images/ES_logo.gif);
        background-repeat:no-repeat;
        width: 100%;
        margin-top: -30px;
        margin-left: -10px;
        height: 100px;
        position: fixed;
        background-color: whitesmoke;
        z-index: 10;
    }
    #page-container {
        margin: 0 auto;
        text-align: center;
    }
    #extendsim-asp-axios-tester-frame {
        margin-top: 80px;
        width: 90%;
        min-width: 605px;
        padding: 10px;
        padding: 2%;
        border-color: blue,;
        border-width: 2px;
        border-style: solid;
        border-radius: 10px;
        background-color: #c9d6ff;
        font-size: 14px;
        font-family: Arial, Helvetica, sans-serif;
        font-weight: bold;
        display: inline-block;    
    }
    #file-inputs-table, #database-inputs-table, #dialog-inputs-table {
        background-color: #ecedf0;
    }
    #file-inputs-table th, #database-inputs-table th, #dialog-inputs-table th {
        background-color: rgb(251, 140, 76);
        color: white;
        text-align: center;
    }
    #scenario-name {
        width: 60%;
    }
    #username, #password {
        width: 40%;
    }
    #user-login-session-id {
        width: 50%;
    }
    #ip-address {
        max-width: 100px;
    }
    #user-login-session-id-label {
        margin-left: 20px;
    }
    #user-scenario-folder-pathname {
        width: 600px;
    }
    #user-models-label {
        margin-left: 20px;
    }
    #model-copied-status-label {
        margin-left: 20px;
    }
    #upload-filename-label {
        margin-left: 20px;
    }
    #user-scenario-folder-pathname {
        margin-right: 20px;
        resize: horizontal;
        max-width: 700px;
    }
    #scenario-model-label {
        margin-right: 10px;
        font-weight: bold;
    }
    #scenario-id {
        margin-right: 20px;
    }
    #scenario-status-label {
        margin-left: 20px;
    }
    #submit-scenarios {
        text-align: center;
        margin-top: 0px;
        margin-bottom: 20px;
    }
    #scenario-factors-body, #scenario-responses-body {
        text-align: center;
        margin-left: 2%;
        margin-right: 2%;
        margin-bottom: 20px;
    }
    #scenario-user-login-body, #scenario-setup-body, #scenarios-body {
        text-align: left;
        margin-left: 2%;
        margin-right: 2%;
        margin-bottom: 20px;
        /* overflow-x: auto; */
    }
    #scenarios-body {
        text-align: center;
        margin: auto;
    }
    #scenario-user-login, #scenario-definition, #scenarios {
        border: 2px solid rgb(0, 0, 0);
        border-radius: 10px;
        padding-top: 35px;
        padding-bottom: 25px;
        padding-left: 3%;
        padding-right: 3%;
        margin: 40px auto;
        /* margin-bottom: 20px; */
        width: auto;
        background-color:rgb(221, 220, 220);
        text-align: center; 
        vertical-align:top; 
        min-width: 580px;  
    }
    #scenario-setup, #scenario-factors, #scenario-responses {
        border: 2px solid rgb(0, 0, 0);
        border-radius: 10px;
        padding-top: 15px;
        padding-left: 10px;
        padding-right: 10px;
        margin: auto;
        margin-bottom: 20px;
        width: auto;
        background-color:rgb(221, 220, 220);
        text-align: center; 
        vertical-align: top; 
    }
    #scenario-setup  {
        background-color:rgb(247, 155, 155);
        min-width: 550px;
    }
    #scenario-factors  {
        background-color:rgb(252, 235, 162);
        min-width: 550px;
    }
    #scenario-responses {
        background-color:rgb(155, 251, 195);
        min-width: 550px;
    }

    #scenario-file-inputs, #scenario-database-inputs, #scenario-dialog-inputs {
        border: 2px solid rgb(255, 94, 0);
        border-radius: 10px;
        padding: 15px;
        margin: 10px auto;
        text-align: center;
        width: auto;
        min-width: 300px;
        background-color:rgb(253, 246, 204);
        vertical-align:top;  
        overflow: auto; 
        font-size: 18px;   
    }
    #scenario-file-inputs-body, #scenario-database-inputs-body, #scenario-dialog-inputs-body, #scenario-file-outputs-body, #scenario-database-outputs-body, #scenario-dialog-inputs-body, #scenario-dialog-outputs-body, #scenarios-table-body {
        margin: 10px auto;
        width: auto;
        text-align: center;
        overflow-x: scroll;
    }
    #scenario-database-outputs, #scenario-file-outputs, #scenario-dialog-outputs {
        border: 2px solid rgb(0, 88, 15);
        border-radius: 10px;
        padding: 15px;
        background-color:rgb(204, 253, 212);
        border-radius: 10px;
        padding: 15px;
        margin: 10px auto;
        text-align: center;
        width: auto;
        min-width: 300px;
        vertical-align: top;  
        overflow: auto; 
        font-size: 18px;   
    }
    #chart-axes, #chart-type {
        margin: 10px;
    }
    #submit-simulation {
        border: 2px solid rgb(0, 0, 0);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        background-color: rgb(248, 179, 179);
        width: auto;
        clear: left;
    }
    #scenarios-table-body {
        border: 2px solid rgb(4, 0, 253);
        border-radius: 10px;
        padding: 15px;
        margin: 2%;
        width: 50%;
        background-color:rgb(204, 205, 253);
        display: inline-block;
        vertical-align:top;  
        font-size: 18px;   
        text-align: center; 
    }
    </style>
</head>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>   
    <header class="header" id="extendsim-asp-header"></header>
    <div id="database-table-modal" class="modal">
        <div class="modal-form">
            <label id="selected-response-table-name-label">Table name:</label>
            <input id="selected-response-table-name" type='text' readonly></input>
            <div id='modal-chart-axes-selection-dropdowns'>
                <div id="chart-type">
                    <label id='chart-type-select-label' for='chart-type-select'>Chart type:</label>
                    <select id='chart-type-select'></select> 
                </div>
                <div id="chart-axes">
                    <label id='modal-x-axis-field-select-label' for='modal-x-axis-field-select'>X-axis:</label>
                    <select id='modal-x-axis-field-select'></select>
                    <label id='modal-y-axis-field-select-label' for='modal-y-axis-field-select'>Y-axis:</label>
                    <select id='modal-y-axis-field-select'></select>
                </div>
            </div>
            <button class="buttons, modal-buttons" id="view-model-chart-button" onclick="viewModalChart()">View chart</button>
            <button class="buttons, modal-buttons" id="export-table-contents-modal" onclick="exportDataTableToTextFile('selected-database-outputs-table')">Export</button>
            <button class="buttons, modal-buttons" id="close-database-table-contents-modal" onclick="closeDatabaseTableContentsModal(event)">Close</button>
       </div>  
        <div class="modal-content">
            <div id="modal-form-contents">
                <table class="scenario-tables" id="selected-database-outputs-table" style="width:auto">
                </table>
            </div>
            <div id="modal-chart-container">
                <canvas id="modal-form-chart"  width=auto></canvas>
            </div>
        </div>
    </div> 

    <div id="file-contents-modal" class="modal">
        <div class="modal-form">
            <label id="selected-file-name-label">File name:</label>
            <input id="selected-file-name" type='text' readonly></input>
            <button class="buttons" id="export-file-contents-modal" onclick="exportDataTableToTextFile('selected-file-contents-table')">Export</button>
            <button class="buttons" id="close-file-contents-modal" onclick="closeFileContentsModal(event)">Close</button>
        </div>  
        <div class="modal-content">
            <div id="modal-form-contents">
                <table class="scenario-tables" id="selected-file-contents-table" style="width:auto">
                </table>
            </div>
            <div class="container">
                <canvas id="modal-form-chart"  width=auto></canvas>
            </div>
        </div>
    </div>     

    <div id='page-container'>
    <div id="load_screen"><div id="loading">Loading data from server. Please wait...</div></div>
    <div id="extendsim-asp-axios-tester-frame">
        <div id="extendsim-asp-title-heading">ExtendSim ASP Scenario Manager</div>
        <div id="scenario-user-login">
            <!-- <header id="user-login-title-heading">User Login</header> -->
            <div class='section-header-checkboxes'>
                <input type='checkbox' id='scenario-user-login-checkbox' onclick='updateDOMelementVisibility("scenario-user-login")'>User Login</input>
            </div>
            <div id='scenario-user-login-body'>
                <div class="flex-container">
                    <label  for='username'>
                        Username:
                    </label> 
                    <input class="login" id="username" type="text" name="username" value="analyst2"></input>
                    <label  for='password'>
                        Password: 
                    </label>
                    <input class="login" id="password" type="password" name="password" value="model"></input>        
                </div>
                <div class="flex-container">
                    <label for='ip-address'>
                    IP address:
                    </label>
                    <input class="login" id="ip-address" value="184.171.246.58"></input>            
                </div>
                <div class="flex-container" id='login-section'>
                    <button class="buttons" id="login-button" onclick='loginToServer()'>Login to server</button>
                    <label id="user-login-session-id-label">User Login Session ID:</label>
                    <input class="login" id="user-login-session-id"></input>        
                </div>
            </div>
        </div>
        <div id="scenario-definition">
            <div class='section-header-checkboxes'>
                <input class='scenario-definition-checkboxes' type='checkbox' id='scenario-definition-checkbox' onclick='updateDOMelementVisibility("scenario-definition")'>Scenario Definition</input>
            </div>  
            <div id="scenario-definition-body">
                <div id="scenario-setup">
                    <div class='sub-section-header-checkboxes'>
                        <input type='checkbox' id='scenario-setup-checkbox' onclick='updateDOMelementVisibility("scenario-setup")'>Setup</input>
                    </div>
                    <div class="flex-container" id='scenario-setup-body'>
                        <label id="scenario-model-label">Scenario model:</button>
                        <select onchange="updateModelInfo()" id="user-models"></select>           
                        <br></br>
                        <label id="scenario-name-label">Scenario name:</label>
                        <input id="scenario-name"></input>
                    </div>
                </div>
                <div id="scenario-factors">
                    <div class='sub-section-header-checkboxes'>
                        <input type='checkbox' id='scenario-factors-checkbox' onclick='updateDOMelementVisibility("scenario-factors")'>ExtendSim Model Factors</input>
                    </div>
                    <div id='scenario-factors-body'>
                        <div id="scenario-file-inputs">
                            <div>
                                <input id="scenario-file-inputs-checkbox" type="checkbox" onclick='updateDOMelementVisibility("scenario-file-inputs")'>External Input Files</input>    
                            </div>
                            <div id="scenario-file-inputs-body">
                                <button class="scenario-file-input-buttons" onclick='addNewInputFilesTableRow()'>Add row</button>
                                <button class="scenario-file-input-buttons" onclick='deleteInputFilesTableRow()''>Delete row</button>
                                <table class="scenario-tables" id="file-inputs-table">
                                    <tr>
                                        <th>
                                            Input data file
                                        </th>
                                    </tr>
                                </table>
                                <button class="upload-files-button" onclick='uploadDataFilesToServer(0)''>Upload scenario input files to server</button>
                                <label id="files-uploaded-status-label">Files uploaded:</label>
                                <input id="files-uploaded-status" type="checkbox"></input>
                            </div>
                        </div>
                        <div id="scenario-database-inputs">
                            <div id="scenario-database-inputs-header">
                                <input type="checkbox" id="scenario-database-inputs-checkbox" onclick='updateDOMelementVisibility("scenario-database-inputs")'>Database Tables</input>    
                            </div>
                            <div id="scenario-database-inputs-body">
                                <button class="scenario-database-input-buttons" id="add-database-inputs-table-row" onclick='addNewDatabaseInputsTableRow()'>Add row</button>
                                <button class="scenario-database-input-buttons" id="delete-database-inputs-table-row" onclick='deleteDatabaseInputsTableRow()'>Delete row</button>
                                <table class="scenario-tables" id="database-inputs-table">
                                    <tr>
                                        <th>
                                            Source data file
                                        </th>
                                        <th>
                                            Target Database
                                        </th>
                                        <th>
                                            Target Table
                                        </th>
                                    </tr>
                                </table>
                                <button class="upload-database-inputs-button" onclick='uploadDataStreamsToModel(0)'>Upload inputs to database tables</button>
                                <label id="database-inputs-uploaded-status-label">Files uploaded:</label>
                                <input id="database-inputs-uploaded-status" type="checkbox"></input>
                            </div>
                        </div>
                        <div id="scenario-dialog-inputs">
                            <div >
                                <input type="checkbox" id="scenario-dialog-inputs-checkbox" onclick='updateDOMelementVisibility("scenario-dialog-inputs")'>Dialog Variables</input>    
                            </div>
                            <div id="scenario-dialog-inputs-body">
                                <button class="scenario-dialog-input-buttons" id="add-dialog-inputs-table-row" onclick='addNewDialogInputsTableRow()'>Add row</button>
                                <button class="scenario-dialog-input-buttons" id="delete-dialog-inputs-table-row" onclick='deleteDialogInputsTableRow()'>Delete row</button>
                                <button class="scenario-dialog-input-buttons" id="upload-dialog-inputs-file" onclick='uploadDialogInputsFile()'>Upload file</button>
                                <table class="scenario-tables" id="dialog-inputs-table" style="width:auto">
                                    <tr>
                                        <th>
                                            Block Type
                                        </th>
                                        <th>
                                            Block Number
                                        </th>
                                        <th>
                                            Type
                                        </th>
                                        <th>
                                            Name
                                        </th>
                                        <th>
                                            Value
                                        </th>
                                    </tr>
                                </table>
                                <button class="upload-dialog-inputs-button" onclick="uploadDialogVariableDataToModel(0)">Upload inputs to dialog variables</button>
                                <label id="dialog-inputs-uploaded-status-label">Inputs uploaded:</label>
                                <input id="dialog-inputs-uploaded-status" type="checkbox"></input>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="scenario-responses">
                    <div class='sub-section-header-checkboxes'>
                        <input type='checkbox' id='scenario-responses-checkbox' onclick='updateDOMelementVisibility("scenario-responses")'>ExtendSim Model Responses</input>
                    </div>
                    <div id='scenario-responses-body'>
                        <div id="scenario-file-outputs">
                            <div id="scenario-file-outputs-header">
                                <!-- <label id="scenario-file-outputs-checkbox-label">Model Files</label> -->
                                <input id="scenario-file-outputs-checkbox" type="checkbox" onclick='updateDOMelementVisibility("scenario-file-outputs")'>External Output Files</input>    
                            </div>
                            <div id="scenario-file-outputs-body">
                                <button class="scenario-file-output-buttons" id="add-file-outputs-table-row" onclick='addNewOutputFilesTableRow()'>Add row</button>
                                <button class="scenario-file-output-buttons" id="delete-file-outputs-table-row" onclick='deleteOutputFilesTableRow()'>Delete row</button>
                                <table class="scenario-tables" id="file-outputs-table" style="width:auto">
                                    <tr>
                                        <th>
                                            Scenario folder files
                                        </th>
                                        <th>
                                            Action
                                        </th>    
                                    </tr>
                                </table>
                            </div>  
                        </div>         
                        <div id="scenario-database-outputs">
                            <div id="scenario-database-outputs-header">
                                <!-- <label id="scenario-database-outputs-checkbox-label">Database Tables</label> -->
                                <input id="scenario-database-outputs-checkbox" type="checkbox" onclick='updateDOMelementVisibility("scenario-database-outputs")'>Database Tables</input>    
                            </div>
                            <div id="scenario-database-outputs-body">
                                <!-- <h3>Scenario Database Outputs</h3> -->
                                <button class="scenario-database-output-buttons" id="add-database-outputs-table-row" onclick='addNewDatabaseOutputsTableRow()'>Add row</button>
                                <button class="scenario-database-output-buttons" id="delete-database-outputs-table-row" onclick='deleteDatabaseOutputsTableRow()'>Delete row</button>
                                <table class="scenario-tables" id="database-outputs-table" style="width:auto">
                                    <tr>
                                        <th>
                                            Source Database
                                        </th>
                                        <th>
                                            Source Table
                                        </th>
                                        <th>
                                            Data
                                        </th>
                                        <th>
                                            Chart
                                        </th>
                                        <th>
                                            Export
                                        </th>           
                                    </tr>
                                </table>
                            </div>  
                        </div>    
                        <div id="scenario-dialog-outputs">
                            <div id="scenario-dialog-outputs-header">
                                <!-- <label id="scenario-dialog-outputs-checkbox-label">Dialog Variables</label> -->
                                <input id="scenario-dialog-outputs-checkbox" type="checkbox" onclick='updateDOMelementVisibility("scenario-dialog-outputs")'>Dialog Variables</input>    
                            </div>
                            <div id="scenario-dialog-outputs-body">
                                <button class="scenario-dialog-output-buttons" id="add-dialog-outputs-table-row" onclick='addNewDialogOutputsTableRow()'>Add row</button>
                                <button class="scenario-dialog-output-buttons" id="delete-dialog-outputs-table-row" onclick='deleteDialogOutputsTableRow()'>Delete row</button>
                                <table class="scenario-tables" id="dialog-outputs-table" style="width:auto">
                                    <tr>
                                        <th>
                                            Block Type
                                        </th>
                                        <th>
                                            Block Number
                                        </th>
                                        <th>
                                            Type
                                        </th>
                                        <th>
                                            Name
                                        </th>
                                        <th>
                                            Value
                                        </th>
                                    </tr>
                                </table>
                                <button class="download-dialog-outputs-button" onclick="downloadDialogVariableDataFromModel(0)">Get dialog variable values</button>
                                <label id="dialog-outputs-uploaded-status-label">Inputs uploaded:</label>
                                <input id="dialog-outputs-uploaded-status" type="checkbox"></input>
                            </div>
                        </div>     
                    </div>
                </div>
                <!-- <label for='load-scenario-definition' class="btn">Load scenario definition</label> -->
                <button onclick='$("#load-scenario-definition").click()'>Load scenario definition</button>
                <input type="file" id='load-scenario-definition' style='display: none' onchange='loadScenarioDefinition(event)'></input>
                <button class='scenario-buttons' id='save-scenario-definition'  onclick='saveScenarioDefinition()'>Save scenario definition</button>
            </div>
        </div>
        <div id="scenarios">
            <div class='section-header-checkboxes'>
                <input type='checkbox' id='scenarios-checkbox' onclick='updateDOMelementVisibility("scenarios")'>Scenarios</input>
            </div>
            <div id='scenarios-body'>
                <div>
                    <div>
                        <div id='submit-scenarios'>
                            <button class="scenario-buttons" id="submit-scenarios-button" onclick='submitSimulationScenario(event)'>Submit scenario</button>
                        </div>            
                    </div>
                    <label id="scenario-id-label">Scenario ID:</label>
                    <input id="scenario-id"></input>    
                    <label id="scenario-status-label">Scenario status:</label>
                    <input id="scenario-status"></input> 
                    <br></br>
                    <label id="user-scenario-folder-pathname-label">Selected Scenario folder pathname:</label>
                    <input id="user-scenario-folder-pathname" readonly></input>    
    
                </div>
                <div id="scenarios-table-body">
                    <table class="scenario-tables" id="scenarios-table">
                        <tr>
                            <th>
                                Select
                            </th>
                            <th>
                                ID
                            </th>
                            <th>
                                Name
                            </th>
                            <th>
                                Status
                            </th>
                            <th>
                                Folder
                            </th>
                        </tr>
                    </table>
                    <div id='remove-selected-button'>
                        <button id="remove-selected-scenario-folders-button"  onclick="removeSelectedScenarioFolders()">Remove selected scenario folders from server</button>
                    </div>
                </div>
            </div>
        </div>    
    </div>
</div> 
    <script type="text/javascript">
    var modelBlocks = [];
    var blockNumbers = [];
    var dialogVariableTypes = [];
    var uploadedFiles = [];
    var uploadedDatabaseFiles = [];
    var selectedFiles = [];
    var selectedDatabaseFiles = [];
    var scenarioFolderFiles = [];
    var modelDatabases = [];
    var g_tableSchema = {};
    var g_tableDataArray = [];
    var g_fileDataArray = [];
    var modelBlockInfo;
    var inputFileTableRows = 0;
    var outputFileTableRows = 0;
    var databaseInputsTableRows = 0;
    var dialogInputsTableRows = 0;
    var dialogOutputsTableRows = 0;
    var databaseOutputsTableRows = 0;
    var scenariosTableRows = 0;
    const scenarioStatusValues = ['Waiting to run', 'Running', 'Completed', 'Aborted']
    var numFilesUploaded = 0;
    var numDatabaseFilesUploaded = 0;
    var tableDataHtmlCode = "";
    var myCheckStatusInterval;
    var loadedScenarioModelpathname = "";
    var g_modelChartCreated = false;
    var g_chartData = {
        labels: [],
        data: []
    }
    var g_ScenarioDefinition = {
        scenarioName: "",
        uploadedFiles: [],
        uploadedDatabaseFiles: [],
        modelName: "",
        scenarioFolderPathname: "",
        modelPathname: "",
        factorDatabasenames: [],
        factorTablenames: [],
        variablenames: [],
        variableValues: [],
        blockNumbers: []
    }
    var g_myModalChart;
    var IPaddress = "";
    // var IPaddress = "http://184.171.246.58";

    // const IPaddress = "localhost";
    // var queryURL_root = "http://" + IPaddress + ":8090/StreamingService/web/"
    var queryURL_root =  IPaddress + ":3001/api/"
    // var queryURL_root2 = "http://" + IPaddress + ":3001/api/users/login/"
    // var queryURL = "http://" + IPaddress + ":8090/StreamingService/web/LoginToServer"
    // var queryURL2 = "http://" + IPaddress + ":8090/StreamingService/web/EchoWithGet"
    // var queryURL3 = "http://" + IPaddress + ":8090/StreamingService/web/GetServerDirectoryFiles"
    // var queryURL = "http://" + IPaddress + ":8090/StreamingService/web/LoginToServer?username=analyst1&password=model"
    // const proxyurl = "https://cors-anywhere.herokuapp.com/";
    const proxyurl = "";
    const pathname = "C:\Users\Administrator\Documents\ExtendSim10ASP_Prod\ASP\ASP Servers\ExtendSim Models\Analyst 1";
    const c_Completed_status = 3;

    const c_DB_FIELDTYPE_INTEGER_VALUE = 4096;
    const c_DB_FIELDTYPE_INTEGER_BOOLEAN = 4097;
    const c_DB_FIELDTYPE_REAL_GENERAL = 8192;
    const DB_FIELDTYPE_REAL_SCIENTIFIC = 8193;
    const DB_FIELDTYPE_REAL_PERCENT = 8194;
    const DB_FIELDTYPE_REAL_CURRENCY = 8195;
    const DB_FIELDTYPE_REAL_DATE_TIME = 8196;
    const DB_FIELDTYPE_REAL_DB_ADDRESS = 8197;
    const DB_FIELDTYPE_STRING_VALUE = 16384;
    const DB_FIELDTYPE_TABLELIST = 16385;
    // const username = 'analyst1';
    // const password = 'model';
    $('.buttons').prop('disabled', true);
    $('.scenario-file-input-buttons').prop('disabled', true);
    $('.scenario-file-output-buttons').prop('disabled', true);
    $('.scenario-database-input-buttons').prop('disabled', true);
    $('.scenario-database-output-buttons').prop('disabled', true);
    $('.scenario-dialog-input-buttons').prop('disabled', true);
    $('.scenario-dialog-output-buttons').prop('disabled', true);
    $('.scenario-buttons').prop('disabled', true);
    $('.user-login-buttons').prop('disabled', true);
    $('.scenario-checkbox').prop('disabled', true);
    $('#load-scenario-definition').prop('disabled', false);
    
    $('#scenario-user-login-checkbox').prop('checked', false);
    $('#scenario-setup-checkbox').prop('checked', false);
    $('#scenario-factors-checkbox').prop('checked', false);
    $('#scenario-responses-checkbox').prop('checked', false);
    $('#scenario-factors-checkbox').prop('disabled', true);
    $('#scenario-responses-checkbox').prop('disabled', true);
    $('#scenarios-checkbox').prop('checked', false);
    $('#scenarios-checkbox').prop('disabled', true);
    $('.scenario-definition-checkboxes').prop('disabled', true);
    $('#remove-selected-scenario-folders-button').prop('disabled', true);
    $('#responses-checkbox').prop('checked', false);
    $('#scenarios-checkbox').prop('checked', false);
    $('#scenario-file-inputs-checkbox').prop('checked', false);
    $("#model-copied-status").prop('checked', false);
    $("#server-actions").hide();
    $('#modal-form-chart').hide();
    $("#database-table-modal").hide();
    $("#file-contents-modal").hide();
    $(".upload-files-button").hide();
    $("#files-uploaded-status-label").hide();
    $("#files-uploaded-status").hide();
    $(".upload-database-inputs-button").hide();
    $("#database-inputs-uploaded-status-label").hide();
    $("#database-inputs-uploaded-status").hide();
    $(".upload-dialog-inputs-button").hide();
    $("#dialog-inputs-uploaded-status-label").hide();
    $("#dialog-inputs-uploaded-status").hide();

    enableDisableUserLoginButton();
    validateUserInputs();

    // page sections
    updateDOMelementVisibility("scenario-user-login");
    updateDOMelementVisibility("scenario-definition");
    updateDOMelementVisibility("scenario-setup");
    updateDOMelementVisibility("scenario-factors");
    updateDOMelementVisibility("scenario-responses");
    updateDOMelementVisibility("scenarios");
    $("#scenario-factors").hide();
    $('#scenario-responses').hide();

    // factors
    updateDOMelementVisibility("scenario-file-inputs");
    updateDOMelementVisibility("scenario-database-inputs");
    updateDOMelementVisibility("scenario-dialog-inputs");
    // responses
    updateDOMelementVisibility("scenario-file-outputs");
    updateDOMelementVisibility("scenario-database-outputs");
    updateDOMelementVisibility("scenario-dialog-outputs");
    updateLoadingDivVisibility(false);

    function prepCSVRow(arr, columnCount, initial) {
        var row = ''; // this will hold data
        var delimeter = ','; // data slice separator, in excel it's `;`, in usual CSv it's `,`
        var newLine = '\r\n'; // newline separator for CSV row
        var plainArr = splitArray(arr, columnCount);
        plainArr.forEach(function(arrItem) {
            arrItem.forEach(function(item, idx) {
            row += item + ((idx + 1) === arrItem.length ? '' : delimeter);
            });
            row += newLine;
        });
        return initial + row;
    }
    function splitArray(_arr, _count) {
        var splitted = [];
        var result = [];
        _arr.forEach(function(item, idx) {
            if ((idx + 1) % _count === 0) {
                splitted.push(item);
                result.push(splitted);
                splitted = [];
            } else {
                splitted.push(item);
            }
        });
        return result;
    }
    function exportDataTableToTextFile(tableName) {
        var titles = [];
        var data = [];
        $('#' + tableName + ' th').each(function() {
            titles.push($(this).text());
        });
        $('#' + tableName + ' td').each(function() {
            data.push($(this).text());
        });
        var CSVString = prepCSVRow(titles, titles.length, '');
        CSVString = prepCSVRow(data, titles.length, CSVString);
        var downloadLink = document.createElement("a");
        var blob = new Blob(["\ufeff", CSVString]);
        var url = URL.createObjectURL(blob);
        downloadLink.href = url;
        downloadLink.download = tableName + ".csv";
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
    }
    function exportScenarioModelTableToTextFile(event) {
        var rowIndex = getRowIndexFromTableRowId(event.target.id);
        updateLoadingDivVisibility(true);
        var modelInfo = buildDatabaseTableContentsStreamModelInfo(event.target.id);
        getDatabaseTableContentsStream(modelInfo, true)
        .then(function(response) {
            var titles = response.data.modelDatabaseTableFields.fields;
            var data = [];
            g_tableDataArray.forEach(function(elements, index) {
                for (var i=0;i<elements.length;i++) {            
                    data.push(elements[i]);
                }
            });
            var CSVString = prepCSVRow(titles, titles.length, '');
            CSVString = prepCSVRow(data, titles.length, CSVString);
            var downloadLink = document.createElement("a");
            var blob = new Blob(["\ufeff", CSVString]);
            var url = URL.createObjectURL(blob);
            downloadLink.href = url;
            downloadLink.download = modelInfo.Tablename + ".csv";
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            updateLoadingDivVisibility(false);
        });
    }
    function isFieldNumeric(dataType) {
        if ((dataType === c_DB_FIELDTYPE_INTEGER_VALUE) ||
            (dataType === c_DB_FIELDTYPE_INTEGER_BOOLEAN) ||
            (dataType === c_DB_FIELDTYPE_REAL_GENERAL) ||
            (dataType === DB_FIELDTYPE_REAL_SCIENTIFIC) ||
            (dataType === DB_FIELDTYPE_REAL_PERCENT) ||
            (dataType === DB_FIELDTYPE_REAL_CURRENCY) ||
            (dataType === DB_FIELDTYPE_REAL_DATE_TIME)) {
            return true;
        } else {
             return false;
        }
    }
    function populateDropdownElement(tableSchema, dropdownElement, restrictToNumbers) {
        var firstFieldIndex = -1;

        dropdownElement.empty(0);
        for (var i = 0; i < tableSchema.fields.length; i++) {
            if (!restrictToNumbers || isFieldNumeric(tableSchema.dataTypes[i])) {
                dropdownElement.append('<option value="' + tableSchema.fields[i] + '">' + tableSchema.fields[i] + '</option>');
                if (firstFieldIndex === -1) {
                    firstFieldIndex = i;
                }
            }
        }
        if (firstFieldIndex !== -1) {
            dropdownElement.val(tableSchema.fields[firstFieldIndex]);
        }
    }

    function makeChartDataSeries(dataArray, dataSchema, labelHeading, dataHeading) {
        return new Promise((resolve, reject) => {
            console.log('makeChartDataSeries: dataSchema' + JSON.stringify(dataSchema));
            var dataColumnIndex = dataSchema.fields.indexOf(dataHeading);
            var labelColumnIndex = dataSchema.fields.indexOf(labelHeading);
            g_chartData.labels = [];
            g_chartData.values = [];
            dataArray.forEach(function(elements, index) {
                g_chartData.labels.push(elements[labelColumnIndex]);
                g_chartData.values.push(elements[dataColumnIndex]);
            });
            resolve(true);
        });
    }

    function makeCycleTimeChartData(cycleTimeData, dataType) {
    const dataRow = [];
    cycleTimeData.map((rowData, key) => {
      const {
              stepname,
              totalJobsProcessed, 
              totalProcessTime, 
              totalWaitTime,
              avgProcessTime,
              avgWaitTime,
              avgCycleTime,
              CoVarrivals,
              CoVdepartures
            } = rowData; //destructuring
      var value;
  
      switch (dataType) {
        case 'totalJobsProcessed':
          value = totalJobsProcessed;
          break;

        case 'totalProcessTime':
          value = totalProcessTime;
          break;

        case 'totalWaitTime':
          value = totalWaitTime;
          break;

        case 'avgProcessTime':
          value = avgProcessTime;
          break;

        case 'avgWaitTime':
          value = avgWaitTime;
          break;

        case 'avgCycleTime':
          value = avgCycleTime;
          break;

        case 'CoVarrivals':
          value = CoVarrivals;
          break;
        
        case 'CoVdepartures':
          value = CoVdepartures;
          break; 

        default:
          value = '';
          break;    
        }
        dataRow.push({"value": value, "label": stepname });
        return true;
    });
    return dataRow;
  }


    function removeSelectedScenarioFolders() {
        var deletedRows = 0;

        $('#scenarios-table').find('tr').each(function () {
            var row = $(this);
            if (row.find('input[type="checkbox"]').is(':checked')) {
                $("#user-scenario-folder-pathname").val("");
                var rowIndex = parseInt($(this).attr('id').slice(2)) - deletedRows;
                deletedRows++;
                scenariosTableRows--;
                scenarioFolderPathnameID = 'scenario-folder-pathname-' + parseInt($(this).attr('id').slice(2));
                var scenarioFolderPathname = $(this).find("#" + scenarioFolderPathnameID).html();
                var id = $(this).attr('id');
                $(this).remove();
                removeScenarioFolder(scenarioFolderPathname);
            }
        });
    }
    function transferScenarioDefinitionToUserSessionsData() {
        uploadedFiles = g_ScenarioDefinition.uploadedFiles;
        uploadedDatabaseFiles = g_ScenarioDefinition.uploadedDatabaseFiles;
    }
    function transferUserSessionDataToScenarioDefinition() {
        g_ScenarioDefinition.uploadedFiles = uploadedFiles;
        g_ScenarioDefinition.uploadedDatabaseFiles = uploadedDatabaseFiles;
        g_ScenarioDefinition.modelPathname = $("#user-models").val();
        g_ScenarioDefinition.modelName = g_ScenarioDefinition.modelPathname.substring(g_ScenarioDefinition.modelPathname.lastIndexOf("\\") + 1);
        g_ScenarioDefinition.scenarioFolderPathname = $("#user-scenario-folder-pathname").val();
        g_ScenarioDefinition.scenarioName = $('#scenario-name').val();
        g_ScenarioDefinition.factorDatabasenames = [];
        g_ScenarioDefinition.factorTablenames = [];
        for (rowIndex=0;rowIndex<databaseInputsTableRows;rowIndex++) {
            g_ScenarioDefinition.factorDatabasenames.push($('#target-database-' + (rowIndex + 1)).val());
            g_ScenarioDefinition.factorTablenames.push($('#target-table-' + (rowIndex + 1)).val());
        }

        g_ScenarioDefinition.variablenames = [];
        g_ScenarioDefinition.variableValues = [];
        g_ScenarioDefinition.blockNumbers = [];

        for (rowIndex=0;rowIndex<dialogInputsTableRows;rowIndex++) {
            g_ScenarioDefinition.variablenames.push($('#target-variable-name-select-' + (rowIndex + 1)).val());
            g_ScenarioDefinition.variableValues.push($('#target-variable-value-' + (rowIndex + 1)).val());
            g_ScenarioDefinition.blockNumbers.push($('#target-block-number-select-' + (rowIndex + 1)).val());
        }
    }
    function saveScenarioDefinition() {
        // g_ScenarioDefinition.uploadedFiles = uploadedFiles;
        // g_ScenarioDefinition.uploadedDatabaseFiles = uploadedDatabaseFiles;
        // g_ScenarioDefinition.modelPathname = $("#user-models").val();
        // g_ScenarioDefinition.modelName = g_ScenarioDefinition.modelPathname.substring(g_ScenarioDefinition.modelPathname.lastIndexOf("\\") + 1);
        // g_ScenarioDefinition.scenarioFolderPathname = $("#user-scenario-folder-pathname").val();
        // g_ScenarioDefinition.scenarioName = $('#scenario-name').val();
        // g_ScenarioDefinition.factorDatabasenames = [];
        // g_ScenarioDefinition.factorTablenames = [];
        // for (rowIndex=0;rowIndex<databaseInputsTableRows;rowIndex++) {
        //     g_ScenarioDefinition.factorDatabasenames.push($('#target-database-' + (rowIndex + 1)).val());
        //     g_ScenarioDefinition.factorTablenames.push($('#target-table-' + (rowIndex + 1)).val());
        // }

        // g_ScenarioDefinition.variablenames = [];
        // g_ScenarioDefinition.variableValues = [];
        // g_ScenarioDefinition.blockNumbers = [];

        // for (rowIndex=0;rowIndex<dialogInputsTableRows;rowIndex++) {
        //     g_ScenarioDefinition.variablenames.push($('#target-variable-name-select-' + (rowIndex + 1)).val());
        //     g_ScenarioDefinition.variableValues.push($('#target-variable-value-' + (rowIndex + 1)).val());
        //     g_ScenarioDefinition.blockNumbers.push($('#target-block-number-select-' + (rowIndex + 1)).val());
        // }

        transferUserSessionDataToScenarioDefinition();
        var blob = new Blob([JSON.stringify(g_ScenarioDefinition)],
                { type: "text/plain;charset=utf-8" });
        saveAs(blob, "scenarioData.txt");
        $('#scenarios-checkbox').prop('disabled', false);
        $('#submit-scenarios-button').prop('disabled', false); 
    }

    function doesScenarioFolderExist() {
        if ($("#user-scenario-folder-pathname").val() === "") {
            return false;
        } else {
            return true;
        }
    }

    function validateUserInputs() {
        if (($("#username").val() === '') || ($("#password").val() === '') || (!ValidateIPaddress($("#ip-address").val()))) {
            //Check to see if there is any text entered
            // If there is no text within the input ten disable the button
            $('.buttons').prop('disabled', true);
        } else {
            //If there is text in the input, then enable the button
            IPaddress = "http://" + $("#ip-address").val();
            queryURL_root =  IPaddress + ":3001/api/";
            $('.buttons').prop('disabled', false);
            $('#create-scenario-folder-button').prop('disabled', true);
            $('#copy-model-to-scenario-folder').prop('disabled', true);
        }
    }

    function enableDisableUserLoginButton() {
        if (($("#username").val() === '') || ($("#password").val() === '') || (!ValidateIPaddress($("#ip-address").val()))) {
            $('#login-button').prop('disabled', true);
        } else {
            $('#login-button').prop('disabled', false);
        }
    }

    function updateButtonsState() {
        if ($("#scenario-name").val() !== '') {
            if ($('#user-models').val() !== null) {
                $('#create-scenario-folder-button').prop('disabled', false);
                $('.scenario-file-input-buttons').prop('disabled', false);
                $('.scenario-database-input-buttons').prop('disabled', false);
                $('.scenario-dialog-input-buttons').prop('disabled', false);
                // $('.scenario-buttons').prop('disabled', false); 
                $('#save-scenario-definition').prop('disabled', false);
                $('#scenario-factors-checkbox').prop('disabled', false);
                $('#scenario-responses-checkbox').prop('disabled', false);

                if ($("#user-scenario-folder-pathname").val() !== "") {
                    $('.scenario-file-output-buttons').prop('disabled', false);    
                    $('.scenario-database-output-buttons').prop('disabled', false);
                    $('.scenario-dialog-output-buttons').prop('disabled', false);
                }   
            }
        }
    }


    function ValidateIPaddress(inputText)
    {
        return /^(([1-9]?\d|1\d\d|2[0-4]\d|25[0-5])(\.(?!$)|(?=$))){4}$/.test(inputText||"");
    }    
    function displayFileContents() {
        var modalTable = $('#selected-file-contents-table');
        $(modalTable).empty();
        tableDataHtmlCode = '';
        tableDataHtmlCode += '<tr>';
        for (var i=0;i<g_fileDataArray[0].length;i++) {
            tableDataHtmlCode += '<th>Field ' + (i + 1) + '</th>';
        }
        g_fileDataArray.forEach(function(elements, index) {
            tableDataHtmlCode += '<tr>';
                for (var i=0;i<elements.length;i++) {
                    tableDataHtmlCode += '<td>' + elements[i] + '</td>';
                }
            // }
            tableDataHtmlCode += '</tr>';
        });
        $(modalTable).find("tr:not(:first)").remove();
        $(modalTable).append(tableDataHtmlCode); 
        $("#file-contents-modal").show();
        updateLoadingDivVisibility(false);
    }

    function displayTableContents(modelDatabaseTableFields) {
        var modalTable = $("#selected-database-outputs-table");
        $(modalTable).empty();
        g_tableSchema = modelDatabaseTableFields;
        tableDataHtmlCode = '';
        tableDataHtmlCode += '<tr>';
        for (var i=0;i<g_tableSchema.fields.length;i++) {
            tableDataHtmlCode += '<th>' + g_tableSchema.fields[i] + '</th>';
        }
        g_tableDataArray.forEach(function(elements, index) {
            tableDataHtmlCode += '<tr>';
                for (var i=0;i<elements.length;i++) {
                    tableDataHtmlCode += '<td>' + elements[i] + '</td>';
                }
            // }
            tableDataHtmlCode += '</tr>';
        });
        // $("#selected-database-outputs-table").empty(); 
        $(modalTable).find("tr:not(:first)").remove();
        $(modalTable).append(tableDataHtmlCode); 
        $('#modal-form-chart').hide();
        $("#database-table-modal").show();
        $('#modal-form-contents').show();
        updateLoadingDivVisibility(false);
    }
    function viewModalChart() {
        if (($('#modal-x-axis-field-select').val() !== '') && ($('#modal-x-axis-field-select').val() !== '')) {
            makeChartDataSeries(g_tableDataArray, g_tableSchema, $('#modal-x-axis-field-select').val(), $('#modal-y-axis-field-select').val())
            .then(function(response) {
                g_myModalChart.destroy();
                displayTableChart(g_chartData, $('#modal-x-axis-field-select').val(), $('#modal-y-axis-field-select').val(), $('#modal-y-axis-field-select').val() + ' vs ' + $('#modal-x-axis-field-select').val());
            });
        }
    }
    function displayTableChart(chartData, xAxislabel, yAxislabel, chartTitle) {
        if (g_modelChartCreated) {
            g_myModalChart.destroy();
        }
        g_myModalChart = new Chart($("#modal-form-chart"), {
            type: 'bar',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        // label: dataSetsLabel,
                        backgroundColor: 'rgb(255, 0, 0)',
                        // ["#3e95cd", "#8e5ea2","#3cba9f","#e8c3b9","#c45850", "#3e95cd", "#8e5ea2","#3cba9f","#e8c3b9","#c45850"],
                        data:  chartData.values
                    }
                ]
            },
            options: {
                legend: { display: false },
                title: {
                    display: true,
                    text: chartTitle,
                    fontSize: 23,
                    fontStyle: 'bold'
                },
                scales: {
                    xAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: xAxislabel,
                            fontSize: 18,
                            fontStyle: 'bold'
                        },   
                        barPercentage: 0.5                     
                    }],
                    yAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: yAxislabel,
                            fontSize: 18,
                            fontStyle: 'bold'
                        }, 
                        ticks: {
                            beginAtZero: true   
                        }                    
                    }]
                },
                responsive: true
            }
        });
        g_modelChartCreated = true;
    }
    function displayTableChartModal() {
        $("#database-table-modal").hide();
        $('#modal-form-chart').show();
        $('#modal-form-contents').hide();

        var charTypes = ['Bar chart'];
        $('#chart-type-select').append('<option value="Bar chart">Bar chart</option>');
        populateDropdownElement(g_tableSchema, $('#modal-x-axis-field-select'), false);
        populateDropdownElement(g_tableSchema, $('#modal-y-axis-field-select'), true);
        if (($('#modal-x-axis-field-select').val() !== '') && ($('#modal-x-axis-field-select').val() !== '')) {
            displayTableChart(g_chartData, $('#modal-x-axis-field-select').val(), $('#modal-y-axis-field-select').val(), $('#modal-y-axis-field-select').val() + ' vs ' + $('#modal-x-axis-field-select').val());
        }
        updateLoadingDivVisibility(false);
    }

    function showDatabaseTableChartModal() {
        $('#modal-form-chart').show();
        $('#modal-form-contents').hide();
    }
    function updateLoadingDivVisibility(show) {
        if (show) {
            $('#load_screen').show();
            $('#loading').show();
        } else {
            $('#load_screen').hide();
            $('#loading').hide();
        }
    }
    function populateScenarioFactorsSettings() {
        var inputLabel = "";
        $('#scenario-name').val(g_ScenarioDefinition.scenarioName);
        updateButtonsState();
        // populate the factors input files table
        addNewInputFilesTableRow(0, g_ScenarioDefinition.uploadedFiles.length)
        .then(function(response) {
            for (var i=0;i<g_ScenarioDefinition.uploadedFiles.length;i++) {
                inputLabel = '#input-label-' + (i + 1);
                updateInputLabel(inputLabel, g_ScenarioDefinition.uploadedFiles[i].name, 20);
            }
            addNewDatabaseInputsTableRow(0, g_ScenarioDefinition.uploadedDatabaseFiles.length, false)
            .then(function(response) {
                var targetDatabase;
                var targetTable;
                for (var j=0;j<g_ScenarioDefinition.uploadedDatabaseFiles.length;j++) {
                    inputLabel = '#database-input-label-' + (j + 1);
                    updateInputLabel(inputLabel, g_ScenarioDefinition.uploadedDatabaseFiles[j].name, 20);
                    targetDatabase = '#target-database-' + (j + 1);
                    $(targetDatabase).val(g_ScenarioDefinition.factorDatabasenames[j]);
                    targetTable = '#target-table-' + (j + 1);
                    $(targetTable).val(g_ScenarioDefinition.factorTablenames[j]);
                }
                transferScenarioDefinitionToUserSessionsData();
            })
            .catch(function(error) {
                alert('Error returned from addNewDatabaseInputsTableRow');              
            })
        })
        .catch(function(error) {
            alert('Error returned from addNewInputFilesTableRow');
        })
    }
    function populateScenarioResponsesSettings() {

    }
    function loadScenarioDefinition(event) {
        var files = $("#" + event.target.id)[0].files;
        clearTableData();
        inputFileTableRows = 0;
        databaseInputsTableRows = 0;
        numDatabaseFilesUploaded = 0;
        loadedScenarioModelpathname = '';   //  force a query to the server to get the loaded model's data
        if (files) {
            [].forEach.call(files, readAndPreviewScenarioDefinitionFile);
        }
        $('#scenarios-checkbox').prop('disabled', false);
        $('#submit-scenarios-button').prop('disabled', false); 
    }
    function readAndPreviewScenarioDefinitionFile(file) {
        var reader  = new FileReader();
        reader.onload = function(event) {
            g_ScenarioDefinition = JSON.parse(event.target.result);
            populateScenarioFactorsSettings();
        };
        if (file) {
            console.log(file);
            reader.readAsText(file);
        }
    }
    function databasefilesSelected(event) {
        var files = $("#" + event.target.id)[0].files;
        if (files) {
            [].forEach.call(files, readAndPreviewDatabaseInputFile);
        }
        enableDisableUploadFilesToDatabaseTablesButton();    
    }
    function inputFilesSelected(event) {
        var files = $("#" + event.target.id)[0].files;
        if (files) {
            [].forEach.call(files, readAndPreviewInputFile);
        }
        enableDisableUploadFilesButton();
    }
    String.prototype.width = function(font) {
        var f = font || '12px arial',
            o = $('<div>' + this + '</div>')
                    .css({'position': 'absolute', 'float': 'left', 'white-space': 'nowrap', 'visibility': 'hidden', 'font': f})
                    .appendTo($('body')),
            w = o.width();

        o.remove();

        return w;
    }
    function updateInputLabel(inputLabel, inputValue, padding) {
        $(inputLabel).val(inputValue);
        var inputWidth = $(inputLabel).val().width($(inputLabel).css( "fontSize" ) + " arial");
        $(inputLabel).css({
            width: inputWidth + padding
        })
    }
    function readAndPreviewInputFile(file) {
        var reader  = new FileReader();
        reader.onload = function(event) {
            var contents = event.target.result;
            uploadedFiles[numFilesUploaded].data = contents;
            numFilesUploaded++;
            var inputLabel = '#input-label-' + numFilesUploaded;
            updateInputLabel(inputLabel, file.name, 20);
        };

        if (file) {
            console.log(file);
            uploadedFiles.push({ name: file.name });
            selectedFiles.push(file);
            reader.readAsText(file);
        }
    }
    function readAndPreviewDatabaseInputFile(file) {
        var reader  = new FileReader();
        reader.onload = function(event) {
            var contents = event.target.result;
            uploadedDatabaseFiles[numDatabaseFilesUploaded].data = contents;
            numDatabaseFilesUploaded++;
            var inputLabel = '#database-input-label-' + numDatabaseFilesUploaded;
            updateInputLabel(inputLabel, file.name, 20);
        };

        if (file) {
            uploadedDatabaseFiles.push({ name: file.name });
            selectedDatabaseFiles.push(file);
            reader.readAsText(file);
        }
    }
    function enableDisableUploadFilesButton() {
        if (selectedFiles.length === 0)  {
            $('.upload-files-button').prop('disabled', true);
        }
        else {
            $('.upload-files-button').prop('disabled', false);
        }
    }
    function enableDisableUploadFilesToDatabaseTablesButton() {
        if (selectedDatabaseFiles.length === 0)  {
            $('.upload-database-inputs-button').prop('disabled', true);
        }
        else {
            $('.upload-database-inputs-button').prop('disabled', false);
        }
    }
    function enableDisableCopyModelToScenarioFolderButton() {
        const scenarioFolderPathname = $("#user-scenario-folder-pathname").val();
        const userModelPathname = $("#user-models").val();
    }
    function updateDOMelementVisibility(DOMelementIDname) {
        if ($('#' + DOMelementIDname + '-checkbox'). prop("checked") == true) {
            $('#' + DOMelementIDname + '-body').show();
            $('#' + DOMelementIDname).width('auto');
            if (DOMelementIDname === "scenario-user-login") {
                $('#' + DOMelementIDname).width('70%');

            } else if (DOMelementIDname === "scenario-definition") {
                $("#scenario-factors").show();
                $('#scenario-responses').show();
                $('#' + DOMelementIDname).width('70%');
            }
        } else {
            $('#' + DOMelementIDname + '-body').hide();
            $('#' + DOMelementIDname).width('25%');
            if (DOMelementIDname === "scenario-definition") {
                $("#scenario-factors").hide();
                $('#scenario-responses').hide();
            } if ($('#scenario-definition-checkbox'). prop("checked") == true) {
                if (DOMelementIDname === "scenario-factors") {
                    if ($('#scenario-responses-checkbox'). prop("checked") == false)
                        $('#scenario-definition').width('50%');
                } else if (DOMelementIDname === "scenario-responses") {
                    if ($('#scenario-factors-checkbox'). prop("checked") == false)
                        $('#scenario-definition').width('50%');
                }
            }
        }
    }

    function addNewInputFilesTableRow(rowIndex, numRows) {
        return new Promise((resolve, reject) => {
            var table = $("#file-inputs-table");
            inputFileTableRows++;

            var myID = 'input-button-' + inputFileTableRows;
            var myLabelID = 'input-label-' + inputFileTableRows;
            var $myID = "'#" + myID + "'";
            var newrow = '<tr><td><button onclick="$(' + $myID + ').click()">Upload file</button><input type="file" style="display: none" onchange="inputFilesSelected(event)" class="input-file-row" id="' + myID + '"><input type="text" class="input-label" id="' + myLabelID + '" readonly></td></tr>';
            table.append(newrow);
            rowIndex++;
            if (rowIndex < numRows) {
                resolve(addNewInputFilesTableRow(rowIndex, numRows));
            } else {
                resolve(true);
            }
        });
    }
    function deleteInputFilesTableRow(event) {
        if (inputFileTableRows > 0) {
            inputFileTableRows--;
        }
        $("#file-inputs-table tr:last").remove();
    }
    function isSelectedScenarioModelLoaded() {
        if (loadedScenarioModelpathname !== getModelPathname()) {
            return false;
        } else {
            return true;
        }
    }
    function getModelPathname() {
        var modelName =  $("#user-models").val();
        modelName = modelName.substring(modelName.lastIndexOf("\\") + 1);
        var modelPathname = $("#user-scenario-folder-pathname").val() + '\\' + modelName;
        return modelPathname;
    }
    function createDatabaseInputsTableRow(rowIndex, numRows) {
        return new Promise((resolve, reject) => {
            var table = $("#database-inputs-table");
            $('#scenario-definition').width('auto');
            databaseInputsTableRows++;

            var myID = 'database-input-button-' + databaseInputsTableRows;
            var myLabelID = 'database-input-label-' + databaseInputsTableRows;
            var $myID = "'#" + myID + "'";
            var newrow = 
            '<tr><td><button onclick="$(' + $myID + ').click()">Upload file</button><input type="file" id="' + myID + '" style="display: none" onchange="databasefilesSelected(event)" class="input-file-row"><input type="text" class="input-label" id="' + myLabelID + '" readonly></td><td><select onchange="updateTargetTableSelect(event)" id="target-database-' + databaseInputsTableRows + '"></select></td><td><select id="target-table-' + databaseInputsTableRows + '"></select></td></tr>'
            table.append(newrow);
            var targetDatabase = '#target-database-' + databaseInputsTableRows;
            for (var i = 0; i < modelDatabases.length; i++) {
                $(targetDatabase).append('<option value="' + modelDatabases[i].name + '">' + modelDatabases[i].name + '</option>');
            }
            if (modelDatabases.length > 0) {
                $(targetDatabase).val(modelDatabases[0].name);
            }
            var targetTable = '#target-table-' + databaseInputsTableRows;
            for (var i = 0; i < modelDatabases[0].tableNames.length; i++) {
                $(targetTable).append('<option value="' + modelDatabases[0].tableNames[i] + '">' + modelDatabases[0].tableNames[i] + '</option>');
            }
            if (modelDatabases[0].tableNames.length > 0) {
                $(targetTable).val(modelDatabases[0].tableNames[0]);
            }
            rowIndex++;
            if (rowIndex < numRows) {
                resolve(createDatabaseInputsTableRow(rowIndex, numRows));
            } else {
                resolve(true);
            }
        });
    }
    function addNewDatabaseInputsTableRow(startRowIndex, numRows , clearTableDataFlag) {
        return new Promise((resolve, reject) => {
            if (!isSelectedScenarioModelLoaded()) {
                var createScenariorFolderFlag = !doesScenarioFolderExist();
                createScenarioFolder(createScenariorFolderFlag, false)
                .then(function(createScenarioFolderResponse) {
                    // Copy user selected server model into scenario folder
                    copyModelToScenarioFolder(createScenariorFolderFlag)
                    .then(function(copyModelToScenarioFolderResponse) {
                        var modelPathname = getModelPathname();
                        updateModelInfo(modelPathname, clearTableDataFlag) 
                        .then(function(response) {
                            createDatabaseInputsTableRow(startRowIndex, numRows)
                            .then(function(response) {
                                resolve(true);
                            })
                            .catch(function(error) {
                                reject(error);
                            })
                        })
                    })
                    .catch(function(error) {
                        resolve(true);
                    })
                })
                .catch(function(error) {
                    reject(error);
                })
            } else {
                resolve(true);
            }
            // }         
        });
    }

    function addNewDatabaseInputsTableRow_OLD(rowIndex, numRows, clearTableDataFlag) {
        return new Promise((resolve, reject) => {
            if (!isSelectedScenarioModelLoaded()) {
                var createScenariorFolderFlag = !doesScenarioFolderExist();
                createScenarioFolder(createScenariorFolderFlag, false)
                .then(function(createScenarioFolderResponse) {
                    // Copy user selected server model into scenario folder
                    copyModelToScenarioFolder(createScenariorFolderFlag)
                    .then(function(copyModelToScenarioFolderResponse) {
                        var modelPathname = getModelPathname();
                        updateModelInfo(modelPathname, clearTableDataFlag)
                        .then(function(response) {
                            createDatabaseInputsTableRow();
                            rowIndex++;
                            if (rowIndex < numRows) {
                                resolve(addNewDatabaseInputsTableRow(rowIndex, numRows, false));
                            } else {
                                resolve(true);
                            }
                        })
                        .catch(function(error) {
                            reject(error);
                        })
                    })
                    .catch(function(error) {
                        reject(error);
                    })
                })
                .catch(function(error) {
                    reject(error);
                })
            } else {
                createDatabaseInputsTableRow();
                rowIndex++;
                if (rowIndex < numRows) {
                    resolve(addNewDatabaseInputsTableRow(rowIndex, numRows, false));
                } else {
                    resolve(true);
                }
            }
        });
    }

    function deleteDatabaseInputsTableRow(event) {
        if (databaseInputsTableRows > 0) {
            databaseInputsTableRows--;
        }
        $("#database-inputs-table tr:last").remove();  
    }
    
    function createDialogInputsTableRow() {
        var table = $("#dialog-inputs-table");
        dialogInputsTableRows++;
        var newrow = 
        '<tr><td><select id="target-block-type-select-' + dialogInputsTableRows + '" onchange="targetBlockTypeSelected(event)"></select></td><td><select id="target-block-number-select-' + dialogInputsTableRows + '" onchange="targetBlockNumberSelected(event)"></select></td><td><select id="target-variable-type-select-' + dialogInputsTableRows + '" onchange="targetDialogVariableTypeSelected(event)"></select></td><td><select id="target-variable-name-select-' + dialogInputsTableRows + '" onchange="targetDialogVariableSelected(event)"></select></td><td><input type="text" id="target-variable-value-' + dialogInputsTableRows + '"></input></td></tr>'     
        table.append(newrow);
        var blockType = '#target-block-type-select-' + dialogInputsTableRows;
        for (var i = 0; i < modelBlocks.length; i++) {
            $(blockType).append('<option value="' + modelBlocks[i] + '">' + modelBlocks[i] + '</option>');
        }
        if (modelBlocks.length > 0) {
            $(blockType).val(modelBlocks[0]);
            var blockNumber = '#target-block-number-select-' + dialogInputsTableRows;
            updateTargetBlockNumbersDropdown(dialogInputsTableRows);
            updateTargetDialogVariableTypeDropdown(dialogInputsTableRows);
        }
    }
    function addNewDialogInputsTableRow(rowIndex, numRows, clearTableDataFlag) {
        if (!isSelectedScenarioModelLoaded()) {
            var createScenariorFolderFlag = !doesScenarioFolderExist();
            createScenarioFolder(createScenariorFolderFlag, false)
            .then(function(createScenarioFolderResponse) {
                // Copy user selected server model into scenario folder
                copyModelToScenarioFolder(createScenariorFolderFlag)
                .then(function(copyModelToScenarioFolderResponse) {
                    var modelPathname = getModelPathname();
                    updateModelInfo(modelPathname, clearTableDataFlag)
                    .then(function(response) {
                        createDialogInputsTableRow();
                    })
                })
            })
        } else {
            createDialogInputsTableRow();
        }
    }

    function deleteDialogInputsTableRow(event) {
        if (dialogInputsTableRows > 0) {
            dialogInputsTableRows--;
        }
        $("#dialog-inputs-table tr:last").remove();  
    }

    function createDialogOutputsTableRow() {
        var table = $("#dialog-outputs-table");
        dialogOutputsTableRows++;
        var newrow = 
        '<tr><td><select id="source-block-type-select-' + dialogOutputsTableRows + '" onchange="sourceBlockTypeSelected(event)"></select></td><td><select id="source-block-number-select-' + dialogOutputsTableRows + '" onchange="sourceBlockNumberSelected(event)"></select></td><td><select id="source-variable-type-select-' + dialogOutputsTableRows + '" onchange="sourceDialogVariableTypeSelected(event)"></select></td><td><select id="source-variable-name-select-' + dialogOutputsTableRows + '" onchange="sourceDialogVariableSelected(event)"></select></td><td><input type="text" id="source-variable-value-' + dialogOutputsTableRows + '"></input></td></tr>'     
        table.append(newrow);
        var blockType = '#source-block-type-select-' + dialogOutputsTableRows;
        for (var i = 0; i < modelBlocks.length; i++) {
            $(blockType).append('<option value="' + modelBlocks[i] + '">' + modelBlocks[i] + '</option>');
        }
        if (modelBlocks.length > 0) {
            $(blockType).val(modelBlocks[0]);
            var blockNumber = '#source-block-number-select-' + dialogOutputsTableRows;
            updateSourceBlockNumbersDropdown(dialogOutputsTableRows);
            updateSourceDialogVariableTypeDropdown(dialogOutputsTableRows);
        }
    }

    function addNewDialogOutputsTableRow(rowIndex, numRows, clearTableDataFlag) {
        if (!isSelectedScenarioModelLoaded()) {
            var createScenariorFolderFlag = !doesScenarioFolderExist();
            createScenarioFolder(createScenariorFolderFlag, false)
            .then(function(createScenarioFolderResponse) {
                // Copy user selected server model into scenario folder
                copyModelToScenarioFolder(createScenariorFolderFlag)
                .then(function(copyModelToScenarioFolderResponse) {
                    var modelPathname = getModelPathname();
                    updateModelInfo(modelPathname, clearTableDataFlag)
                    .then(function(response) {
                        createDialogOutputsTableRow();
                    })
                })
            })
        } else {
            createDialogOutputsTableRow();
        }
    }

    function deleteDialogOutputsTableRow(event) {
        if (dialogOutputsTableRows > 0) {
            dialogOutputsTableRows--;
        }
        $("#dialog-inputs-table tr:last").remove();  
    }
    function createDatabaseOutputsTableRow() {
        var table = $("#database-outputs-table");
        databaseOutputsTableRows++;
        $('#scenario-definition').width('auto');
        var newrow = 
        '<tr><td><select onchange="updateSourceTableSelect(event)" id="source-database-' + databaseOutputsTableRows + '"></select></td><td><select id="source-table-' + databaseOutputsTableRows + '"></select></td><td><button id="view-source-database-table-' + databaseOutputsTableRows + '" onclick="openDatabaseTableContentsModal(event)">View data</button></td><td><button id="view-source-database-table-chart-' + databaseOutputsTableRows + '" onclick="openViewDatabaseTableChartModal(event)">View chart</button></td><td><button id="export-source-database-table-' + databaseOutputsTableRows + '" onClick="exportScenarioModelTableToTextFile(event)">Export data</button></td></tr>'
        table.append(newrow);
        var sourceDatabase = '#source-database-' + databaseOutputsTableRows;
        for (var i = 0; i < modelDatabases.length; i++) {
            $(sourceDatabase).append('<option value="' + modelDatabases[i].name + '">' + modelDatabases[i].name + '</option>');
        }
        if (modelDatabases.length > 0) {
            $(sourceDatabase).val(modelDatabases[0].name);
        }
        var sourceTable = '#source-table-' + databaseOutputsTableRows;
        for (var i = 0; i < modelDatabases[0].tableNames.length; i++) {
            $(sourceTable).append('<option value="' + modelDatabases[0].tableNames[i] + '">' + modelDatabases[0].tableNames[i] + '</option>');
        }
        if (modelDatabases[0].tableNames.length > 0) {
            $(sourceTable).val(modelDatabases[0].tableNames[0]);
        }
    }
    function addNewDatabaseOutputsTableRow(rowIndex, numRows, clearTableDataFlag) {
        if (!isSelectedScenarioModelLoaded()) {
            var createScenariorFolderFlag = !doesScenarioFolderExist();
            createScenarioFolder(createScenariorFolderFlag, false)
            .then(function(createScenarioFolderResponse) {
                // Copy user selected server model into scenario folder
                copyModelToScenarioFolder(createScenariorFolderFlag)
                .then(function(copyModelToScenarioFolderResponse) {
                    var modelPathname = getModelPathname();
                    updateModelInfo(modelPathname, clearTableDataFlag)
                    .then(function(response) {
                        createDatabaseOutputsTableRow();
                    })
                })
            })
        } else {
            createDatabaseOutputsTableRow();
        }              
    }
    function createOutputsFileTableRow() {
        var table = $("#file-outputs-table");
        outputFileTableRows++;
        if (scenarioFolderFiles.length === 0) {
            getScenarioFolderFiles()
            .then(function(response) {
                var newrow = '<tr><td><select class="output-file-row" id="output-file-select-' + outputFileTableRows + '"></td><td><button id="view-source-file-' + outputFileTableRows + '" onclick="openFileContentsModal(event)">Get file</button></td></tr>';
                table.append(newrow);
                var scenarioFolderFiles = response.data.scenarioFolderFiles;
                console.log('scenarioFolderFiles=' + JSON.stringify(scenarioFolderFiles));
                var outputFilesSelect = $('#output-file-select-' + outputFileTableRows);
                $(outputFilesSelect).empty(0);
                for (var i = 0; i < scenarioFolderFiles.length; i++) {
                    $(outputFilesSelect).append('<option value="' + scenarioFolderFiles[i].FullPath + '">' + scenarioFolderFiles[i].OriginalPath + '</option>');
                }
                if (scenarioFolderFiles.length > 0) {
                    $(outputFilesSelect).val(scenarioFolderFiles[0].OriginalPath);
                    $(outputFilesSelect).prop('selectedIndex', 0);
                }
            })
        } else {
            var newrow = '<tr><td><select onchange="outputFilesSelected(event)" class="output-file-row" id="output-file-select-' + outputFileTableRows + '"></td></tr>';
            table.append(newrow);
        }
    }
    function clearScenarioTables() {
        var table = $("#scenarios-table");
    }
    function addNewOutputFilesTableRow() {
        if (!isSelectedScenarioModelLoaded()) {
            var createScenariorFolderFlag = !doesScenarioFolderExist();
            createScenarioFolder(createScenariorFolderFlag, false)
            .then(function(createScenarioFolderResponse) {
                // Copy user selected server model into scenario folder
                copyModelToScenarioFolder(createScenariorFolderFlag)
                .then(function(copyModelToScenarioFolderResponse) {
                    createOutputsFileTableRow();
                })
            })
        } else {
            createOutputsFileTableRow();
        }
    }
    function deleteOutputFilesTableRow(event) {
        if (outputFileTableRows > 0) {
            outputFileTableRows--;
        }
        $("#file-outputs-table tr:last").remove();
    }

    function addNewScenarioTableRow() {
        var table = $("#scenarios-table");
        scenariosTableRows++;
        var newrow = 
        // '<tr><td><input type="text" id="scenario-id-' + scenariosTableRows + '" value="' + $("#scenario-id").val() + '"></td><td><input type="text" id="scenario-name-' + scenariosTableRows + '" value="' + $("#scenario-name").val() + '"></input></td><td><input type="text" id="scenario-status-' + scenariosTableRows + '" value="' + $("#scenario-status").val() + '"></input></td><td><input type="text" id="scenario-folder-pathname-' + scenariosTableRows + '" value="' + $("#user-scenario-folder-pathname").val() + '"></input></td></tr>'
        '<tr id="id' + scenariosTableRows + '"><td class="table-checkboxes"><input "id="scenario-selection-' + scenariosTableRows + '" type="checkbox"></td><td nowrap id="scenario-id-' + scenariosTableRows + '">' + $("#scenario-id").val() + '</td><td nowrap id="scenario-name-' + scenariosTableRows + '">' + $("#scenario-name").val() + '</td><td nowrap id="scenario-status-' + scenariosTableRows + '">Submitted</td><td nowrap id="scenario-folder-pathname-' + scenariosTableRows + '">' + $("#user-scenario-folder-pathname").val() + '</td></tr>'
        table.append(newrow);

        $('#scenarios-table-body').width('90%');
        myCheckStatusInterval = setInterval(()=> {checkScenarioStatus($("#scenario-id").val(), scenariosTableRows, 3)}, 500);
    }

    function updateTargetTableSelect(event) {
        // var index = event.target.id.lastIndexOf('-') + 1;
        // var rowIndex = event.target.id.substring(index);
        var rowIndex = getRowIndexFromTableRowId(event.target.id);
        var targetDatabase = '#target-database-' + rowIndex;
        var matchindex = modelDatabases.findIndex(x => x.name === $(targetDatabase).val());
        if (matchindex >= 0) {
            var targetTable = '#target-table-' + rowIndex;
            // $(targetTable).empty();
            $(targetTable).find("tr:not(:first)").remove();
            for (var i = 0; i < modelDatabases[matchindex].tableNames.length; i++) {
                $(targetTable).append('<option value="' + modelDatabases[matchindex].tableNames[i] + '">' + modelDatabases[matchindex].tableNames[i] + '</option>');
            }
            if (modelDatabases[matchindex].tableNames.length > 0) {
                $(targetTable).val(modelDatabases[matchindex].tableNames[0]);
            }
        }     
    }

    function updateSourceTableSelect(event) {
        // var index = event.target.id.lastIndexOf('-') + 1;
        // var rowIndex = event.target.id.substring(index);
        var rowIndex = getRowIndexFromTableRowId(event.target.id);
        var sourceDatabase = '#source-database-' + rowIndex;
        var matchindex = modelDatabases.findIndex(x => x.name === $(sourceDatabase).val());
        if (matchindex >= 0) {
            var sourceTable = '#source-table-' + rowIndex;
            // $(sourceTable).empty();
            $(sourceTable).find("tr:not(:first)").remove();
            for (var i = 0; i < modelDatabases[matchindex].tableNames.length; i++) {
                $(sourceTable).append('<option value="' + modelDatabases[matchindex].tableNames[i] + '">' + modelDatabases[matchindex].tableNames[i] + '</option>');
            }
            if (modelDatabases[matchindex].tableNames.length > 0) {
                $(sourceTable).val(modelDatabases[matchindex].tableNames[0]);
            }
        }
    }

    function deleteDatabaseOutputsTableRow(event) {
        if (databaseOutputsTableRows > 0) {
            databaseOutputsTableRows--;
        }
        $("#database-outputs-table tr:last").remove();  
    }

    function openViewDatabaseTableContentsForm() {
        
    }
    function closeFileContentsModal() {
        $("#file-contents-modal").hide();
    }
    function closeDatabaseTableContentsModal() {
        $("#database-table-modal").hide();
    }
    function openFileContentsModal(event) {
        // var index = event.target.id.lastIndexOf('-') + 1;
        // var rowIndex = event.target.id.substring(index);
        var rowIndex = getRowIndexFromTableRowId(event.target.id);
        var outputFileSelect = $('#output-file-select-' + rowIndex);
        var filepath =  $(outputFileSelect).val();
        getServerFile(filepath)
        .then(function(response) {
            console.log(JSON.stringify(response.data.result));
            var fileData  = response.data.result;
            g_fileDataArray = fileData.split('\r\n').map(function(ln){
                return ln.split('\t');
            });
            // Remove last empty element from array
            g_fileDataArray.pop();

            $('#selected-file-name').val(filepath.substring(filepath.lastIndexOf("\\") + 1));
            displayFileContents();
            updateLoadingDivVisibility(false);
            $("#file-contents-modal").show();
        })
    }
    function getRowIndexFromTableRowId(tableRowId) {
        var index = tableRowId.lastIndexOf('-') + 1;
        var rowIndex = tableRowId.substring(index);
        return rowIndex;
    }
    function buildDatabaseTableContentsStreamModelInfo(tableRowId) {
        var rowIndex = getRowIndexFromTableRowId(tableRowId);
        var modelName =  $("#user-models").val();
        modelName = modelName.substring(modelName.lastIndexOf("\\") + 1);
        var modelpathname = $("#user-scenario-folder-pathname").val() + "\\" + modelName;
        var modelInfo = {
            Modelpathname: modelpathname,
            Databasename:  $("#source-database-" + rowIndex).val(),
            Tablename: $("#source-table-" + rowIndex).val()
        }
        return modelInfo;
    }
    function openDatabaseTableContentsModal(event) {
        var rowIndex = getRowIndexFromTableRowId(event.target.id);
        $('#modal-chart-axes-selection-dropdowns').hide();
        $('#view-model-chart-button').hide();
        $('#selected-response-table-name').val($("#source-table-" + rowIndex).val());
        updateLoadingDivVisibility(true);
        var modelInfo = buildDatabaseTableContentsStreamModelInfo(event.target.id);
        getDatabaseTableContentsStream(modelInfo, true)
        .then(function(response) {
            displayTableContents(response.data.modelDatabaseTableFields);
            updateLoadingDivVisibility(false);
            $("#database-table-modal").show();
            return(response);
        })
    }
    
    function openViewDatabaseTableChartModal(event) {
        // var index = event.target.id.lastIndexOf('-') + 1;
        // var rowIndex = event.target.id.substring(index);
        var rowIndex = getRowIndexFromTableRowId(event.target.id);
        var modelName =  $("#user-models").val();
        modelName = modelName.substring(modelName.lastIndexOf("\\") + 1);
        var modelpathname = $("#user-scenario-folder-pathname").val() + "\\" + modelName;
        var modelInfo = {
            Modelpathname: modelpathname,
            Databasename:  $("#source-database-" + rowIndex).val(),
            Tablename: $("#source-table-" + rowIndex).val()
        }
        $('#modal-chart-axes-selection-dropdowns').show();
        $('#view-model-chart-button').show();
        $('#selected-response-table-name').val($("#source-table-" + rowIndex).val());
        updateLoadingDivVisibility(true);
        // getDatabaseTableContentsStream(modelInfo, true, displayTableChartModal)
        getDatabaseTableContentsStream(modelInfo, true)
        .then(function(response) {
            console.log('Heading fields=' + JSON.stringify(response.data.modelDatabaseTableFields));
            g_tableSchema = response.data.modelDatabaseTableFields;
            makeChartDataSeries(g_tableDataArray, response.data.modelDatabaseTableFields, 'Step Name', 'Total Jobs Processed')
            .then(function(makeChartResponse) {
                console.log('char data=' + JSON.stringify(g_chartData));
                displayTableChartModal();
                updateLoadingDivVisibility(false);
                $("#database-table-modal").show();
                return(response);
            });
        })
    }

    function updateSourceBlockNumbersDropdown(rowIndex) {
        var blockType = '#source-block-type-select-' + rowIndex;
        var blockNumber = '#source-block-number-select-' + rowIndex;

        blockNumbers = [];
        var tempArray = [];
        for (var i=0;i<modelBlockInfo.length;i++) {
            if ($(blockType).val() === modelBlockInfo[i].blockName) {
                tempArray.push(modelBlockInfo[i].blockNumber);
            }
        }
        blockNumbers = Array.from(new Set(tempArray));
        blockNumbers.sort();
        $(blockNumber).empty();
        for (var i = 0; i < blockNumbers.length; i++) {
            $(blockNumber).append('<option value="' + blockNumbers[i] + '">' + blockNumbers[i] + '</option>');
        }
        updateSourceDialogVariableTypeDropdown(rowIndex);
    }

    function updateTargetBlockNumbersDropdown(rowIndex) {
        var blockType = '#target-block-type-select-' + rowIndex;
        var blockNumber = '#target-block-number-select-' + rowIndex;

        blockNumbers = [];
        var tempArray = [];
        for (var i=0;i<modelBlockInfo.length;i++) {
            if ($(blockType).val() === modelBlockInfo[i].blockName) {
                tempArray.push(modelBlockInfo[i].blockNumber);
            }
        }
        blockNumbers = Array.from(new Set(tempArray));
        blockNumbers.sort();
        $(blockNumber).empty();
        for (var i = 0; i < blockNumbers.length; i++) {
            $(blockNumber).append('<option value="' + blockNumbers[i] + '">' + blockNumbers[i] + '</option>');
        }
        updateTargetDialogVariableTypeDropdown(rowIndex);
    }

    function updateTargetDialogVariableTypeDropdown(rowIndex) {
        var blockNumber = '#target-block-number-select-' + rowIndex;
        var dialogVariableType = '#target-variable-type-select-' + rowIndex;
        dialogVariableTypes = [];
        var tempArray = [];
        for (var i=0;i<modelBlockInfo.length;i++) {
            if ($(blockNumber).val() === modelBlockInfo[i].blockNumber) {
                tempArray.push(modelBlockInfo[i].dialogVariableType);
            }
        }
        dialogVariableTypes = Array.from(new Set(tempArray));
        dialogVariableTypes.sort();
        $(dialogVariableType).empty();
        for (var i = 0; i < dialogVariableTypes.length; i++) {
            $(dialogVariableType).append('<option value="' + dialogVariableTypes[i] + '">' + dialogVariableTypes[i] + '</option>');
        }
        updateTargetDialogVariableDropdown(rowIndex);
    }

    function updateSourceDialogVariableTypeDropdown(rowIndex) {
        var blockNumber = '#source-block-number-select-' + rowIndex;
        var dialogVariableType = '#source-variable-type-select-' + rowIndex;
        dialogVariableTypes = [];
        var tempArray = [];
        for (var i=0;i<modelBlockInfo.length;i++) {
            if ($(blockNumber).val() === modelBlockInfo[i].blockNumber) {
                tempArray.push(modelBlockInfo[i].dialogVariableType);
            }
        }
        dialogVariableTypes = Array.from(new Set(tempArray));
        dialogVariableTypes.sort();
        $(dialogVariableType).empty();
        for (var i = 0; i < dialogVariableTypes.length; i++) {
            $(dialogVariableType).append('<option value="' + dialogVariableTypes[i] + '">' + dialogVariableTypes[i] + '</option>');
        }
        updateSourceDialogVariableDropdown(rowIndex);
    }

    function updateSourceDialogVariableDropdown(rowIndex) {
        var blockNumber = '#source-block-number-select-' + rowIndex;
        var dialogVariableType = '#source-variable-type-select-' + rowIndex;
        var dialogVariable = '#source-variable-name-select-' + rowIndex;
        dialogVariables = [];
        var tempArray = [];
        for (var i=0;i<modelBlockInfo.length;i++) {
            if (($(blockNumber).val() === modelBlockInfo[i].blockNumber) &&
                ($(dialogVariableType).val() === modelBlockInfo[i].dialogVariableType)) {
                tempArray.push(modelBlockInfo[i].variableName);
            }
        }
        dialogVariables = Array.from(new Set(tempArray));
        dialogVariables.sort();
        $(dialogVariable).empty();
        for (var i = 0; i < dialogVariables.length; i++) {
            $(dialogVariable).append('<option value="' + dialogVariables[i] + '">' + dialogVariables[i] + '</option>');
        }      
    }
    function updateTargetDialogVariableDropdown(rowIndex) {
        var blockNumber = '#target-block-number-select-' + rowIndex;
        var dialogVariableType = '#target-variable-type-select-' + rowIndex;
        var dialogVariable = '#target-variable-name-select-' + rowIndex;
        dialogVariables = [];
        var tempArray = [];
        for (var i=0;i<modelBlockInfo.length;i++) {
            if (($(blockNumber).val() === modelBlockInfo[i].blockNumber) &&
                ($(dialogVariableType).val() === modelBlockInfo[i].dialogVariableType)) {
                tempArray.push(modelBlockInfo[i].variableName);
            }
        }
        dialogVariables = Array.from(new Set(tempArray));
        dialogVariables.sort();
        $(dialogVariable).empty();
        for (var i = 0; i < dialogVariables.length; i++) {
            $(dialogVariable).append('<option value="' + dialogVariables[i] + '">' + dialogVariables[i] + '</option>');
        }      
    }

    function sourceBlockTypeSelected(event) {
        // var index = event.target.id.lastIndexOf('-') + 1;
        // var rowIndex = event.target.id.substring(index);
        var rowIndex = getRowIndexFromTableRowId(event.target.id);
        updateSourceBlockNumbersDropdown(rowIndex);
    }

    function targetBlockTypeSelected(event) {
        // var index = event.target.id.lastIndexOf('-') + 1;
        // var rowIndex = event.target.id.substring(index);
        var rowIndex = getRowIndexFromTableRowId(event.target.id);
        updateTargetBlockNumbersDropdown(rowIndex);
    }
    
    function sourceBlockNumberSelected(event) {
        // var index = event.target.id.lastIndexOf('-') + 1;
        // var rowIndex = event.target.id.substring(index);
        var rowIndex = getRowIndexFromTableRowId(event.target.id);
        updateSourceDialogVariableTypeDropdown(rowIndex);
    }

    function targetBlockNumberSelected(event) {
        // var index = event.target.id.lastIndexOf('-') + 1;
        // var rowIndex = event.target.id.substring(index);
        var rowIndex = getRowIndexFromTableRowId(event.target.id);
        updateTargetDialogVariableTypeDropdown(rowIndex);
    }

    function sourceDialogVariableTypeSelected(event) {
        // var index = event.target.id.lastIndexOf('-') + 1;
        // var rowIndex = event.target.id.substring(index);
        var rowIndex = getRowIndexFromTableRowId(event.target.id);
        updateSourceDialogVariableDropdown(rowIndex);  
    }
    function targetDialogVariableTypeSelected(event) {
        // var index = event.target.id.lastIndexOf('-') + 1;
        // var rowIndex = event.target.id.substring(index);
        var rowIndex = getRowIndexFromTableRowId(event.target.id);
        updateTargetDialogVariableDropdown(rowIndex);  
    }

    function targetDialogVariableSelected(event) {
    }
    function sourceDialogVariableSelected(event) {

    }
    function clearTableData() {
        // $("#file-inputs-table").empty();
        $("#file-inputs-table").find("tr:not(:first)").remove();
        $("#database-inputs-table").find("tr:not(:first)").remove();
        $("#dialog-inputs-table").find("tr:not(:first)").remove();
        $("#file-outputs-table").find("tr:not(:first)").remove();
        $("#database-outputs-table").find("tr:not(:first)").remove();
        $("#dialog-outputs-table").find("tr:not(:first)").remove(); 
    }

    function updateModelInfo(modelPathname, clearTableDataFlag) {
        return new Promise((resolve, reject) => {
            updateLoadingDivVisibility(true);
            if (clearTableDataFlag) {
                clearTableData();
            }
            getmodeldatabases(modelPathname, getModelInfo)
            .then(function(response) {
                loadedScenarioModelpathname = modelPathname;
                resolve(true);
            })
            .catch(function(error) {
                reject(error);
            })
        });
    }
    function removeScenarioFolder(scenarioFolderPathname) {
        return new Promise((resolve, reject) => {
            axios({
                url: proxyurl + queryURL_root + 'ExtendSim/removescenariofolder',
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data: {
                    scenarioFolderPathname: scenarioFolderPathname,
                }
            })
            .then(function(response) {
                resolve(true);
            });
        });
    }

    function checkScenarioStatus(scenarioID, rowIndex, colIndex) {
        axios({
            url: proxyurl + queryURL_root + 'ExtendSim/checkmodelrunstatus',
            method: 'post',
            accept : 'application/json',
            contentType: 'application/json;charset=utf-8',
            data: {
                scenarioID: scenarioID,
            }
        })
        .then(function(response) {
            if (response.data.modelRunStatus === c_Completed_status) {
                clearInterval(myCheckStatusInterval);
                $('#submit-scenarios-button').prop('disabled', false);
                $('#remove-selected-scenario-folders-button').prop('disabled', false);
                updateButtonsState();
            }
            var table = $("#scenarios-table");
            var statusValue = table.find('tr:eq(' + rowIndex + ') t' + (rowIndex == 0 ?  "h" : "d") + ':eq(' + colIndex + ')').text(); 
            table.find('tr:eq(' + rowIndex + ') t' + (rowIndex == 0 ?  "h" : "d") + ':eq(' + colIndex + ')').text(scenarioStatusValues[response.data.modelRunStatus - 1]); 
            $('#scenario-status').val(scenarioStatusValues[response.data.modelRunStatus - 1]);
        });
    }
    function getServerFile(filepath) {
        return new Promise((resolve, reject) => {
            axios({
                url: proxyurl + queryURL_root + 'ExtendSim/getfile',
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                // params: {
                data: {
                    filepath: filepath
                }
            })
            .then(function(response) {
                resolve(response);
            })
            .catch(function(error) {
                reject(error);
            })
        });   
    }
    function getScenarioFolderFiles() {
        return new Promise((resolve, reject) => {
            axios({
                url: proxyurl + queryURL_root + 'ExtendSim/getserverscenariofolderdirectory',
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                // params: {
                data: {
                    scenarioFolderPathname : $("#user-scenario-folder-pathname").val(),
                }
            })
            .then(function(response) {
                resolve(response);
            })
            .catch(function(error) {
                reject(error);
            })
        });
    }
    function createScenarioFolder(callServer, copyModelToFolder) {
        return new Promise((resolve, reject) => {
            if (callServer) {
            axios({
                url: proxyurl + queryURL_root + 'ExtendSim/createScenarioFolder',
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                // params: {
                data: {
                    userLoginSessionID : $("#user-login-session-id").val(),
                    scenarioFolderName : $("#scenario-name").val(),
                }
            })
            .then(function(response) {
                // Storing an array of results in the results variable
                $("#user-scenario-folder-pathname").val(response.data.scenarioFolderPathname);
                $('#create-scenario-folder-button').prop('disabled', true);
                $('#copy-model-to-scenario-folder').prop('disabled', false);
                if (copyModelToFolder) {
                    copyModelToScenarioFolder(callServer)
                    .then(function(copyModelToScenarioFolderResponse) {
                        resolve(true);
                    })
                }else {
                    resolve(true);
                }
            })
            .catch(function(error) {
                reject(error);
            })
        } else {
            resolve(true);
        }
        });
    }

    function copyModelToScenarioFolder(callServer) {
        return new Promise((resolve, reject) => {
            if (callServer) {
                axios({
                    url: proxyurl + queryURL_root + 'ExtendSim/copyModelToScenarioFolder',
                    method: 'post',
                    accept : 'application/json',
                    contentType: 'application/json;charset=utf-8',
                    // params: {
                    data: {
                        modelPathname: $("#user-models").val(),
                        scenarioFolderPathname: $("#user-scenario-folder-pathname").val(),
                        copyFolderContents: true
                    }
                })
                .then(function(response) {
                    // Storing an array of results in the results variable
                    $('#copy-model-to-scenario-folder').prop('disabled', true);
                    // updateButtonsState();
                    resolve(true);
                })
                .catch(function(error) {
                    reject(error);
                })  
            } else {
                resolve(true);           
            }
        });   
    }

    function sendFactorDataToServer() {
        uploadDataFilesToServer(0, uploadDataStreamsToModel, uploadDialogVariableDataToModel);
    }

    function downloadDialogVariableDataFromModel(rowIndex) {
        return new Promise((resolve, reject) => {
            if (dialogOutputsTableRows < 1) {
                // Exit since there is not data to push 
                resolve(true);
            } else {
                var modelName =  $("#user-models").val();
                modelName = modelName.substring(modelName.lastIndexOf("\\") + 1);
                var modelpathname = $("#user-scenario-folder-pathname").val() + "\\" + modelName;
                var variableName = $('#source-variable-name-select-' + (rowIndex + 1)).val();
                var variableValue = $('#source-variable-value-' + (rowIndex + 1)).val();
                var blockNumber = $('#source-block-number-select-' + (rowIndex + 1)).val();
                axios({
                    url: proxyurl + queryURL_root + "ExtendSim/getdialogvariabledata",
                    method: 'post',
                    accept : 'application/json',
                    contentType: 'application/json;charset=utf-8',
                    data : {
                        variableName: variableName,
                        blockNumber: blockNumber,
                        row: 0,
                        column: 0,
                        modelPathname: modelpathname
                    }
                })
                .then(function(response) {
                    // deposit result in dialog outputs table cell
                    $("#source-variable-value-" + (rowIndex + 1)).val(response.data.result);
                //  Advance to the next row
                    rowIndex++;
                    if (rowIndex < dialogOutputsTableRows) {
                        resolve(downloadDialogVariableDataFromModel(rowIndex));
                    } else {
                        // All dialog variable values pushed to server
                        resolve(true);
                    }
                });
            }
        });
    }

    function uploadDialogVariableDataToModel(rowIndex) {
        return new Promise((resolve, reject) => {
            if (dialogInputsTableRows < 1) {
                // Exit since there is not data to push 
                resolve(true);
            } else {
                var modelName =  $("#user-models").val();
                modelName = modelName.substring(modelName.lastIndexOf("\\") + 1);
                var modelpathname = $("#user-scenario-folder-pathname").val() + "\\" + modelName;
                var variableName = $('#target-variable-name-select-' + (rowIndex + 1)).val();
                var variableValue = $('#target-variable-value-' + (rowIndex + 1)).val();
                var blockNumber = $('#target-block-number-select-' + (rowIndex + 1)).val();
                axios({
                    url: proxyurl + queryURL_root + "ExtendSim/senddialogvariabledata",
                    method: 'post',
                    accept : 'application/json',
                    contentType: 'application/json;charset=utf-8',
                    data : {
                        variableName: variableName,
                        variableValue: variableValue,
                        blockNumber: blockNumber,
                        row: 0,
                        column: 0,
                        modelPathname: modelpathname
                    }
                })
                .then(function(response) {
                //  Advance to the next row
                    rowIndex++;
                    if (rowIndex < dialogInputsTableRows) {
                        resolve(uploadDialogVariableDataToModel(rowIndex));
                    } else {
                        // All dialog variable values pushed to server
                        resolve(true);
                    }
                });
            }
        });
    }
    function uploadDataStreamsToModel_new(rowIndex) {
        return new Promise((resolve, reject) => {
            if (g_ScenarioDefinition.uploadedDatabaseFiles.length < 1) {
                // Exit since there is not data to push 
                resolve(true);
            } else {
                var modelName =  g_ScenarioDefinition.modelName;
                modelName = modelName.substring(modelName.lastIndexOf("\\") + 1);
                var modelpathname = $("#user-scenario-folder-pathname").val() + "\\" + modelName;
                var databasename = g_ScenarioDefinition.factorDatabasenames[rowIndex];
                var tablename = g_ScenarioDefinition.factorTablenames[rowIndex];
                var dataContent = g_ScenarioDefinition.uploadedDatabaseFiles[rowIndex].data;
                axios({
                    url: proxyurl + queryURL_root + "ExtendSim/senddatastream",
                    method: 'post',
                    accept : 'application/json',
                    contentType: 'application/json;charset=utf-8',
                    data : {
                        modelPathname: modelpathname,
                        modelDatabaseName: databasename,
                        databaseTableName: tablename,
                        tabledata: dataContent
                    }
                })
                .then(function(response) {
                    rowIndex++;
                    if (rowIndex < g_ScenarioDefinition.uploadedDatabaseFiles.length) {
                        resolve(uploadDataStreamsToModel_new(rowIndex));
                    } else {
                        // All data streams have been sent to the user's models on the server
                        $("#database-inputs-uploaded-status").prop('checked', true);
                        resolve(true);
                    }
                });
            }
        });
    }
    function uploadDataStreamsToModel(rowIndex) {
        return new Promise((resolve, reject) => {
            if (databaseInputsTableRows < 1) {
                // Exit since there is not data to push 
                resolve(true);
            } else {
                var reader = new FileReader();
                var modelName =  $("#user-models").val();
                modelName = modelName.substring(modelName.lastIndexOf("\\") + 1);
                var modelpathname = $("#user-scenario-folder-pathname").val() + "\\" + modelName;
                var databasename = $('#target-database-' + (rowIndex + 1)).val();
                var tablename = $('#target-table-' + (rowIndex + 1)).val();
                reader.onload = function(event) {
                event.preventDefault();
                    axios({
                        url: proxyurl + queryURL_root + "ExtendSim/senddatastream",
                        method: 'post',
                        accept : 'application/json',
                        contentType: 'application/json;charset=utf-8',
                        data : {
                            modelPathname: modelpathname,
                            modelDatabaseName: databasename,
                            databaseTableName: tablename,
                            tabledata: reader.result
                        }
                    })
                    .then(function(response) {
                        rowIndex++;
                        if (rowIndex < databaseInputsTableRows) {
                            resolve(uploadDataStreamsToModel(rowIndex));
                        } else {
                            // All data streams have been sent to the user's models on the server
                            $("#database-inputs-uploaded-status").prop('checked', true);
                            resolve(true);
                        }
                    });
                }
                reader.readAsText(selectedDatabaseFiles[rowIndex]);
            }
        });
    }
    function uploadDataFilesToServer_new(fileIndex) {
        return new Promise((resolve, reject) => {
            if (g_ScenarioDefinition.uploadedFiles.length < 1) {
                // Exit since there are no files to copy
                resolve(true);
            } else {
                event.preventDefault();
                axios({
                    url: proxyurl + queryURL_root + "ExtendSim/sendfile",
                    method: 'post',
                    accept : 'application/json',
                    contentType: 'application/json;charset=utf-8',
                    data : {
                        scenarioFolderPathname: $("#user-scenario-folder-pathname").val(),
                        filename: g_ScenarioDefinition.uploadedFiles[fileIndex].name,
                        filedata: g_ScenarioDefinition.uploadedFiles[fileIndex].data
                    }
                })
                .then(function(response) {
                    fileIndex++;
                    if (fileIndex < g_ScenarioDefinition.uploadedFiles.length) {
                        resolve(uploadDataFilesToServer_new(fileIndex));
                    } else {
                        $("#files-uploaded-status").prop('checked', true);
                        resolve(true);
                        // Kick off next type of data push to the server model
                    }
                });
            }
        });
    }
    function uploadDataFilesToServer(fileIndex) {
        return new Promise((resolve, reject) => {
            if (inputFileTableRows < 1) {
                // Exit since there are no files to copy
                resolve(true);
            } else {
                var reader = new FileReader();

                reader.onload = function(event) {
                event.preventDefault();
                    axios({
                        url: proxyurl + queryURL_root + "ExtendSim/sendfile",
                        method: 'post',
                        accept : 'application/json',
                        contentType: 'application/json;charset=utf-8',
                        data : {
                            scenarioFolderPathname: $("#user-scenario-folder-pathname").val(),
                            filename: selectedFiles[fileIndex].name,
                            filedata: reader.result
                        }
                    })
                    .then(function(response) {
                        fileIndex++;
                        if (fileIndex < inputFileTableRows) {
                            resolve(uploadDataFilesToServer(fileIndex));
                        } else {
                            $("#files-uploaded-status").prop('checked', true);
                            resolve(true);
                            // Kick off next type of data push to the server model
                        }
                    });
                }
                reader.readAsText(selectedFiles[fileIndex]);
            }
        });
    }
    function submitSimulationScenario(event) {
        // Trigger the sequence of calls required to:
        //  1. create a scenario folder
        //  2. copy the user model and server files to the scenario folder
        //  3. Push factor data to the scenario folder and model
        //  4. Submit the scenario on the server

        // create the scenario folder
        var createScenariorFolderFlag;
        $('#submit-scenarios-button').prop('disabled', true);
        // Check to see if there is more than the heading in the scenarios table
        if ($('#scenarios-table tr').length > 1) {
            createScenariorFolderFlag = true;
        } else {
            createScenariorFolderFlag = !doesScenarioFolderExist();
        }
        createScenarioFolder(createScenariorFolderFlag)
        .then(function(createScenarioFolderResponse) {
            // Copy user selected server model into scenario folder
            copyModelToScenarioFolder(createScenariorFolderFlag)
            .then(function(copyModelToScenarioFolderResponse) {
                // uploadDataStreamsToModel(0)
                uploadDataStreamsToModel_new(0)
                .then(function(uploadDataStreamsToModelResponse) {
                    // uploadDataFilesToServer(0)
                    uploadDataFilesToServer_new(0)
                    .then(function(uploadDataFilesToServerResponse) {
                        uploadDialogVariableDataToModel(0)
                        .then(function(uploadDialogVariableDataToModelResponse) {
                                // // Trigger the submission of the scenario
                            var modelName =  $("#user-models").val();
                            modelName = modelName.substring(modelName.lastIndexOf("\\") + 1);
                            var modelPathname = $("#user-scenario-folder-pathname").val() + "\\" + modelName;
                            var userLoginSessionID = $("#user-login-session-id").val();
                            axios({
                                url: proxyurl + queryURL_root + 'ExtendSim/submitsimulationscenario',
                                method: 'post',
                                accept : 'application/json',
                                contentType: 'application/json;charset=utf-8',
                                data: {
                                    userLoginSessionID: userLoginSessionID,
                                    modelPathname: modelPathname,
                                    removeFolderOnCompletion: false
                                }
                            })
                            .then(function(response) {
                                $("#scenario-id").val(response.data.scenarioID);
                                addNewScenarioTableRow();
                                updateButtonsState();
                            });

                        })
                    });
                })
            })
            .catch(function(copyModelToScenarioFolderError) {
                alert('copyModelToScenarioFolder error=' + copyModelToScenarioFolderError);
            })
        })
        .catch(function(error1) {
            alert('createScenarioFolder error=' + error1);
        });

    }

    function getModelDatabaseTableFields(modelpathname, databasename, tablename) {  
        return new Promise((resolve, reject) => { 
            axios({
                url: proxyurl + queryURL_root + "ExtendSim/getmodeldatabasetablefields",
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data : {
                    modelpathname: modelpathname,
                    databasename: databasename,
                    tablename: tablename,
                    closeModel: true
                }
            })
            .then(function(response) {
                resolve(response);
            })
            .catch(function(error) {
                reject(error);
            })
        });
    }
    function getmodeldatabases(modelPathname, callback) {
        return new Promise((resolve, reject) => { 
            axios({
                url: proxyurl + queryURL_root + "ExtendSim/getmodeldatabases",
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data : {
                    modelPathname: modelPathname,
                    closeModel: true
                }
            })
            .then(function(response) {
                modelDatabases= [];
                for (var i=0;i<response.data.modelDatabases.length;i++) {
                    if (response.data.modelDatabases[i].charAt(0) !== "_") {
                        modelDatabases.push({ name: response.data.modelDatabases[i],
                                            tableNames: [] });
                    }
                }
                getDatabaseTables(0, callback, modelPathname)
                .then(function(getDatabaseTablesResponse) {
                    resolve(getDatabaseTablesResponse);
                });
            });
        });
    }

    function getDatabaseTables(databaseIndex, callback, modelpathname) {
        return new Promise((resolve, reject) => { 
            axios({
                url: proxyurl + queryURL_root + "ExtendSim/getmodeldatabasetables",
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data : {
                    modelPathname: modelpathname,
                    database: modelDatabases[databaseIndex].name,
                    closeModel: true
                }
            })
            .then(function(response) {
                modelDatabases[databaseIndex].tableNames = response.data.modelDatabaseTables;
                modelDatabases[databaseIndex].tableNames.sort();
                var dbIndex = databaseIndex + 1;
                if (dbIndex < modelDatabases.length) {
                    resolve(getDatabaseTables(dbIndex, callback, modelpathname));
                } else {
                    if (callback !== "") {
                        callback()
                        .then(function(callbackResponse) {
                            resolve(response);
                        });
                    } else {
                        resolve(response);
                    }
                }
            })
            .catch(function(error) {
                reject(error);
            })
        });
    }

    function getUserModelPaths() {
        return new Promise((resolve, reject) => { 
            clearTableData();
            $("#get-user-models-button").prop('disabled', true);
            updateLoadingDivVisibility(true);
            axios({
                url: proxyurl + queryURL_root + 'ExtendSim/getUserModelPaths',
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data: {
                    username : $("#username").val(),
                }
            })
            .then(function(response) {
                var userModelPaths = response.data.userModelPaths;
                $('#user-models').empty(0);
                for (var i = 0; i < userModelPaths.length; i++) {
                    $('#user-models').append('<option value="' + userModelPaths[i] + '">' + userModelPaths[i].substring(userModelPaths[i].lastIndexOf("\\") + 1) + '</option>');
                }
                if (userModelPaths.length > 0) {
                    $('#user-models').val(userModelPaths[0]);
                }
                this.enableDisableCopyModelToScenarioFolderButton();
                this.updateButtonsState();
                updateLoadingDivVisibility(false);
                resolve(response);
                // getmodeldatabases( $('#user-models').val(), getModelInfo)
                // .then(function(response) {
                //     resolve(response);
                // })
                // .catch(function(error) {
                //     reject(error);
                // })
            });
        });
    }

    function getModelInfo() {
        return new Promise((resolve, reject) => { 
            axios({
                url: proxyurl + queryURL_root + "ExtendSim/getmodelinfo",
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data : {
                    modelpathname: $("#user-models").val(),
                    closeModel: true
                }
            })
            .then(function(response) {
                var modelInfo = {
                    Modelpathname: $("#user-models").val(),
                    Databasename: response.data.ModelInfo.Databasename,
                    Tablename: response.data.ModelInfo.Tablename
                }
                console.log("ModelInfo: " + JSON.stringify(modelInfo));
                getDatabaseTableContentsStream(modelInfo, false)
                .then(function(getDatabaseTableContentsStreamResponse) {
                    resolve(getDatabaseTableContentsStreamResponse);
                })
                .catch(function(getDatabaseTableContentsStreamError) {
                    reject(getDatabaseTableContentsStreamError);
                })
            })
            .catch(function(error) {
                reject(error);
            })
        });
    }
    function sendDataStreamToDatabaseTable(modelInfo, callback) {
        axios({
            url: proxyurl + queryURL_root + "ExtendSim/senddatastream",
            method: 'post',
            accept : 'application/json',
            contentType: 'application/json;charset=utf-8',
            data : {
                modelPathname: modelInfo.Modelpathname, 
                modelDatabaseName: modelInfo.Databasename,
                databaseTableName: modelInfo.Tablename
            }
        })
        .then(function(response) {
        });
    }
    function getDatabaseTableContentsStream(modelInfo, getFieldInfo) {
        return new Promise((resolve, reject) => { 
            axios({
                url: proxyurl + queryURL_root + "ExtendSim/getdatabasetablecontentsstream",
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data : {
                    modelPathname: modelInfo.Modelpathname, 
                    databaseName: modelInfo.Databasename,
                    tableName: modelInfo.Tablename
                }
            })
            .then(function(response) {
                if (modelInfo.Tablename === 'ModelDialogVariables') {
                    modelBlockInfo = [];
                    response.data.tableDataArray.forEach(function(elements, index) {
                        modelBlockInfo.push(
                        {
                            variableName: elements[0],
                            dialogVariableType: elements[1],
                            blockName: elements[2],
                            blockNumber: elements[3],
                            tabname: elements[4],
                            blockLabel: elements[5],
                            enclosingHblockNumber: elements[6],
                            enclosingHblockLabel: elements[7],  
                        });
                    })
                    modelBlocks = [];
                    var tempArray = [];
                    for (var i=0;i<modelBlockInfo.length;i++) {
                        tempArray.push(modelBlockInfo[i].blockName);
                    }
                    modelBlocks = Array.from(new Set(tempArray));
                    modelBlocks.sort();
                    updateLoadingDivVisibility(false);
                    resolve(response);
                } else {
                    // save results globally
                    g_tableDataArray = response.data.tableDataArray;
                    getModelDatabaseTableFields(modelInfo.Modelpathname, modelInfo.Databasename, modelInfo.Tablename)
                    .then(function(getModelDatabaseTableFieldsResponse) {
                        resolve(getModelDatabaseTableFieldsResponse);
                    })
                    .catch(function(error) {
                        reject(error);
                    })
                }
            });  
        });     
    }
    function loginToServer() {
        axios({
            url: proxyurl + queryURL_root + 'users/login',
            method: 'post',
            accept : 'application/json',
            contentType: 'application/json;charset=utf-8',
            data : {
                username:  $("#username").val(),
                password: $("#password").val()
            }
        })
        .then(function(response) {
            // Storing an array of results in the results variable
            getUserModelPaths()
            .then(function(getUserModelPathsResponse) {
                $("#user-login-session-id").val(response.data.userLoginSessionID);
                $('.user-login-buttons').prop('disabled', false);
                $('.scenario-definition-checkboxes').prop('disabled', false);
                $('.scenario-setup-checkbox').prop('disabled', false);
            });
        });
    }
    enableDisableUploadFilesButton();

    // Event listener for all button elements
    $("button").on("click", function() {
      // In this case, the "this" keyword refers to the button that was clicked
      switch (this.id) {
        case 'users/login':

            axios({
                url: proxyurl + queryURL_root + this.id,
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data : {
                    username:  $("#username").val(),
                    password: $("#password").val()
                }
            })
            .then(function(response) {
                // Storing an array of results in the results variable
                $("#user-login-session-id").val(response.data.userLoginSessionID);
                $('.user-login-buttons').prop('disabled', false);
            });
          break;

        case 'ExtendSim/createScenarioFolder':

            axios({
                url: proxyurl + queryURL_root + this.id,
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                // params: {
                data: {
                    userLoginSessionID : $("#user-login-session-id").val(),
                    scenarioFolderName : $("#scenario-name").val(),
                }
            })
            .then(function(response) {
                // Storing an array of results in the results variable
                $("#user-scenario-folder-pathname").val(response.data.scenarioFolderPathname);
            });
            break;

        case 'ExtendSim/copyModelToScenarioFolder':

            axios({
                url: proxyurl + queryURL_root + this.id,
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data: {
                    modelPathname: $("#user-models").val(),
                    scenarioFolderPathname: $("#user-scenario-folder-pathname").val(),
                    copyFolderContents: true
                }
            })
            .then(function(response) {
                $("#model-copied-status").prop('checked', true);
                $("#model-copied-status").prop('disabled', true);
            });
            break;

        case 'ExtendSim/submitsimulationscenario':

            var modelName =  $("#user-models").val();
            modelName = modelName.substring(modelName.lastIndexOf("\\") + 1);
            axios({
                url: proxyurl + queryURL_root + this.id,
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data: {
                    userLoginSessionID: $("#user-login-session-id").val(),
                    modelPathname:  $("#user-scenario-folder-pathname").val() + "\\" + modelName,
                    removeFolderOnCompletion: false
                }
            })
            .then(function(response) {
                $("#scenario-id").val(response.data.scenarioID);
            });
            break;

        case 'ExtendSim/checkmodelrunstatus':
        
            axios({
                url: proxyurl + queryURL_root + this.id,
                method: 'post',
                accept : 'application/json',
                contentType: 'application/json;charset=utf-8',
                data: {
                    scenarioID: $("#scenario-id").val(),
                }
            })
            .then(function(response) {
                $("#scenario-status").val(scenarioStatusValues[response.data.modelRunStatus - 1]);
            });
           break;
      }
    });

    $('.login').keyup(function () {
        validateUserInputs();
    });
    $('#scenario-name').keyup(function () {
        updateButtonsState();
    });
    // $(document).on("click", "#scenarios-table td", function() {
    $(document).on("click", "#scenarios-table tr", function() {
        console.log(JSON.stringify($(this).data()));
        // $("#user-scenario-folder-pathname").val() 
        // this.find('tr:eq(' + rowIndex + ') t' + (rowIndex == 0 ?  "h" : "d") + ':eq(' + colIndex + ')').text(scenarioStatusValues[response.data.modelRunStatus - 1]); 
        var folder = $(this).closest('tr').find('td:eq(4)').text();
        if (folder !== $("#user-scenario-folder-pathname").val()) {
        //  User has selected a scenario that is not currently loaded
            clearTableData();
        }
        $("#user-scenario-folder-pathname").val(folder);
                
    });
</script>
</body>

</html>
